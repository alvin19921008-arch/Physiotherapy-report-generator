<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physiotherapy Report Generator - Complete Lite App (Full App Compatible)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8fafc;
            font-size: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border-radius: 12px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 14px 24px;
            background-color: #e5e7eb;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s;
        }

        .nav-tab.active {
            background-color: #3b82f6;
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background-color: #d1d5db;
        }

        .section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.8rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .section h3 {
            color: #374151;
            margin: 20px 0 15px 0;
            font-size: 1.4rem;
        }

        .section h4 {
            color: #4b5563;
            margin: 15px 0 10px 0;
            font-size: 1.2rem;
        }

        .section h5 {
            color: #4b5563;
            margin: 12px 0 8px 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .section h6 {
            color: #6b7280;
            margin: 10px 0 6px 0;
            font-size: 1rem;
            font-weight: 600;
        }

        /* Table and tabular form styling */
        table {
            font-size: 16px;
        }
        
        th, td {
            font-size: 16px;
            padding: 10px;
        }
        
        /* Ensure all text elements have readable font sizes */
        .small-text, small {
            font-size: 14px !important;
        }
        
        /* Specific styling for referral text and finger/toe labels */
        .referral-label, .finger-toe-label {
            font-size: 16px !important;
            font-weight: 500 !important;
        }
        
        /* Assessment row labels */
        .assessment-row label {
            font-size: 16px !important;
            font-weight: 500 !important;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
            font-size: 16px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: #374151;
            line-height: 1.5 !important;
            height: auto !important;
            min-height: 44px !important;
            vertical-align: top !important;
            box-sizing: border-box !important;
        }

        .form-control::placeholder {
            color: #9ca3af !important;
            font-size: 16px !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
            line-height: 1.5 !important;
            vertical-align: top !important;
            opacity: 1 !important;
            position: relative !important;
            top: 0 !important;
            transform: none !important;
        }

        /* Additional placeholder text fixes for corporate environments */
        input.form-control::placeholder,
        textarea.form-control::placeholder,
        select.form-control::placeholder {
            color: #9ca3af !important;
            font-size: 16px !important;
            line-height: 1.5 !important;
            vertical-align: baseline !important;
            text-align: left !important;
            padding: 0 !important;
            margin: 0 !important;
            position: static !important;
            transform: translateY(0) !important;
            display: inline !important;
            overflow: visible !important;
            white-space: nowrap !important;
            text-overflow: ellipsis !important;
        }

        /* Force proper input field dimensions */
        input.form-control,
        textarea.form-control,
        select.form-control {
            display: block !important;
            width: 100% !important;
            min-height: 44px !important;
            line-height: 1.5 !important;
            vertical-align: top !important;
            text-align: left !important;
            overflow: visible !important;
        }

        /* Corporate environment compatibility */
        .form-control {
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            background-clip: padding-box !important;
            background-color: #ffffff !important;
        }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Copy Button Styling - Distinct from Navigation */
        .btn-copy {
            background-color: #059669;
            color: white;
            border: 2px solid #047857;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-copy:hover {
            background-color: #047857;
            border-color: #065f46;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-copy:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Copy icon using CSS */
        .copy-icon {
            width: 14px;
            height: 14px;
            display: inline-block;
            position: relative;
        }

        .copy-icon::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border: 1.5px solid currentColor;
            border-radius: 2px;
            top: 0;
            left: 2px;
        }

        .copy-icon::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border: 1.5px solid currentColor;
            border-radius: 2px;
            top: 2px;
            left: 0;
            background-color: #059669;
        }

        .btn-copy:hover .copy-icon::after {
            background-color: #047857;
        }

        .clinical-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .clinical-tab {
            padding: 12px 24px;
            background-color: #f3f4f6;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #374151;
        }

        .clinical-tab.active {
            background-color: #3b82f6;
            color: white;
        }

        .clinical-content {
            display: none;
        }

        .clinical-content.active {
            display: block;
        }

        .assessment-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 6px;
        }

        .assessment-row label {
            min-width: 150px;
            margin-bottom: 0;
            font-weight: 500;
        }

        .assessment-row input,
        .assessment-row select {
            flex: 1;
            margin-bottom: 0;
        }

        .smart-fill-container {
            background-color: #f0f9ff;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .smart-fill-container p {
            margin-bottom: 10px;
            font-size: 14px;
            color: #374151;
        }

        .dynamic-field-container {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .radio-group input[type="radio"] {
            width: auto;
            margin-right: 5px;
        }

        .export-section {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .developer-tools-section {
            background: #f0fdf4;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border: 2px solid #bbf7d0;
        }

        .developer-tools-section h3 {
            color: #166534;
            margin-bottom: 15px;
        }

        .developer-tools-section p {
            color: #15803d;
            margin-bottom: 15px;
        }

        .mock-data-options {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #ecfdf5;
            border-radius: 6px;
            border: 1px solid #d1fae5;
        }

        .mock-data-options h5 {
            color: #166534;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .mock-data-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .mock-data-btn {
            background: #16a34a;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .mock-data-btn:hover {
            background: #15803d;
        }

        .mock-data-btn:active {
            background: #166534;
        }

        .export-output {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 14px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }

        .hidden {
            display: none !important;
        }

        .activity-item {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f9fafb;
        }

        .quick-nav {
            background-color: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .quick-nav h5 {
            margin-bottom: 10px;
            color: #1e40af;
        }

        .quick-nav-buttons {
            display: flex;
            gap: 10px;
        }

        .collapsible-header {
            background-color: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
        }

        .collapsible-header:hover {
            background-color: #e5e7eb;
        }

        .collapsible-content {
            display: block;
            transition: all 0.3s ease;
        }

        .collapsible-content.collapsed {
            display: none;
        }

        .collapse-icon {
            font-size: 18px;
            font-weight: bold;
            color: #6b7280;
        }

        .small-joint-checkbox {
            display: inline-block;
            margin: 5px 10px 5px 0;
        }

        .small-joint-checkbox input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        .small-joint-field {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .treatment-category {
            margin-bottom: 25px;
        }

        .treatment-category h4 {
            color: #1d4ed8;
            border-bottom: 1px solid #bfdbfe;
            padding-bottom: 5px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .treatment-option {
            margin-bottom: 8px;
        }

        .treatment-option label {
            font-size: 14px;
            font-weight: normal;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .treatment-option input[type="checkbox"] {
            margin-right: 8px;
            width: auto;
        }

        /* Improved font sizes for Section 6 */
        .form-group h5 {
            font-size: 16px !important;
            font-weight: 600 !important;
            color: #374151 !important;
            margin-bottom: 10px !important;
        }

        .form-group label {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: #374151 !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .assessment-row {
                flex-direction: column;
                align-items: stretch;
            }

            .assessment-row label {
                min-width: auto;
            }

            .quick-nav-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Physiotherapy Report Generator - Complete Lite App</h1>
            <div class="subtitle">Full App Compatible | Complete Clinical Assessment | Corporate Portal Ready</div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection(1)">Section 1: Reference</button>
            <button class="nav-tab" onclick="showSection(2)">Section 2: Patient Info</button>
            <button class="nav-tab" onclick="showSection(3)">Section 3: Diagnosis</button>
            <button class="nav-tab" onclick="showSection(4)">Section 4: Referral</button>
            <button class="nav-tab" onclick="showSection(5)">Section 5: Duration</button>
            <button class="nav-tab" onclick="showSection(6)">Section 6: Clinical</button>
            <button class="nav-tab" onclick="showSection(7)">Section 7: Treatment</button>
            <button class="nav-tab" onclick="showSection(8)">Section 8: Discharge</button>
            <button class="nav-tab" onclick="showSection(9)">Section 9: Declaration</button>
        </div>

        <!-- Section 1: Reference Information -->
        <div class="section active" id="section1">
            <h2>Section 1: Medical Report Reference Information</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Our Reference</label>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span>(</span>
                        <input type="text" class="form-control" id="ourRef" onchange="updateField('ourRef', this.value)" style="flex: 1;">
                        <span>) in PHY/OA/</span>
                        <input type="text" class="form-control" id="ourRef2" onchange="updateField('ourRef2', this.value)" style="flex: 1;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Your Reference</label>
                    <input type="text" class="form-control" id="yourRef" onchange="updateField('yourRef', this.value)">
                </div>
                <div class="form-group">
                    <label>Report Date</label>
                    <input type="date" class="form-control" id="reportDate" onchange="updateField('reportDate', this.value)">
                </div>
                <div class="form-group">
                    <label>Your Reference Date</label>
                    <input type="date" class="form-control" id="yourRefDate" onchange="updateField('yourRefDate', this.value)">
                </div>
                <div class="form-group">
                    <label>Recipient</label>
                    <input type="text" class="form-control" id="recipient" onchange="updateField('recipient', this.value)">
                </div>
            </div>
        </div>

        <!-- Section 2: Patient Information -->
        <div class="section" id="section2">
            <h2>Section 2: Patient Information</h2>
            <div class="form-group">
                <label>Name of Patient:</label>
                <input type="text" class="form-control" id="patientName" onchange="updateField('patientName', this.value)" placeholder="e.g., CHAN Tai Man, input CHAN, T. M.">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Sex</label>
                    <select class="form-control" id="patientSex" onchange="updateField('patientSex', this.value)">
                        <option value="">Select sex</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Age</label>
                    <input type="number" class="form-control" id="patientAge" onchange="updateField('patientAge', this.value)">
                </div>
                <div class="form-group">
                    <label>HKID No.</label>
                    <input type="text" class="form-control" id="hkidNo" onchange="updateField('hkidNo', this.value)">
                    <small style="color: #6b7280; font-size: 14px; margin-top: 5px; display: block;">Advised to write a dummy ID number for data export purpose.</small>
                </div>
                <div class="form-group">
                    <label>Physiotherapy OPD No.</label>
                    <input type="text" class="form-control" id="physiotherapyOpdNo" onchange="updateField('physiotherapyOpdNo', this.value)">
                </div>
            </div>
        </div>

        <!-- Section 3: Diagnosis -->
        <div class="section" id="section3">
            <h2>Section 3: Diagnosis</h2>
            <div class="form-group">
                <label>Diagnosis:</label>
                <textarea class="form-control" id="diagnosis" onchange="updateField('diagnosis', this.value)" placeholder="eg, low back pain / right shoulder fracture"></textarea>
            </div>
        </div>

        <!-- Section 4: Source of Referral -->
        <div class="section" id="section4">
            <h2>Section 4: Source of Referral</h2>
            <div class="form-group">
                <div style="margin-bottom: 15px; padding: 12px; background-color: #f3f4f6; border-radius: 6px; font-size: 15px; color: #6b7280;">
                    eg Department of Orthopedics and Traumatology, Tuen Mun Hospital or<br/>
                    Wu Hong Clinic, the Hospital Authority
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <label style="font-weight: 600;">Referral Sources</label>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addReferralSource()">Add Referral</button>
                </div>
                <div id="referralSourcesContainer"></div>
            </div>
        </div>

        <!-- Section 5: Duration of Treatment -->
        <div class="section" id="section5">
            <h2>Section 5: Duration of Treatment</h2>
            <div class="form-group">
                <label>Total Number of Sessions</label>
                <input type="number" class="form-control" id="totalSessions" onchange="updateField('totalSessions', this.value)">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Date of Registration</label>
                    <input type="date" class="form-control" id="registrationDate" onchange="updateField('registrationDate', this.value)">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" class="form-control" id="startDate" onchange="updateField('startDate', this.value)">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" class="form-control" id="endDate" onchange="updateField('endDate', this.value)">
                </div>
                <div class="form-group">
                    <label>Case Therapist(s)</label>
                    <input type="text" class="form-control" id="caseTherapists" onchange="updateField('caseTherapists', this.value)">
                </div>
                <div class="form-group">
                    <label>Report Written by</label>
                    <input type="text" class="form-control" id="reportWrittenBy" onchange="updateField('reportWrittenBy', this.value)">
                </div>
                <div class="form-group">
                    <label>Attended Sessions</label>
                    <input type="number" class="form-control" id="attendedSessions" onchange="updateField('attendedSessions', this.value)">
                </div>
                <div class="form-group">
                    <label>Defaulted Sessions</label>
                    <input type="number" class="form-control" id="defaultedSessions" onchange="updateField('defaultedSessions', this.value)">
                </div>
            </div>
        </div>

        <!-- Section 6: Clinical Information -->
        <div class="section" id="section6">
            <h2>Section 6: Clinical Information</h2>
            

            <!-- Clinical Tabs -->
            <div class="clinical-tabs">
                <button class="clinical-tab active" onclick="showClinicalTab('initial')">Initial Findings</button>
                <button class="clinical-tab" id="interimTab" onclick="showClinicalTab('interim')" style="display: none;">Interim Findings</button>
                <button class="clinical-tab" onclick="showClinicalTab('final')">Final Findings</button>
            </div>
            
            <!-- Interim Enable Checkbox -->
            <div style="margin-bottom: 20px; padding: 15px; background-color: #f0f9ff; border-radius: 8px;">
                <div class="checkbox-group">
                    <input type="checkbox" id="enableInterim" onchange="toggleInterimSection(this.checked)">
                    <label for="enableInterim" style="font-weight: 500;">Include Interim Findings</label>
                </div>
            </div>

            <!-- Initial Clinical Content -->
            <div class="clinical-content active" id="initialClinical">
                <h3>Initial Clinical Findings</h3>
                <div class="form-group">
                    <label>Date:</label>
                    <input type="date" class="form-control" id="initialDate" onchange="updateNestedField('initialFindings.date', this.value)">
                </div>
                
                <h4 id="initialComplaints">I. Patient's Complaints</h4>
                <div class="grid-2">
                    <div class="form-group" id="initialSideContainer">
                        <label>Side:</label>
                        <select class="form-control" id="initialComplaintsSide" onchange="updateComplaintsSide('initial', this.value)">
                            <option value="">Select Side</option>
                            <option value="right">Right</option>
                            <option value="left">Left</option>
                            <option value="bilateral">Bilateral</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location:</label>
                        <select class="form-control" id="initialPainRegion" onchange="updatePainRegion('initial', this.value)">
                            <option value="">Select Location</option>
                            <option value="back">Back</option>
                            <option value="neck">Neck</option>
                            <option value="shoulder">Shoulder</option>
                            <option value="elbow">Elbow</option>
                            <option value="wrist">Wrist</option>
                            <option value="hand">Hand</option>
                            <option value="hip">Hip</option>
                            <option value="knee">Knee</option>
                            <option value="ankle">Ankle</option>
                            <option value="foot">Foot</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pain Intensity (NPRS):</label>
                        <input type="text" class="form-control" id="initialPainIntensity" onchange="updateNestedField('initialFindings.complaints.painIntensity', this.value)" placeholder="e.g., 7 or 6-8">
                    </div>
                </div>
                
                <!-- Other Symptoms (Expandable Paired Fields) -->
                <div class="dynamic-field-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h5>Other Symptoms</h5>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addOtherSymptom('initial')">Add Other Symptom</button>
                    </div>
                    <div id="initialOtherSymptomsContainer"></div>
                </div>

                <!-- Functional Activities -->
                <div class="form-group">
                    <h4>Functional Activity</h4>
                    
                    <!-- Activity 1: Sitting/Reading -->
                    <div class="dynamic-field-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5>Activity: Sitting/Reading</h5>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addActivity1('initial')">Add Activity</button>
                        </div>
                        <div id="initialActivities1Container"></div>
                    </div>
                    
                    <!-- Activity 2: Walking/Standing -->
                    <div class="dynamic-field-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5>Activity: Walking/Standing</h5>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addActivity2('initial')">Add Activity</button>
                        </div>
                        <div id="initialActivities2Container"></div>
                    </div>
                    
                    <!-- Other Functional Limitation -->
                    <div class="form-group">
                        <label>Other Functional Limitation:</label>
                        <textarea class="form-control" id="initialOtherFunctionalLimitation" onchange="updateNestedField('initialFindings.complaints.otherFunctionalLimitation', this.value)" placeholder="e.g., His walking tolerance improved from 5 minutes to 15 minutes. He can now climb stairs without assistance." rows="3"></textarea>
                        <small style="color: #6b7280; font-size: 14px; margin-top: 5px; display: block;">Please write in complete sentence.</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Overall Subjective Improvement (NGRCS):</label>
                    <select class="form-control" id="initialImprovement" onchange="updateNestedField('initialFindings.complaints.overallImprovement', this.value)">
                        <option value="">Select Improvement</option>
                        <option value="0">0 out of 10</option>
                        <option value="1">1 out of 10</option>
                        <option value="2">2 out of 10</option>
                        <option value="3">3 out of 10</option>
                        <option value="4">4 out of 10</option>
                        <option value="5">5 out of 10</option>
                        <option value="6">6 out of 10</option>
                        <option value="7">7 out of 10</option>
                        <option value="8">8 out of 10</option>
                        <option value="9">9 out of 10</option>
                        <option value="10">10 out of 10</option>
                    </select>
                </div>
                
                <h4>II. Objective Findings</h4>
                
                <!-- Dynamic Clinical Assessment Fields Container -->
                <div id="initialObjectiveContainer">
                    <!-- AROM Fields -->
                    <div class="dynamic-field-container" id="initialAromContainer">
                        <div class="checkbox-group">
                            <input type="checkbox" id="initialAromNotTested" onchange="toggleNotTested('initial', 'arom', this.checked)">
                            <label for="initialAromNotTested">Active Range of Movement (AROM): Not tested</label>
                        </div>
                        <div id="initialAromFields"></div>
                    </div>

                    <!-- Fingers/Toes Fields (for hand/foot) -->
                    <div class="dynamic-field-container" id="initialFingersToesContainer" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5>Fingers/Toes</h5>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addFingerToe('initial')">Add Finger/Toe</button>
                        </div>
                        <div id="initialFingersToesFields"></div>
                    </div>

                    <!-- Toes ROM (for ankle) -->
                    <div class="dynamic-field-container" id="initialToesRomContainer" style="display: none;">
                        <div class="form-group">
                            <label>Toes ROM:</label>
                            <input type="text" class="form-control" onchange="updateNestedField('initialFindings.objectiveFindings.toesROM', this.value)" placeholder="e.g., 2/3 of full range">
                        </div>
                    </div>

                    <!-- Gross Fingers ROM (for wrist) -->
                    <div class="dynamic-field-container" id="initialGrossFingersRomContainer" style="display: none;">
                        <div class="form-group">
                            <label>Gross fingers AROM:</label>
                            <input type="text" class="form-control" onchange="updateNestedField('initialFindings.objectiveFindings.grossFingersROM', this.value)" placeholder="e.g., 2/3 of full range">
                        </div>
                    </div>
                    <!-- Muscle Power Fields -->
                    <div class="dynamic-field-container" id="initialMusclePowerContainer">
                        <div class="checkbox-group">
                            <input type="checkbox" id="initialMusclePowerNotTested" onchange="toggleNotTested('initial', 'musclePower', this.checked)">
                            <label for="initialMusclePowerNotTested">Muscle Power: Not tested</label>
                        </div>
                        
                        <div class="smart-fill-container">
                            <p>Smart Auto-fill: Select a grade to apply to all muscle groups, then modify individual groups as needed.</p>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="initialMusclePowerSmartFill">
                                    <option value="">Select Grade</option>
                                    <option value="0">0/5</option>
                                    <option value="1">1/5</option>
                                    <option value="2">2/5</option>
                                    <option value="3">3/5</option>
                                    <option value="4">4/5</option>
                                    <option value="5">5/5</option>
                                </select>
                                <button type="button" class="btn btn-secondary btn-small" onclick="smartFillMusclePower('initial')">Auto-fill all groups</button>
                                <button type="button" class="btn btn-secondary btn-small" onclick="clearAllMusclePower('initial')">Clear All</button>
                            </div>
                        </div>
                        <div id="initialMusclePowerFields"></div>
                    </div>

                    <!-- Hand Grip Strength Fields -->
                    <div class="dynamic-field-container" id="initialHandGripContainer" style="display: none;">
                        <h5>Hand Grip Strength</h5>
                        <div id="initialHandGripFields"></div>
                    </div>

                    <!-- Myotome Fields -->
                    <div class="dynamic-field-container" id="initialMyotomeContainer" style="display: none;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="initialMyotomeNotTested" onchange="toggleNotTested('initial', 'myotome', this.checked)">
                            <label for="initialMyotomeNotTested">Myotome: Not tested</label>
                        </div>
                        
                        <div class="smart-fill-container">
                            <p>Smart Auto-fill: Select a grade to apply to all levels (both left and right), then modify individual levels as needed.</p>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="initialMyotomeSmartFill">
                                    <option value="">Select Grade</option>
                                    <option value="0">0/5</option>
                                    <option value="1">1/5</option>
                                    <option value="2">2/5</option>
                                    <option value="3">3/5</option>
                                    <option value="4">4/5</option>
                                    <option value="5">5/5</option>
                                </select>
                                <button type="button" class="btn btn-secondary btn-small" onclick="smartFillMyotome('initial')">Auto-fill all levels</button>
                                <button type="button" class="btn btn-secondary btn-small" onclick="clearAllMyotome('initial')">Clear All</button>
                            </div>
                        </div>
                        <div id="initialMyotomeFields"></div>
                    </div>

                    <!-- Additional Objective Findings -->
                    <div class="dynamic-field-container">
                        <h4>Additional Findings</h4>
                        
                        <!-- Splint/Brace/Cast -->
                        <div class="checkbox-group">
                            <input type="checkbox" id="initialSplintBraceCast" onchange="toggleAdditionalField('initial', 'splintBraceCast', this.checked)">
                            <label for="initialSplintBraceCast">Include splint/brace/cast?</label>
                        </div>
                        <div id="initialSplintBraceCastFields" class="hidden">
                            <div class="form-group">
                                <label>Which kind of splint/brace/cast?</label>
                                <input type="text" class="form-control" onchange="updateNestedField('initialFindings.objectiveFindings.splintBraceCastType', this.value)" placeholder="e.g., hinged knee brace, short leg cast, dynamic extension splint">
                            </div>
                        </div>

                        <!-- Tenderness -->
                        <div class="checkbox-group">
                            <input type="checkbox" id="initialTenderness" onchange="toggleAdditionalField('initial', 'tenderness', this.checked)">
                            <label for="initialTenderness">Include tenderness finding</label>
                        </div>
                        <div id="initialTendernessFields" class="hidden">
                            <div class="form-group">
                                <label>Tenderness Area:</label>
                                <input type="text" class="form-control auto-lowercase-first-word" onchange="updateNestedFieldWithNormalization('initialFindings.objectiveFindings.tendernessArea', this.value)" placeholder="e.g., lateral epicondyle">
                            </div>
                        </div>

                        <!-- Swelling -->
                        <div class="checkbox-group">
                            <input type="checkbox" id="initialSwelling" onchange="toggleAdditionalField('initial', 'swelling', this.checked)">
                            <label for="initialSwelling">Include swelling assessment</label>
                        </div>
                        <div id="initialSwellingFields" class="hidden">
                            <div class="form-group">
                                <label>Swelling Present:</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="initialSwellingPresent" value="true" onchange="updateNestedField('initialFindings.objectiveFindings.swellingPresent', true)"> Yes</label>
                                    <label><input type="radio" name="initialSwellingPresent" value="false" onchange="updateNestedField('initialFindings.objectiveFindings.swellingPresent', false)"> No</label>
                                </div>
                            </div>
                        </div>

                        <!-- Temperature -->
                        <div class="checkbox-group">
                            <input type="checkbox" id="initialTemperature" onchange="toggleAdditionalField('initial', 'temperature', this.checked)">
                            <label for="initialTemperature">Include temperature assessment</label>
                        </div>
                        <div id="initialTemperatureFields" class="hidden">
                            <div class="form-group">
                                <label>Increased Temperature:</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="initialTemperatureIncreased" value="true" onchange="updateNestedField('initialFindings.objectiveFindings.temperatureIncreased', true)"> Yes</label>
                                    <label><input type="radio" name="initialTemperatureIncreased" value="false" onchange="updateNestedField('initialFindings.objectiveFindings.temperatureIncreased', false)"> No</label>
                                </div>
                            </div>
                        </div>

                        <!-- Sensation -->
                        <div class="checkbox-group">
                            <input type="checkbox" id="initialSensation" onchange="toggleAdditionalField('initial', 'sensation', this.checked)">
                            <label for="initialSensation">Include sensation assessment</label>
                        </div>
                        <div id="initialSensationFields" class="hidden">
                            <div class="form-group">
                                <label>Sensation Status:</label>
                                <select class="form-control" id="initialSensationStatus" onchange="updateSensationStatus('initial', this.value)">
                                    <option value="">Select Status</option>
                                    <option value="intact">Intact</option>
                                    <option value="reduced">Reduced</option>
                                    <option value="hypersensitive">Hypersensitivity</option>
                                </select>
                            </div>
                            <div id="initialSensationReducedFields" class="hidden">
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label>Reduction Percentage:</label>
                                        <input type="text" class="form-control" onchange="updateNestedFieldWithPercentage('initialFindings.objectiveFindings.sensationReduction', this.value)" placeholder="e.g., 50%">
                                    </div>
                                    <div class="form-group">
                                        <label>Over Which Area:</label>
                                        <input type="text" class="form-control auto-lowercase-first-word" onchange="updateNestedFieldWithNormalization('initialFindings.objectiveFindings.areaReduced', this.value)" placeholder="e.g., dorsal aspect of hand">
                                    </div>
                                </div>
                            </div>
                            <div id="initialSensationHypersensitiveFields" class="hidden">
                                <div class="form-group">
                                    <label>Over Which Area:</label>
                                    <input type="text" class="form-control auto-lowercase-first-word" onchange="updateNestedFieldWithNormalization('initialFindings.objectiveFindings.areaHypersensitive', this.value)" placeholder="e.g., dorsal aspect of hand">
                                </div>
                            </div>
                        </div>

                        <!-- Reflex -->
                        <div class="checkbox-group">
                            <input type="checkbox" id="initialReflex" onchange="toggleAdditionalField('initial', 'reflex', this.checked)">
                            <label for="initialReflex">Include reflex finding</label>
                        </div>
                        <div id="initialReflexFields" class="hidden">
                            <div class="form-group">
                                <label>Reflex:</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="initialReflexStatus" value="true" onchange="updateNestedField('initialFindings.objectiveFindings.reflexNormal', true)"> Normal</label>
                                    <label><input type="radio" name="initialReflexStatus" value="false" onchange="updateNestedField('initialFindings.objectiveFindings.reflexNormal', false)"> Abnormal</label>
                                </div>
                            </div>
                        </div>

                        <!-- Gait Assessment -->
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Walking Aid:</label>
                                <select class="form-control" onchange="updateNestedField('initialFindings.objectiveFindings.walkingAid', this.value)">
                                    <option value="">Select Aid</option>
                                    <option value="unaided">Unaided</option>
                                    <option value="stick">Stick</option>
                                    <option value="quadruped">Quadruped</option>
                                    <option value="frame">Frame</option>
                                    <option value="elbow crutches">Elbow Crutches</option>
                                    <option value="rollator">Rollator</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Walking Stability:</label>
                                <select class="form-control" onchange="updateNestedField('initialFindings.objectiveFindings.walkingStability', this.value)">
                                    <option value="">Select Stability</option>
                                    <option value="good">Good</option>
                                    <option value="normal">Normal</option>
                                    <option value="acceptable">Acceptable</option>
                                    <option value="satisfactory">Satisfactory</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                </select>
                            </div>
                        </div>

                        <!-- Weight Bearing Status -->
                        <div class="checkbox-group">
                            <input type="checkbox" id="initialWeightBearing" onchange="toggleAdditionalField('initial', 'weightBearing', this.checked)">
                            <label for="initialWeightBearing">Include weight bearing status</label>
                        </div>
                        <div id="initialWeightBearingFields" class="hidden">
                            <div class="form-group">
                                <label>Weight Bearing Status:</label>
                                <select class="form-control" onchange="updateNestedField('initialFindings.objectiveFindings.wbStatus', this.value)">
                                    <option value="">Select Status</option>
                                    <option value="full weight bearing">Full weight bearing</option>
                                    <option value="partial weight bearing">Partial weight bearing</option>
                                    <option value="toe touching down">Toe touching down</option>
                                    <option value="non weight bearing">Non weight bearing</option>
                                    <option value="weight bearing as tolerated">Weight bearing as tolerated</option>
                                </select>
                            </div>
                        </div>

                        <!-- Special Tests -->
                        <div class="form-group">
                            <label>Special Tests:</label>
                            <div id="initialSpecialTestsContainer"></div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addSpecialTest('initial')">Add Special Test</button>
                        </div>

                        <!-- Questionnaire -->
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Questionnaire:</label>
                                <select class="form-control" id="initialQuestionnaire" onchange="updateQuestionnaireField('initial', 'name', this.value)">
                                    <option value="">Select Questionnaire</option>
                                    <option value="Roland-Morris Disability Questionnaire">Roland-Morris Disability Questionnaire</option>
                                    <option value="Northwick Park Neck Pain Questionnaire">Northwick Park Neck Pain Questionnaire</option>
                                    <option value="QuickDASH">QuickDASH</option>
                                    <option value="Lower Extremity Functional Scale">Lower Extremity Functional Scale</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Score:</label>
                                <input type="text" class="form-control" onchange="updateQuestionnaireField('initial', 'score', this.value)">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="button" class="btn-copy" onclick="copyFromInitial('interim')">
                        <span class="copy-icon"></span>
                        Copy to Interim Findings
                    </button>
                    <button type="button" class="btn-copy" onclick="copyFromInitial('final')">
                        <span class="copy-icon"></span>
                        Copy to Final Findings
                    </button>
                </div>
            </div>

            <!-- Interim Clinical Content -->
            <div class="clinical-content" id="interimClinical">
                <div class="collapsible-header" onclick="toggleCollapse('interimContent')">
                    <h3 style="margin: 0;">Interim Clinical Findings</h3>
                    <span class="collapse-icon" id="interimCollapseIcon"></span>
                </div>
                <div class="collapsible-content" id="interimContent">
                <div class="form-group">
                    <label>Date:</label>
                    <input type="date" class="form-control" id="interimDate" onchange="updateNestedField('interimFindings.date', this.value)">
                </div>
                
                <h4 id="interimComplaints">I. Patient's Complaints</h4>
                <div class="grid-2">
                    <div class="form-group" id="interimSideContainer">
                        <label>Side:</label>
                        <select class="form-control" id="interimComplaintsSide" onchange="updateComplaintsSide('interim', this.value)">
                            <option value="">Select Side</option>
                            <option value="right">Right</option>
                            <option value="left">Left</option>
                            <option value="bilateral">Bilateral</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location:</label>
                        <select class="form-control" id="interimPainRegion" onchange="updatePainRegion('interim', this.value)">
                            <option value="">Select Location</option>
                            <option value="back">Back</option>
                            <option value="neck">Neck</option>
                            <option value="shoulder">Shoulder</option>
                            <option value="elbow">Elbow</option>
                            <option value="wrist">Wrist</option>
                            <option value="hand">Hand</option>
                            <option value="hip">Hip</option>
                            <option value="knee">Knee</option>
                            <option value="ankle">Ankle</option>
                            <option value="foot">Foot</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pain Intensity (NPRS):</label>
                        <input type="text" class="form-control" id="interimPainIntensity" onchange="updateNestedField('interimFindings.complaints.painIntensity', this.value)" placeholder="e.g., 7 or 6-8">
                    </div>
                </div>
                
                <!-- Other Symptoms (Expandable Paired Fields) -->
                <div class="dynamic-field-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h5>Other Symptoms</h5>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addOtherSymptom('interim')">Add Other Symptom</button>
                    </div>
                    <div id="interimOtherSymptomsContainer"></div>
                </div>

                <!-- Functional Activities -->
                <div class="form-group">
                    <h4>Functional Activity</h4>
                    
                    <!-- Activity 1: Sitting/Reading -->
                    <div class="dynamic-field-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5>Activity: Sitting/Reading</h5>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addActivity1('interim')">Add Activity</button>
                        </div>
                        <div id="interimActivities1Container"></div>
                    </div>
                    
                    <!-- Activity 2: Walking/Standing -->
                    <div class="dynamic-field-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5>Activity: Walking/Standing</h5>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addActivity2('interim')">Add Activity</button>
                        </div>
                        <div id="interimActivities2Container"></div>
                    </div>
                    
                    <!-- Other Functional Limitation -->
                    <div class="form-group">
                        <label>Other Functional Limitation:</label>
                        <textarea class="form-control" id="interimOtherFunctionalLimitation" onchange="updateNestedField('interimFindings.complaints.otherFunctionalLimitation', this.value)" placeholder="e.g., His walking tolerance improved from 5 minutes to 15 minutes. He can now climb stairs without assistance." rows="3"></textarea>
                        <small style="color: #6b7280; font-size: 14px; margin-top: 5px; display: block;">Please write in complete sentence.</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Overall Subjective Improvement (NGRCS):</label>
                    <select class="form-control" id="interimImprovement" onchange="updateNestedField('interimFindings.complaints.overallImprovement', this.value)">
                        <option value="">Select Improvement</option>
                        <option value="0">0 out of 10</option>
                        <option value="1">1 out of 10</option>
                        <option value="2">2 out of 10</option>
                        <option value="3">3 out of 10</option>
                        <option value="4">4 out of 10</option>
                        <option value="5">5 out of 10</option>
                        <option value="6">6 out of 10</option>
                        <option value="7">7 out of 10</option>
                        <option value="8">8 out of 10</option>
                        <option value="9">9 out of 10</option>
                        <option value="10">10 out of 10</option>
                    </select>
                </div>
                
                <h4>II. Objective Findings</h4>
                
                <!-- Dynamic Clinical Assessment Fields Container -->
                <div id="interimObjectiveContainer">
                    <!-- Same structure as initial but with interim IDs -->
                    <!-- This will be populated by JavaScript -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="button" class="btn-copy" onclick="copyFromInterim('final')">
                        <span class="copy-icon"></span>
                        Copy to Final Findings
                    </button>
                </div>
                </div>
            </div>

            <!-- Final Clinical Content -->
            <div class="clinical-content" id="finalClinical">
                <h3>Final Clinical Findings</h3>
                <div style="margin-bottom: 20px;">
                    <button type="button" class="btn-copy" onclick="copyFromInitial('final')">
                        <span class="copy-icon"></span>
                        Copy from Initial Findings
                    </button>
                    <button type="button" class="btn-copy" onclick="copyFromInterim('final')">
                        <span class="copy-icon"></span>
                        Copy from Interim Findings
                    </button>
                </div>
                
                <div class="form-group">
                    <label>Date:</label>
                    <input type="date" class="form-control" id="finalDate" onchange="updateNestedField('finalFindings.date', this.value)">
                </div>
                
                <h4 id="finalComplaints">I. Patient's Complaints</h4>
                <div class="grid-2">
                    <div class="form-group" id="finalSideContainer">
                        <label>Side:</label>
                        <select class="form-control" id="finalComplaintsSide" onchange="updateComplaintsSide('final', this.value)">
                            <option value="">Select Side</option>
                            <option value="right">Right</option>
                            <option value="left">Left</option>
                            <option value="bilateral">Bilateral</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location:</label>
                        <select class="form-control" id="finalPainRegion" onchange="updatePainRegion('final', this.value)">
                            <option value="">Select Location</option>
                            <option value="back">Back</option>
                            <option value="neck">Neck</option>
                            <option value="shoulder">Shoulder</option>
                            <option value="elbow">Elbow</option>
                            <option value="wrist">Wrist</option>
                            <option value="hand">Hand</option>
                            <option value="hip">Hip</option>
                            <option value="knee">Knee</option>
                            <option value="ankle">Ankle</option>
                            <option value="foot">Foot</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pain Intensity (NPRS):</label>
                        <input type="text" class="form-control" id="finalPainIntensity" onchange="updateNestedField('finalFindings.complaints.painIntensity', this.value)" placeholder="e.g., 7 or 6-8">
                    </div>
                </div>
                
                <!-- Other Symptoms (Expandable Paired Fields) -->
                <div class="dynamic-field-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h5>Other Symptoms</h5>
                        <button type="button" class="btn btn-secondary btn-small" onclick="addOtherSymptom('final')">Add Other Symptom</button>
                    </div>
                    <div id="finalOtherSymptomsContainer"></div>
                </div>

                <!-- Functional Activities -->
                <div class="form-group">
                    <h4>Functional Activity</h4>
                    
                    <!-- Activity 1: Sitting/Reading -->
                    <div class="dynamic-field-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5>Activity: Sitting/Reading</h5>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addActivity1('final')">Add Activity</button>
                        </div>
                        <div id="finalActivities1Container"></div>
                    </div>
                    
                    <!-- Activity 2: Walking/Standing -->
                    <div class="dynamic-field-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h5>Activity: Walking/Standing</h5>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addActivity2('final')">Add Activity</button>
                        </div>
                        <div id="finalActivities2Container"></div>
                    </div>
                    
                    <!-- Other Functional Limitation -->
                    <div class="form-group">
                        <label>Other Functional Limitation:</label>
                        <textarea class="form-control" id="finalOtherFunctionalLimitation" onchange="updateNestedField('finalFindings.complaints.otherFunctionalLimitation', this.value)" placeholder="e.g., His walking tolerance improved from 5 minutes to 15 minutes. He can now climb stairs without assistance." rows="3"></textarea>
                        <small style="color: #6b7280; font-size: 14px; margin-top: 5px; display: block;">Please write in complete sentence.</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Overall Subjective Improvement (NGRCS):</label>
                    <select class="form-control" id="finalImprovement" onchange="updateNestedField('finalFindings.complaints.overallImprovement', this.value)">
                        <option value="">Select Improvement</option>
                        <option value="0">0 out of 10</option>
                        <option value="1">1 out of 10</option>
                        <option value="2">2 out of 10</option>
                        <option value="3">3 out of 10</option>
                        <option value="4">4 out of 10</option>
                        <option value="5">5 out of 10</option>
                        <option value="6">6 out of 10</option>
                        <option value="7">7 out of 10</option>
                        <option value="8">8 out of 10</option>
                        <option value="9">9 out of 10</option>
                        <option value="10">10 out of 10</option>
                    </select>
                </div>
                
                <h4>II. Objective Findings</h4>
                
                <!-- Dynamic Clinical Assessment Fields Container -->
                <div id="finalObjectiveContainer">
                    <!-- Same structure as initial but with final IDs -->
                    <!-- This will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Bottom Navigation -->
            <div style="margin-top: 30px; text-align: center; padding: 20px; background-color: #f0f9ff; border-radius: 8px;">
                <h5 style="margin-bottom: 15px; color: #1e40af;">Navigate Clinical Findings</h5>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button type="button" class="btn btn-primary" onclick="showClinicalTabAndScroll('initial')">Initial Findings</button>
                    <button type="button" class="btn btn-primary" onclick="showClinicalTabAndScroll('interim')">Interim Findings</button>
                    <button type="button" class="btn btn-primary" onclick="showClinicalTabAndScroll('final')">Final Findings</button>
                </div>
            </div>
        </div>

        <!-- Section 7: Treatment Methods -->
        <div class="section" id="section7">
            <h2>Section 7: Treatment Methods</h2>
            
            <!-- Treatment Categories with Full App Layout -->
            <div class="grid-2" style="gap: 30px;">
                <!-- Left Column -->
                <div>
                    <div class="treatment-category">
                        <h4>Thermal Therapy</h4>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Hot pack', this.checked)"> Hot pack</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Cold pack', this.checked)"> Cold pack</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Wax therapy', this.checked)"> Wax therapy</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Hydrotherapy', this.checked)"> Hydrotherapy</label>
                        </div>
                    </div>

                    <div class="treatment-category">
                        <h4>Electrical Therapy</h4>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Interferential electrical therapy', this.checked)"> Interferential electrical therapy</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Neuromuscular electrical stimulation', this.checked)"> Neuromuscular electrical stimulation</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Transcutaneous Electrical Nerve Stimulation (TENS)', this.checked)"> Transcutaneous Electrical Nerve Stimulation (TENS)</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Ultrasound therapy', this.checked)"> Ultrasound therapy</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Pulsed electromagnetic field therapy', this.checked)"> Pulsed electromagnetic field therapy</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Shockwave therapy', this.checked)"> Shockwave therapy</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Micro-current therapy', this.checked)"> Micro-current therapy</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Infrared light therapy', this.checked)"> Infrared light therapy</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Polarized polychromatic light therapy', this.checked)"> Polarized polychromatic light therapy</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('High electromagnetic inductive therapy', this.checked)"> High electromagnetic inductive therapy</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Pulsed shortwave therapy', this.checked)"> Pulsed shortwave therapy</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Flowpulse therapy', this.checked)"> Flowpulse therapy</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Laser therapy', this.checked)"> Laser therapy</label>
                        </div>
                    </div>

                    <div class="treatment-category">
                        <h4>Traction Therapy</h4>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Intermittent lumbar traction', this.checked)"> Intermittent lumbar traction</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Intermittent neck traction', this.checked)"> Intermittent neck traction</label>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div>
                    <div class="treatment-category">
                        <h4>Manual Therapy</h4>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Manual therapy', this.checked)"> Manual therapy</label>
                        </div>
                    </div>

                    <div class="treatment-category">
                        <h4>Exercise Therapy</h4>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Mobilization exercise', this.checked)"> Mobilization exercise</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Strengthening exercise', this.checked)"> Strengthening exercise</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Exercise therapy', this.checked)"> Exercise therapy</label>
                        </div>
                    </div>

                    <div class="treatment-category">
                        <h4>Functional Training</h4>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Balance training', this.checked)"> Balance training</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Gait training', this.checked)"> Gait training</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Functional training', this.checked)"> Functional training</label>
                        </div>
                    </div>

                    <div class="treatment-category">
                        <h4>Others</h4>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('De-sensitization training', this.checked)"> De-sensitization training</label>
                        </div>
                        <div class="treatment-option">
                            <label><input type="checkbox" onchange="updateTreatmentMethod('Acupuncture', this.checked)"> Acupuncture</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Other Treatment:</label>
                <textarea class="form-control" id="otherTreatment" onchange="updateField('otherTreatment', this.value)" placeholder="Describe any other treatments not listed above"></textarea>
            </div>
        </div>

        <!-- Section 8: Discharge Summary -->
        <div class="section" id="section8">
            <h2>Section 8: Discharge Summary</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Discharge Type:</label>
                    <select class="form-control" id="dischargeType" onchange="updateDischargeType(this.value)">
                        <option value="">Select discharge type</option>
                        <option value="Discharged">Discharged</option>
                        <option value="Discharged with static progress">Discharged with static progress</option>
                        <option value="Still receiving physiotherapy">Still receiving physiotherapy</option>
                        <option value="Defaulted">Defaulted</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                
                <!-- Dynamic discharge fields based on type -->
                <div id="dischargeFields">
                    <!-- Will be populated by JavaScript based on discharge type -->
                </div>
            </div>
        </div>

        <!-- Section 9: Declaration -->
        <div class="section" id="section9">
            <h2>Section 9: Declaration</h2>
            <div class="form-group">
                <label>Consent Date for Declaration:</label>
                <input type="date" class="form-control" id="consentDate" onchange="updateField('consentDate', this.value)">
            </div>
            
            <h4 style="margin-top: 25px; margin-bottom: 15px; color: #374151; font-weight: 600;">Therapist Details</h4>
            <div class="grid-2">
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" class="form-control" id="declarationName" onchange="updateField('declarationName', this.value)" placeholder="Full name of the therapist">
                </div>
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" class="form-control" id="declarationTitle" onchange="updateField('declarationTitle', this.value)" placeholder="e.g., Senior Physiotherapist, Principal Physiotherapist">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Education Qualifications:</label>
                    <textarea class="form-control" id="educationQualifications" onchange="updateField('educationQualifications', this.value)" placeholder="e.g., BSc (Hons) Physiotherapy&#10;MSc Physiotherapy" rows="3"></textarea>
                </div>
            </div>
        </div>

        <!-- Developer Tools Section -->
        <div class="developer-tools-section">
            <h3> Developer Tools</h3>
            <p>Quick-fill realistic test data for development and testing purposes.</p>
            <div style="margin: 15px 0;">
                <button type="button" class="btn btn-primary" onclick="showMockDataOptions()">Fill Mock Data</button>
            </div>
            
            <!-- Mock Data Options (Hidden by default) -->
            <div class="mock-data-options" id="mockDataOptions">
                <h5>Select Mock Data Type:</h5>
                <div class="mock-data-buttons">
                    <button type="button" class="mock-data-btn" onclick="fillBackCaseMockData()">Back Pain Case</button>
                    <button type="button" class="mock-data-btn" onclick="fillWristCaseMockData()">Wrist Fracture Case</button>
                    <button type="button" class="mock-data-btn" onclick="fillHandCaseMockData()">Hand Tendon Case</button>
                </div>
                <div style="margin-top: 12px;">
                    <button type="button" class="btn btn-secondary" onclick="hideMockDataOptions()"> Back</button>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <h3>Data Export</h3>
            <p>Generate a data string that can be imported into the full app for identical report generation.</p>
            <div style="margin: 15px 0;">
                <button type="button" class="btn btn-success" onclick="generateDataString()">Generate Data String</button>
            </div>
            <textarea class="export-output" id="exportOutput" readonly placeholder="Click 'Generate Data String' to create exportable data..."></textarea>
            <div style="margin-top: 10px;">
                <button type="button" class="btn btn-secondary" onclick="copyDataString()">Copy Data String</button>
            </div>
        </div>
    </div>

    <script>
        // FULL APP COMPATIBLE DATA STRUCTURE
        
        var reportData = {
            // Section 1: Reference Information
            ourRef: '',
            ourRef2: '',
            yourRef: '',
            yourRefDate: '',
            reportDate: '',
            recipient: '',
            
            // Section 2: Patient Information
            patientName: '',
            patientSex: '',
            patientAge: '',
            hkidNo: '',
            physiotherapyOpdNo: '',
            
            // Section 3: Diagnosis
            diagnosis: '',
            
            // Section 4: Referral Source
            referralSources: [
                {
                    episode: 'First',
                    department: '',
                    hospital: ''
                }
            ],
            
            // Section 5: Duration
            totalSessions: '',
            registrationDate: '',
            startDate: '',
            endDate: '',
            caseTherapists: '',
            reportWrittenBy: '',
            attendedSessions: '',
            defaultedSessions: '',
            
            // Section 6: Clinical Findings (EXACT FULL APP STRUCTURE)
            initialFindings: {
                date: '',
                complaints: {
                    side: '',
                    location: '',
                    painIntensity: '',
                    otherSymptoms: [], // Array of {symptom: '', intensity: ''} objects
                    activities1: [], // reading/sitting
                    activities2: [], // walking/standing
                    otherFunctionalLimitation: '',
                    overallImprovement: ''
                },
                objectiveFindings: {
                    aromMovements: [],
                    handJoints: [],
                    fingersToesData: [],
                    toesROM: '',
                    grossFingersROM: '',
                    musclePower: [],
                    handGripStrength: {
                        leftHandGrip: '',
                        rightHandGrip: '',
                        leftPinchGrip: '',
                        rightPinchGrip: '',
                        leftLateralPinch: '',
                        rightLateralPinch: ''
                    },
                    myotome: [],
                    aromNotTested: false,
                    musclePowerNotTested: false,
                    handGripNotTested: false,
                    includeProm: false,
                    splintBraceCastInclude: false,
                    splintBraceCastType: '',
                    tendernessInclude: false,
                    tendernessArea: '',
                    swellingInclude: false,
                    swellingPresent: false,
                    temperatureInclude: false,
                    temperatureIncreased: false,
                    sensationInclude: false,
                    sensationStatus: '',
                    sensationReduction: '',
                    areaReduced: '',
                    areaHypersensitive: '',
                    reflexInclude: false,
                    reflexNormal: false,
                    walkingAid: '',
                    walkingStability: '',
                    wbStatusInclude: false,
                    wbStatus: '',
                    specialTests: [],
                    questionnaires: []
                }
            },
            interimFindings: {
                date: '',
                complaints: {
                    side: '',
                    location: '',
                    painIntensity: '',
                    otherSymptoms: '',
                    symptomIntensity: '',
                    activities1: [],
                    activities2: [],
                    otherFunctionalLimitation: '',
                    overallImprovement: ''
                },
                objectiveFindings: {
                    aromMovements: [],
                    handJoints: [],
                    fingersToesData: [],
                    toesROM: '',
                    musclePower: [],
                    handGripStrength: {
                        leftHandGrip: '',
                        rightHandGrip: '',
                        leftPinchGrip: '',
                        rightPinchGrip: '',
                        leftLateralPinch: '',
                        rightLateralPinch: ''
                    },
                    myotome: [],
                    aromNotTested: false,
                    musclePowerNotTested: false,
                    handGripNotTested: false,
                    includeProm: false,
                    splintBraceCastInclude: false,
                    splintBraceCastType: '',
                    tendernessInclude: false,
                    tendernessArea: '',
                    swellingInclude: false,
                    swellingPresent: false,
                    temperatureInclude: false,
                    temperatureIncreased: false,
                    sensationInclude: false,
                    sensationStatus: '',
                    sensationReduction: '',
                    areaReduced: '',
                    areaHypersensitive: '',
                    reflexInclude: false,
                    reflexNormal: false,
                    walkingAid: '',
                    walkingStability: '',
                    wbStatusInclude: false,
                    wbStatus: '',
                    specialTests: [],
                    questionnaires: []
                }
            },
            finalFindings: {
                date: '',
                complaints: {
                    side: '',
                    location: '',
                    painIntensity: '',
                    otherSymptoms: '',
                    symptomIntensity: '',
                    activities1: [],
                    activities2: [],
                    otherFunctionalLimitation: '',
                    overallImprovement: ''
                },
                objectiveFindings: {
                    aromMovements: [],
                    handJoints: [],
                    fingersToesData: [],
                    toesROM: '',
                    musclePower: [],
                    handGripStrength: {
                        leftHandGrip: '',
                        rightHandGrip: '',
                        leftPinchGrip: '',
                        rightPinchGrip: '',
                        leftLateralPinch: '',
                        rightLateralPinch: ''
                    },
                    myotome: [],
                    aromNotTested: false,
                    musclePowerNotTested: false,
                    handGripNotTested: false,
                    includeProm: false,
                    splintBraceCastInclude: false,
                    splintBraceCastType: '',
                    tendernessInclude: false,
                    tendernessArea: '',
                    swellingInclude: false,
                    swellingPresent: false,
                    temperatureInclude: false,
                    temperatureIncreased: false,
                    sensationInclude: false,
                    sensationStatus: '',
                    sensationReduction: '',
                    areaReduced: '',
                    areaHypersensitive: '',
                    reflexInclude: false,
                    reflexNormal: false,
                    walkingAid: '',
                    walkingStability: '',
                    wbStatusInclude: false,
                    wbStatus: '',
                    specialTests: [],
                    questionnaires: []
                }
            },
            
            // Section 7: Treatment Methods
            treatments: [],
            otherTreatment: '',
            
            // Section 8: Discharge Summary
            dischargeSummary: {
                componentData: {
                    dischargeType: '',
                    dischargeDate: '',
                    defaultDate: '',
                    cancellationDate: '',
                    scheduledAppointmentDate: '',
                    cancellationReason: ''
                }
            },
            
            // Section 9: Declaration
            consentDate: '',
            declarationName: '',
            declarationTitle: '',
            educationQualifications: ''
        };

        // EXACT FULL APP FIELD MAPPINGS
        
        function getAROMMovementsByLocation(location) {
            var movements = {
                'back': ['Flexion', 'Extension', 'Right Rotation', 'Left Rotation', 'Right Side Flexion', 'Left Side Flexion'],
                'neck': ['Flexion', 'Extension', 'Right Rotation', 'Left Rotation', 'Right Side Flexion', 'Left Side Flexion'],
                'shoulder': ['Flexion', 'Abduction', 'Extension', 'External Rotation', 'Internal Rotation', 'Hand behind back', 'Hand behind neck'],
                'elbow': ['Flexion', 'Extension', 'Pronation', 'Supination'],
                'wrist': ['Flexion', 'Extension', 'Pronation', 'Supination', 'Radial Deviation', 'Ulnar Deviation'],
                'hip': ['Flexion', 'Abduction', 'Extension', 'External Rotation', 'Internal Rotation'],
                'knee': ['Flexion', 'Extension'],
                'ankle': ['Plantarflexion', 'Dorsiflexion', 'Eversion', 'Inversion']
            };
            return movements[location] || [];
        }

        function getMuscleGroupsByLocation(location) {
            var muscleGroups = {
                'shoulder': ['Flexor', 'Abductor', 'Extensor', 'External Rotator', 'Internal Rotator'],
                'elbow': ['Flexor', 'Extensor', 'Pronator', 'Supinator'],
                'wrist': ['Flexor', 'Extensor', 'Pronator', 'Supinator', 'Radial Deviator', 'Ulnar Deviator'],
                'hip': ['Flexor', 'Extensor', 'Abductor', 'External Rotator', 'Internal Rotator'],
                'knee': ['Flexor', 'Extensor'],
                'ankle': ['Plantarflexor', 'Dorsiflexor', 'Evertor', 'Invertor', 'Toes'],
                'foot': ['Plantarflexor', 'Dorsiflexor', 'Evertor', 'Invertor', 'Toes']
            };
            return muscleGroups[location] || [];
        }

        function getMyotomeLevelsByLocation(location) {
            var myotomeLevels = {
                'back': ['L2', 'L3', 'L4', 'L5', 'S1'],
                'neck': ['C5', 'C6', 'C7', 'C8', 'T1']
            };
            return myotomeLevels[location] || [];
        }

        function getSmallJointsByLocation(location) {
            var smallJoints = {
                'hand': ['cmcj', 'mcpj', 'pipj', 'dipj', 'ipj'],
                'foot': ['mtpj', 'pipj', 'dipj', 'ipj']
            };
            return smallJoints[location] || [];
        }

        function getQuestionnairesByLocation(location) {
            var questionnaires = {
                'shoulder': ['QuickDASH'],
                'elbow': ['QuickDASH'],
                'wrist': ['QuickDASH'],
                'hand': ['QuickDASH'],
                'hip': ['Lower Extremity Functional Scale'],
                'knee': ['Lower Extremity Functional Scale', 'Knee Injury & Osteoarthritis Outcome Score-Pain', 'Knee Injury & Osteoarthritis Outcome Score-PS', 'Knee Injury & Osteoarthritis Outcome Score-QoL'],
                'ankle': ['Lower Extremity Functional Scale'],
                'foot': ['Lower Extremity Functional Scale'],
                'neck': ['Northwick Park Neck Pain Questionnaire'],
                'back': ['Roland-Morris Disability Questionnaire']
            };
            return questionnaires[location] || [];
        }

        // DYNAMIC FIELD GENERATION FUNCTIONS

        function generateClinicalFields(section, location, side) {
            if (!location) return;
            
            // Clear existing fields
            clearClinicalFields(section);
            
            // Generate fields based on location
            if (location === 'hand' || location === 'foot') {
                // Hand/Foot: AROM with "Not tested" option but no data fields, fingers/toes, no muscle power
                document.getElementById(section + 'AromContainer').style.display = 'block';
                document.getElementById(section + 'MusclePowerContainer').style.display = 'none';
                document.getElementById(section + 'MyotomeContainer').style.display = 'none';
                
                if (location === 'hand') {
                    generateHandGripFields(section);
                    document.getElementById(section + 'HandGripContainer').style.display = 'block';
                } else {
                    document.getElementById(section + 'HandGripContainer').style.display = 'none';
                }
                
                generateFingersToesFields(section, location);
                document.getElementById(section + 'FingersToesContainer').style.display = 'block';
                document.getElementById(section + 'ToesRomContainer').style.display = 'none';
                document.getElementById(section + 'GrossFingersRomContainer').style.display = 'none';
                
            } else if (location === 'back' || location === 'neck') {
                // Back/Neck: AROM + Myotome only
                generateAROMFields(section, location);
                generateMyotomeFields(section, location);
                document.getElementById(section + 'AromContainer').style.display = 'block';
                document.getElementById(section + 'MusclePowerContainer').style.display = 'none';
                document.getElementById(section + 'MyotomeContainer').style.display = 'block';
                document.getElementById(section + 'HandGripContainer').style.display = 'none';
                document.getElementById(section + 'FingersToesContainer').style.display = 'none';
                document.getElementById(section + 'ToesRomContainer').style.display = 'none';
                document.getElementById(section + 'GrossFingersRomContainer').style.display = 'none';
                
            } else if (location === 'ankle') {
                // Ankle: AROM + Muscle Power + Toes ROM
                generateAROMFields(section, location);
                generateMusclePowerFields(section, location, side);
                document.getElementById(section + 'AromContainer').style.display = 'block';
                document.getElementById(section + 'MusclePowerContainer').style.display = 'block';
                document.getElementById(section + 'MyotomeContainer').style.display = 'none';
                document.getElementById(section + 'HandGripContainer').style.display = 'none';
                document.getElementById(section + 'FingersToesContainer').style.display = 'none';
                document.getElementById(section + 'ToesRomContainer').style.display = 'block';
                document.getElementById(section + 'GrossFingersRomContainer').style.display = 'none';
                
            } else if (location === 'wrist') {
                // Wrist: AROM + Gross Fingers ROM + Muscle Power + Hand Grip (reordered)
                generateAROMFields(section, location);
                generateMusclePowerFields(section, location, side);
                generateWristHandGripFields(section);
                document.getElementById(section + 'AromContainer').style.display = 'block';
                document.getElementById(section + 'MusclePowerContainer').style.display = 'block';
                document.getElementById(section + 'MyotomeContainer').style.display = 'none';
                document.getElementById(section + 'HandGripContainer').style.display = 'block';
                document.getElementById(section + 'FingersToesContainer').style.display = 'none';
                document.getElementById(section + 'ToesRomContainer').style.display = 'none';
                document.getElementById(section + 'GrossFingersRomContainer').style.display = 'block';
                
            } else {
                // Other locations: AROM + Muscle Power
                generateAROMFields(section, location);
                generateMusclePowerFields(section, location, side);
                document.getElementById(section + 'AromContainer').style.display = 'block';
                document.getElementById(section + 'MusclePowerContainer').style.display = 'block';
                document.getElementById(section + 'MyotomeContainer').style.display = 'none';
                document.getElementById(section + 'HandGripContainer').style.display = 'none';
                document.getElementById(section + 'FingersToesContainer').style.display = 'none';
                document.getElementById(section + 'ToesRomContainer').style.display = 'none';
                document.getElementById(section + 'GrossFingersRomContainer').style.display = 'none';
            }
            
            // Update questionnaire options
            updateQuestionnaireOptions(section, location);
        }

        function clearClinicalFields(section) {
            var aromFields = document.getElementById(section + 'AromFields');
            if (aromFields) aromFields.innerHTML = '';
            
            var musclePowerFields = document.getElementById(section + 'MusclePowerFields');
            if (musclePowerFields) musclePowerFields.innerHTML = '';
            
            var myotomeFields = document.getElementById(section + 'MyotomeFields');
            if (myotomeFields) myotomeFields.innerHTML = '';
            
            var fingersToesFields = document.getElementById(section + 'FingersToesFields');
            if (fingersToesFields) fingersToesFields.innerHTML = '';
            
            var handGripFields = document.getElementById(section + 'HandGripFields');
            if (handGripFields) handGripFields.innerHTML = '';
        }

        // AROM Fields Implementation
        function generateAROMFields(section, location) {
            var movements = getAROMMovementsByLocation(location);
            var container = document.getElementById(section + 'AromFields');
            if (!container) return;
            
            var html = '';
            
            // For hand/foot, just show empty container with "Not tested" option
            if (location === 'hand' || location === 'foot') {
                // Don't generate any AROM data fields for hand/foot
                container.innerHTML = '';
                return;
            }
            
            movements.forEach(function(movement, index) {
                html += '<div class="assessment-row">';
                html += '<label>' + movement + ':</label>';
                
                // Use exact placeholder text from full app
                var placeholder = (location === 'back' || location === 'neck') ? 'e.g., 3/5' : 'e.g., 90';
                html += '<input type="text" class="form-control" placeholder="' + placeholder + '" ';
                html += 'onchange="updateAROMValue(\'' + section + '\', ' + index + ', \'' + movement + '\', this.value)">';
                html += '</div>';
            });
            
            container.innerHTML = html;
            
            // Initialize AROM data structure
            if (!reportData[section + 'Findings'].objectiveFindings.aromMovements) {
                reportData[section + 'Findings'].objectiveFindings.aromMovements = [];
            }
            
            // Ensure AROM array has correct length
            movements.forEach(function(movement, index) {
                if (!reportData[section + 'Findings'].objectiveFindings.aromMovements[index]) {
                    reportData[section + 'Findings'].objectiveFindings.aromMovements[index] = {
                        movement: movement,
                        arom: '',
                        prom: ''
                    };
                }
            });
        }

        function updateAROMValue(section, index, movement, value) {
            if (!reportData[section + 'Findings'].objectiveFindings.aromMovements[index]) {
                reportData[section + 'Findings'].objectiveFindings.aromMovements[index] = {
                    movement: movement,
                    arom: '',
                    prom: ''
                };
            }
            reportData[section + 'Findings'].objectiveFindings.aromMovements[index].arom = value;
        }

        // Muscle Power Fields Implementation
        function generateMusclePowerFields(section, location, side) {
            var muscleGroups = getMuscleGroupsByLocation(location);
            var container = document.getElementById(section + 'MusclePowerFields');
            if (!container) return;
            
            var html = '';
            
            muscleGroups.forEach(function(group, index) {
                html += '<div class="assessment-row">';
                html += '<label>' + group + ':</label>';
                
                // Show only the selected side for non-back/neck regions
                if (side === 'left' || side === 'bilateral') {
                    html += '<select class="form-control left-grade" ';
                    html += 'onchange="updateMusclePowerValue(\'' + section + '\', ' + index + ', \'' + group + '\', \'left\', this.value)">';
                    html += '<option value="">Left</option>';
                    html += generateGradeOptions();
                    html += '</select>';
                }
                
                if (side === 'right' || side === 'bilateral') {
                    html += '<select class="form-control right-grade" ';
                    html += 'onchange="updateMusclePowerValue(\'' + section + '\', ' + index + ', \'' + group + '\', \'right\', this.value)">';
                    html += '<option value="">Right</option>';
                    html += generateGradeOptions();
                    html += '</select>';
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
            
            // Initialize muscle power data structure
            if (!reportData[section + 'Findings'].objectiveFindings.musclePower) {
                reportData[section + 'Findings'].objectiveFindings.musclePower = [];
            }
            
            // Ensure muscle power array has correct length
            muscleGroups.forEach(function(group, index) {
                if (!reportData[section + 'Findings'].objectiveFindings.musclePower[index]) {
                    reportData[section + 'Findings'].objectiveFindings.musclePower[index] = {
                        muscleGroup: group,
                        leftGrade: '',
                        rightGrade: '',
                        leftGrip: undefined,
                        rightGrip: undefined,
                        pinchGrip: undefined,
                        lateralPinch: undefined
                    };
                }
            });
        }

        function generateGradeOptions() {
            var grades = ['0', '1', '2', '3', '4', '5'];
            var html = '';
            grades.forEach(function(grade) {
                html += '<option value="' + grade + '">' + grade + '/5</option>';
            });
            return html;
        }

        function updateMusclePowerValue(section, index, group, side, value) {
            if (!reportData[section + 'Findings'].objectiveFindings.musclePower[index]) {
                reportData[section + 'Findings'].objectiveFindings.musclePower[index] = {
                    muscleGroup: group,
                    leftGrade: '',
                    rightGrade: ''
                };
            }
            reportData[section + 'Findings'].objectiveFindings.musclePower[index][side + 'Grade'] = value;
            
            // Ensure muscle power array is properly maintained
            console.log('Muscle power updated:', section, index, group, side, value);
            console.log('Current muscle power array:', reportData[section + 'Findings'].objectiveFindings.musclePower);
        }

        function smartFillMusclePower(section) {
            var smartFillSelect = document.getElementById(section + 'MusclePowerSmartFill');
            var grade = smartFillSelect.value;
            if (!grade) return;
            
            var muscleSelects = document.querySelectorAll('#' + section + 'MusclePowerFields select');
            muscleSelects.forEach(function(select) {
                if (!select.value) {
                    select.value = grade;
                    select.dispatchEvent(new Event('change'));
                }
            });
            
            smartFillSelect.value = '';
        }

        function clearAllMusclePower(section) {
            var muscleSelects = document.querySelectorAll('#' + section + 'MusclePowerFields select');
            muscleSelects.forEach(function(select) {
                select.value = '';
                select.dispatchEvent(new Event('change'));
            });
        }

        // Myotome Fields Implementation
        function generateMyotomeFields(section, location) {
            var myotomeLevels = getMyotomeLevelsByLocation(location);
            var container = document.getElementById(section + 'MyotomeFields');
            if (!container) return;
            
            var html = '';
            myotomeLevels.forEach(function(level, index) {
                html += '<div class="assessment-row">';
                html += '<label>' + level + ':</label>';
                html += '<select class="form-control" ';
                html += 'onchange="updateMyotomeValue(\'' + section + '\', ' + index + ', \'' + level + '\', \'left\', this.value)">';
                html += '<option value="">Left</option>';
                html += generateGradeOptions();
                html += '</select>';
                html += '<select class="form-control" ';
                html += 'onchange="updateMyotomeValue(\'' + section + '\', ' + index + ', \'' + level + '\', \'right\', this.value)">';
                html += '<option value="">Right</option>';
                html += generateGradeOptions();
                html += '</select>';
                html += '</div>';
            });
            
            container.innerHTML = html;
            
            // Initialize myotome data structure
            if (!reportData[section + 'Findings'].objectiveFindings.myotome) {
                reportData[section + 'Findings'].objectiveFindings.myotome = [];
            }
            
            // Ensure myotome array has correct length
            myotomeLevels.forEach(function(level, index) {
                if (!reportData[section + 'Findings'].objectiveFindings.myotome[index]) {
                    reportData[section + 'Findings'].objectiveFindings.myotome[index] = {
                        level: level,
                        leftGrade: '',
                        rightGrade: ''
                    };
                }
            });
        }

        function updateMyotomeValue(section, index, level, side, value) {
            if (!reportData[section + 'Findings'].objectiveFindings.myotome[index]) {
                reportData[section + 'Findings'].objectiveFindings.myotome[index] = {
                    level: level,
                    leftGrade: '',
                    rightGrade: ''
                };
            }
            reportData[section + 'Findings'].objectiveFindings.myotome[index][side + 'Grade'] = value;
        }

        function smartFillMyotome(section) {
            var smartFillSelect = document.getElementById(section + 'MyotomeSmartFill');
            var grade = smartFillSelect.value;
            if (!grade) return;
            
            var myotomeSelects = document.querySelectorAll('#' + section + 'MyotomeFields select');
            myotomeSelects.forEach(function(select) {
                if (!select.value) {
                    select.value = grade;
                    select.dispatchEvent(new Event('change'));
                }
            });
            
            smartFillSelect.value = '';
        }

        function clearAllMyotome(section) {
            var myotomeSelects = document.querySelectorAll('#' + section + 'MyotomeFields select');
            myotomeSelects.forEach(function(select) {
                select.value = '';
                select.dispatchEvent(new Event('change'));
            });
        }

        // Fingers/Toes Implementation (Improved UI Design)
        function generateFingersToesFields(section, location) {
            var container = document.getElementById(section + 'FingersToesFields');
            if (!container) return;
            
            // Initialize with empty array
            if (!reportData[section + 'Findings'].objectiveFindings.fingersToesData) {
                reportData[section + 'Findings'].objectiveFindings.fingersToesData = [];
            }
            
            // Auto-add first finger/toe for better UX
            if (reportData[section + 'Findings'].objectiveFindings.fingersToesData.length === 0) {
                reportData[section + 'Findings'].objectiveFindings.fingersToesData.push({
                    name: '',
                    joints: []
                });
            }
            
            renderFingersToesFields(section, location);
        }

        function renderFingersToesFields(section, location) {
            var container = document.getElementById(section + 'FingersToesFields');
            var joints = getSmallJointsByLocation(location);
            var fingersToesData = reportData[section + 'Findings'].objectiveFindings.fingersToesData;
            
            var html = '';
            fingersToesData.forEach(function(fingerToe, index) {
                html += '<div class="small-joint-field" style="margin-bottom: 20px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; background-color: #f9fafb;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">';
                html += '<h6 style="margin: 0; color: #374151; font-weight: 600;">' + (location === 'hand' ? 'Finger' : 'Toe') + ' ' + (index + 1) + '</h6>';
                if (fingersToesData.length > 1) {
                    html += '<button type="button" class="btn btn-secondary btn-small" onclick="removeFingerToe(\'' + section + '\', ' + index + ')">Remove</button>';
                }
                html += '</div>';
                
                html += '<div class="form-group" style="margin-bottom: 15px;">';
                html += '<label style="font-weight: 500; margin-bottom: 5px; display: block;">Name:</label>';
                html += '<input type="text" class="form-control" value="' + (fingerToe.name || '') + '" ';
                html += 'onchange="updateFingerToeName(\'' + section + '\', ' + index + ', this.value)" placeholder="e.g., Index finger">';
                html += '</div>';
                
                // Small Joints Checkboxes (Full App Style)
                html += '<div style="margin-bottom: 15px;">';
                html += '<label style="font-weight: 500; margin-bottom: 8px; display: block;">Small Joints:</label>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">';
                
                joints.forEach(function(jointType) {
                    var isSelected = fingerToe.joints && fingerToe.joints.some(function(joint) {
                        return joint.jointType === jointType;
                    });
                    html += '<div class="small-joint-checkbox">';
                    html += '<input type="checkbox" id="' + section + '_' + index + '_' + jointType + '" ';
                    html += (isSelected ? 'checked ' : '') + 'onchange="toggleFingerToeJoint(\'' + section + '\', ' + index + ', \'' + jointType + '\', this.checked)">';
                    html += '<label for="' + section + '_' + index + '_' + jointType + '" style="margin-left: 5px; font-size: 14px;">' + jointType.toUpperCase() + '</label>';
                    html += '</div>';
                });
                
                html += '</div>';
                html += '</div>';
                
                // Joint Range Fields
                if (fingerToe.joints && fingerToe.joints.length > 0) {
                    html += '<div style="margin-top: 15px;">';
                    html += '<label style="font-weight: 500; margin-bottom: 8px; display: block;">Joint Ranges:</label>';
                    fingerToe.joints.forEach(function(joint, jointIndex) {
                        html += '<div class="assessment-row" style="margin-bottom: 8px; padding: 8px; background-color: #ffffff; border-radius: 4px; border: 1px solid #e5e7eb;">';
                        html += '<label style="min-width: 80px; margin: 0; font-weight: 500;">' + joint.jointType.toUpperCase() + ':</label>';
                        html += '<input type="text" class="form-control" placeholder="e.g., 5-45" value="' + (joint.range || '') + '" ';
                        html += 'onchange="updateFingerToeJointRange(\'' + section + '\', ' + index + ', ' + jointIndex + ', this.value)" style="flex: 1;">';
                        html += '</div>';
                    });
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function addFingerToe(section) {
            if (!reportData[section + 'Findings'].objectiveFindings.fingersToesData) {
                reportData[section + 'Findings'].objectiveFindings.fingersToesData = [];
            }
            
            reportData[section + 'Findings'].objectiveFindings.fingersToesData.push({
                name: '',
                joints: []
            });
            
            var location = reportData[section + 'Findings'].complaints.location;
            renderFingersToesFields(section, location);
        }

        function removeFingerToe(section, index) {
            reportData[section + 'Findings'].objectiveFindings.fingersToesData.splice(index, 1);
            var location = reportData[section + 'Findings'].complaints.location;
            renderFingersToesFields(section, location);
        }

        function updateFingerToeName(section, index, value) {
            if (reportData[section + 'Findings'].objectiveFindings.fingersToesData[index]) {
                reportData[section + 'Findings'].objectiveFindings.fingersToesData[index].name = value;
            }
        }

        function toggleFingerToeJoint(section, fingerIndex, jointType, checked) {
            var fingerToe = reportData[section + 'Findings'].objectiveFindings.fingersToesData[fingerIndex];
            if (!fingerToe) return;
            
            if (!fingerToe.joints) {
                fingerToe.joints = [];
            }
            
            var existingJointIndex = -1;
            for (var i = 0; i < fingerToe.joints.length; i++) {
                if (fingerToe.joints[i].jointType === jointType) {
                    existingJointIndex = i;
                    break;
                }
            }
            
            if (checked && existingJointIndex === -1) {
                // Add joint
                fingerToe.joints.push({
                    jointType: jointType,
                    range: ''
                });
            } else if (!checked && existingJointIndex !== -1) {
                // Remove joint
                fingerToe.joints.splice(existingJointIndex, 1);
            }
            
            var location = reportData[section + 'Findings'].complaints.location;
            renderFingersToesFields(section, location);
        }

        function updateFingerToeJointRange(section, fingerIndex, jointIndex, value) {
            if (reportData[section + 'Findings'].objectiveFindings.fingersToesData[fingerIndex] && 
                reportData[section + 'Findings'].objectiveFindings.fingersToesData[fingerIndex].joints &&
                reportData[section + 'Findings'].objectiveFindings.fingersToesData[fingerIndex].joints[jointIndex]) {
                reportData[section + 'Findings'].objectiveFindings.fingersToesData[fingerIndex].joints[jointIndex].range = value;
            }
        }



        // Hand Grip Strength Implementation
        function generateHandGripFields(section) {
            var container = document.getElementById(section + 'HandGripFields');
            if (!container) return;
            
            var html = '';
            html += '<div class="grid-3">';
            html += '<div class="text-center font-medium">Test Type</div>';
            html += '<div class="text-center font-medium">Left (kgf)</div>';
            html += '<div class="text-center font-medium">Right (kgf)</div>';
            
            html += '<label class="flex items-center">Hand Grip</label>';
            html += '<input type="text" class="form-control" onchange="updateNestedField(\'' + section + 'Findings.objectiveFindings.handGripStrength.leftHandGrip\', this.value)" placeholder="e.g., 25">';
            html += '<input type="text" class="form-control" onchange="updateNestedField(\'' + section + 'Findings.objectiveFindings.handGripStrength.rightHandGrip\', this.value)" placeholder="e.g., 28">';
            
            html += '<label class="flex items-center">Pinch Grip</label>';
            html += '<input type="text" class="form-control" onchange="updateNestedField(\'' + section + 'Findings.objectiveFindings.handGripStrength.leftPinchGrip\', this.value)" placeholder="e.g., 8">';
            html += '<input type="text" class="form-control" onchange="updateNestedField(\'' + section + 'Findings.objectiveFindings.handGripStrength.rightPinchGrip\', this.value)" placeholder="e.g., 8">';
            
            html += '<label class="flex items-center">Lateral Pinch</label>';
            html += '<input type="text" class="form-control" onchange="updateNestedField(\'' + section + 'Findings.objectiveFindings.handGripStrength.leftLateralPinch\', this.value)" placeholder="e.g., 10">';
            html += '<input type="text" class="form-control" onchange="updateNestedField(\'' + section + 'Findings.objectiveFindings.handGripStrength.rightLateralPinch\', this.value)" placeholder="e.g., 10">';
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Wrist Hand Grip Strength (only hand grip, no pinch)
        function generateWristHandGripFields(section) {
            var container = document.getElementById(section + 'HandGripFields');
            if (!container) return;
            
            var html = '';
            html += '<div class="grid-3">';
            html += '<div class="text-center font-medium">Test Type</div>';
            html += '<div class="text-center font-medium">Left (kgf)</div>';
            html += '<div class="text-center font-medium">Right (kgf)</div>';
            
            html += '<label class="flex items-center">Hand Grip</label>';
            html += '<input type="text" class="form-control" onchange="updateNestedField(\'' + section + 'Findings.objectiveFindings.handGripStrength.leftHandGrip\', this.value)" placeholder="e.g., 25">';
            html += '<input type="text" class="form-control" onchange="updateNestedField(\'' + section + 'Findings.objectiveFindings.handGripStrength.rightHandGrip\', this.value)" placeholder="e.g., 28">';
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Other Symptoms Functions
        function addOtherSymptom(section) {
            if (!reportData[section + 'Findings'].complaints.otherSymptoms) {
                reportData[section + 'Findings'].complaints.otherSymptoms = [];
            }
            
            reportData[section + 'Findings'].complaints.otherSymptoms.push({
                symptom: '',
                intensity: ''
            });
            
            renderOtherSymptoms(section);
        }

        function renderOtherSymptoms(section) {
            var container = document.getElementById(section + 'OtherSymptomsContainer');
            var symptoms = reportData[section + 'Findings'].complaints.otherSymptoms;
            
            if (!symptoms || symptoms.length === 0) {
                // Initialize with one empty symptom
                reportData[section + 'Findings'].complaints.otherSymptoms = [{ symptom: '', intensity: '' }];
                symptoms = reportData[section + 'Findings'].complaints.otherSymptoms;
            }
            
            var html = '';
            symptoms.forEach(function(symptom, index) {
                html += '<div class="grid-3" style="margin-bottom: 10px;">';
                html += '<div class="form-group">';
                html += '<label>Other symptoms (if any):</label>';
                html += '<input type="text" class="form-control auto-lowercase-first-word" value="' + (symptom.symptom || '') + '" onchange="updateOtherSymptom(\'' + section + '\', ' + index + ', \'symptom\', this.value)" placeholder="e.g., tingling, numbness">';
                html += '</div>';
                html += '<div class="form-group">';
                html += '<label>Other symptoms intensity (if applicable):</label>';
                html += '<input type="text" class="form-control" value="' + (symptom.intensity || '') + '" onchange="updateOtherSymptom(\'' + section + '\', ' + index + ', \'intensity\', this.value)" placeholder="e.g., 5 or 4-6">';
                html += '</div>';
                html += '<div class="form-group" style="display: flex; align-items: end;">';
                if (symptoms.length > 1) {
                    html += '<button type="button" class="btn btn-danger btn-small" onclick="removeOtherSymptom(\'' + section + '\', ' + index + ')">Remove</button>';
                }
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function updateOtherSymptom(section, index, field, value) {
            if (!reportData[section + 'Findings'].complaints.otherSymptoms[index]) {
                reportData[section + 'Findings'].complaints.otherSymptoms[index] = { symptom: '', intensity: '' };
            }
            // Store the value directly - normalization is handled by input event listener
            reportData[section + 'Findings'].complaints.otherSymptoms[index][field] = value;
        }

        // Auto-lowercase first word normalization function
        function normalizeFirstWordLowercase(value) {
            if (!value || typeof value !== 'string') return value;
            return value.charAt(0).toLowerCase() + value.slice(1);
        }

        // Simplified function - normalization is now handled by input event listener
        function updateNestedFieldWithNormalization(path, value) {
            // Just call the original updateNestedField function
            updateNestedField(path, value);
        }

        function removeOtherSymptom(section, index) {
            reportData[section + 'Findings'].complaints.otherSymptoms.splice(index, 1);
            renderOtherSymptoms(section);
        }

        // Activity Functions
        function addActivity1(section) {
            if (!reportData[section + 'Findings'].complaints.activities1) {
                reportData[section + 'Findings'].complaints.activities1 = [];
            }
            
            reportData[section + 'Findings'].complaints.activities1.push({
                activity: '',
                duration: '',
                unit: 'minutes'
            });
            
            renderActivities1(section);
        }

        function renderActivities1(section) {
            var container = document.getElementById(section + 'Activities1Container');
            var activities = reportData[section + 'Findings'].complaints.activities1;
            
            var html = '';
            activities.forEach(function(activity, index) {
                html += '<div class="activity-item">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                html += '<span>Activity ' + (index + 1) + '</span>';
                if (activities.length > 1) {
                    html += '<button type="button" class="btn btn-secondary btn-small" onclick="removeActivity1(\'' + section + '\', ' + index + ')">Remove</button>';
                }
                html += '</div>';
                
                html += '<div class="grid-3">';
                html += '<div class="form-group">';
                html += '<label>Activity Type</label>';
                html += '<select class="form-control" onchange="updateActivity1Type(\'' + section + '\', ' + index + ', this.value)">';
                html += '<option value="">Select activity</option>';
                html += '<option value="reading"' + (activity.activity === 'reading' ? ' selected' : '') + '>Reading</option>';
                html += '<option value="sitting"' + (activity.activity === 'sitting' ? ' selected' : '') + '>Sitting</option>';
                html += '</select>';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Duration</label>';
                html += '<input type="text" class="form-control" value="' + (activity.duration || '') + '" ';
                html += 'onchange="updateActivity1Duration(\'' + section + '\', ' + index + ', this.value)" placeholder="e.g., 30">';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Unit</label>';
                html += '<select class="form-control" onchange="updateActivity1Unit(\'' + section + '\', ' + index + ', this.value)">';
                html += '<option value="minutes"' + (activity.unit === 'minutes' ? ' selected' : '') + '>Minutes</option>';
                html += '<option value="hours"' + (activity.unit === 'hours' ? ' selected' : '') + '>Hours</option>';
                html += '</select>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function removeActivity1(section, index) {
            reportData[section + 'Findings'].complaints.activities1.splice(index, 1);
            renderActivities1(section);
        }

        function updateActivity1Type(section, index, value) {
            if (reportData[section + 'Findings'].complaints.activities1[index]) {
                reportData[section + 'Findings'].complaints.activities1[index].activity = value;
            }
        }

        function updateActivity1Duration(section, index, value) {
            if (reportData[section + 'Findings'].complaints.activities1[index]) {
                reportData[section + 'Findings'].complaints.activities1[index].duration = value;
            }
        }

        function updateActivity1Unit(section, index, value) {
            if (reportData[section + 'Findings'].complaints.activities1[index]) {
                reportData[section + 'Findings'].complaints.activities1[index].unit = value;
            }
        }

        function addActivity2(section) {
            if (!reportData[section + 'Findings'].complaints.activities2) {
                reportData[section + 'Findings'].complaints.activities2 = [];
            }
            
            reportData[section + 'Findings'].complaints.activities2.push({
                activity: '',
                duration: '',
                unit: 'minutes',
                aid: 'unaided'
            });
            
            renderActivities2(section);
        }

        function renderActivities2(section) {
            var container = document.getElementById(section + 'Activities2Container');
            var activities = reportData[section + 'Findings'].complaints.activities2;
            
            var html = '';
            activities.forEach(function(activity, index) {
                html += '<div class="activity-item">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                html += '<span>Activity ' + (index + 1) + '</span>';
                if (activities.length > 1) {
                    html += '<button type="button" class="btn btn-secondary btn-small" onclick="removeActivity2(\'' + section + '\', ' + index + ')">Remove</button>';
                }
                html += '</div>';
                
                html += '<div class="grid-2">';
                html += '<div class="form-group">';
                html += '<label>Activity Type</label>';
                html += '<select class="form-control" onchange="updateActivity2Type(\'' + section + '\', ' + index + ', this.value)">';
                html += '<option value="">Select activity</option>';
                html += '<option value="walking"' + (activity.activity === 'walking' ? ' selected' : '') + '>Walking</option>';
                html += '<option value="standing"' + (activity.activity === 'standing' ? ' selected' : '') + '>Standing</option>';
                html += '</select>';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Duration</label>';
                html += '<input type="text" class="form-control" value="' + (activity.duration || '') + '" ';
                html += 'onchange="updateActivity2Duration(\'' + section + '\', ' + index + ', this.value)" placeholder="e.g., 30">';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Unit</label>';
                html += '<select class="form-control" onchange="updateActivity2Unit(\'' + section + '\', ' + index + ', this.value)">';
                html += '<option value="minutes"' + (activity.unit === 'minutes' ? ' selected' : '') + '>Minutes</option>';
                html += '<option value="hours"' + (activity.unit === 'hours' ? ' selected' : '') + '>Hours</option>';
                html += '</select>';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Aid</label>';
                html += '<select class="form-control" onchange="updateActivity2Aid(\'' + section + '\', ' + index + ', this.value)">';
                html += '<option value="unaided"' + (activity.aid === 'unaided' ? ' selected' : '') + '>Unaided</option>';
                html += '<option value="stick"' + (activity.aid === 'stick' ? ' selected' : '') + '>Stick</option>';
                html += '<option value="quadruped"' + (activity.aid === 'quadruped' ? ' selected' : '') + '>Quadruped</option>';
                html += '<option value="frame"' + (activity.aid === 'frame' ? ' selected' : '') + '>Frame</option>';
                html += '<option value="elbow crutches"' + (activity.aid === 'elbow crutches' ? ' selected' : '') + '>Elbow Crutches</option>';
                html += '<option value="rollator"' + (activity.aid === 'rollator' ? ' selected' : '') + '>Rollator</option>';
                html += '</select>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function removeActivity2(section, index) {
            reportData[section + 'Findings'].complaints.activities2.splice(index, 1);
            renderActivities2(section);
        }

        function updateActivity2Type(section, index, value) {
            if (reportData[section + 'Findings'].complaints.activities2[index]) {
                reportData[section + 'Findings'].complaints.activities2[index].activity = value;
            }
        }

        function updateActivity2Duration(section, index, value) {
            if (reportData[section + 'Findings'].complaints.activities2[index]) {
                reportData[section + 'Findings'].complaints.activities2[index].duration = value;
            }
        }

        function updateActivity2Unit(section, index, value) {
            if (reportData[section + 'Findings'].complaints.activities2[index]) {
                reportData[section + 'Findings'].complaints.activities2[index].unit = value;
            }
        }

        function updateActivity2Aid(section, index, value) {
            if (reportData[section + 'Findings'].complaints.activities2[index]) {
                reportData[section + 'Findings'].complaints.activities2[index].aid = value;
            }
        }

        // Toggle additional fields
        function toggleAdditionalField(section, fieldType, checked) {
            var fieldsContainer = document.getElementById(section + fieldType.charAt(0).toUpperCase() + fieldType.slice(1) + 'Fields');
            if (fieldsContainer) {
                if (checked) {
                    fieldsContainer.classList.remove('hidden');
                } else {
                    fieldsContainer.classList.add('hidden');
                }
            }
            
            // Update data structure
            if (fieldType === 'splintBraceCast') {
                reportData[section + 'Findings'].objectiveFindings.splintBraceCastInclude = checked;
            } else if (fieldType === 'tenderness') {
                reportData[section + 'Findings'].objectiveFindings.tendernessInclude = checked;
            } else if (fieldType === 'swelling') {
                reportData[section + 'Findings'].objectiveFindings.swellingInclude = checked;
            } else if (fieldType === 'temperature') {
                reportData[section + 'Findings'].objectiveFindings.temperatureInclude = checked;
            } else if (fieldType === 'sensation') {
                reportData[section + 'Findings'].objectiveFindings.sensationInclude = checked;
            } else if (fieldType === 'reflex') {
                reportData[section + 'Findings'].objectiveFindings.reflexInclude = checked;
            } else if (fieldType === 'weightBearing') {
                reportData[section + 'Findings'].objectiveFindings.wbStatusInclude = checked;
            }
        }

        // Sensation status update
        function updateSensationStatus(section, status) {
            reportData[section + 'Findings'].objectiveFindings.sensationStatus = status;
            
            var reducedFields = document.getElementById(section + 'SensationReducedFields');
            var hypersensitiveFields = document.getElementById(section + 'SensationHypersensitiveFields');
            
            if (reducedFields && hypersensitiveFields) {
                if (status === 'reduced') {
                    reducedFields.classList.remove('hidden');
                    hypersensitiveFields.classList.add('hidden');
                } else if (status === 'hypersensitive') {
                    reducedFields.classList.add('hidden');
                    hypersensitiveFields.classList.remove('hidden');
                } else {
                    reducedFields.classList.add('hidden');
                    hypersensitiveFields.classList.add('hidden');
                }
            }
        }

        // Special Tests Implementation
        function addSpecialTest(section) {
            if (!reportData[section + 'Findings'].objectiveFindings.specialTests) {
                reportData[section + 'Findings'].objectiveFindings.specialTests = [];
            }
            
            reportData[section + 'Findings'].objectiveFindings.specialTests.push({
                testName: '',
                testType: 'other',
                result: '',
                leftResult: '',
                rightResult: ''
            });
            
            renderSpecialTests(section);
        }

        function renderSpecialTests(section) {
            var container = document.getElementById(section + 'SpecialTestsContainer');
            var specialTests = reportData[section + 'Findings'].objectiveFindings.specialTests;
            
            var html = '';
            specialTests.forEach(function(test, index) {
                html += '<div class="assessment-row" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 6px;">';
                
                // Test type dropdown
                html += '<div class="form-group">';
                html += '<label style="font-size: 14px; font-weight: 500;">Test Type:</label>';
                html += '<select class="form-control" onchange="updateSpecialTestType(\'' + section + '\', ' + index + ', this.value)">';
                html += '<option value="other"' + (test.testType === 'other' || !test.testType ? ' selected' : '') + '>Other test</option>';
                html += '<option value="straight_leg_raise"' + (test.testType === 'straight_leg_raise' ? ' selected' : '') + '>Straight leg raise</option>';
                html += '</select>';
                html += '</div>';
                
                if (test.testType === 'straight_leg_raise') {
                    // Straight leg raise - bilateral results
                    html += '<div class="grid-2" style="gap: 15px;">';
                    html += '<div class="form-group">';
                    html += '<label style="font-size: 14px;">Left Result:</label>';
                    html += '<select class="form-control" onchange="updateSpecialTestLeftResult(\'' + section + '\', ' + index + ', this.value)">';
                    html += '<option value="">Select result</option>';
                    html += '<option value="positive"' + (test.leftResult === 'positive' ? ' selected' : '') + '>Positive</option>';
                    html += '<option value="negative"' + (test.leftResult === 'negative' ? ' selected' : '') + '>Negative</option>';
                    html += '</select>';
                    html += '</div>';
                    html += '<div class="form-group">';
                    html += '<label style="font-size: 14px;">Right Result:</label>';
                    html += '<select class="form-control" onchange="updateSpecialTestRightResult(\'' + section + '\', ' + index + ', this.value)">';
                    html += '<option value="">Select result</option>';
                    html += '<option value="positive"' + (test.rightResult === 'positive' ? ' selected' : '') + '>Positive</option>';
                    html += '<option value="negative"' + (test.rightResult === 'negative' ? ' selected' : '') + '>Negative</option>';
                    html += '</select>';
                    html += '</div>';
                    html += '</div>';
                } else {
                    // Other test - free text input
                    html += '<div class="grid-2" style="gap: 15px;">';
                    html += '<div class="form-group">';
                    html += '<label style="font-size: 14px;">Test Name:</label>';
                    html += '<input type="text" class="form-control" placeholder="Test Name (e.g., Phalen\'s test)" value="' + (test.testName || '') + '" ';
                    html += 'onchange="updateSpecialTestName(\'' + section + '\', ' + index + ', this.value)">';
                    html += '</div>';
                    html += '<div class="form-group">';
                    html += '<label style="font-size: 14px;">Result:</label>';
                    html += '<select class="form-control" onchange="updateSpecialTestResult(\'' + section + '\', ' + index + ', this.value)">';
                    html += '<option value="">Select Result</option>';
                    html += '<option value="positive"' + (test.result === 'positive' ? ' selected' : '') + '>Positive</option>';
                    html += '<option value="negative"' + (test.result === 'negative' ? ' selected' : '') + '>Negative</option>';
                    html += '</select>';
                    html += '</div>';
                    html += '</div>';
                    html += '<p style="font-size: 12px; color: #666; margin-top: 5px;">Type full name of the test, e.g. straight leg raise</p>';
                }
                
                html += '<div style="text-align: right; margin-top: 10px;">';
                html += '<button type="button" class="btn btn-secondary btn-small" onclick="removeSpecialTest(\'' + section + '\', ' + index + ')">Remove</button>';
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function updateSpecialTestType(section, index, value) {
            if (reportData[section + 'Findings'].objectiveFindings.specialTests[index]) {
                var test = reportData[section + 'Findings'].objectiveFindings.specialTests[index];
                test.testType = value;
                
                if (value === 'straight_leg_raise') {
                    test.testName = 'Straight leg raise';
                    test.result = '';
                    test.leftResult = test.leftResult || '';
                    test.rightResult = test.rightResult || '';
                } else {
                    test.testName = test.testName || '';
                    test.result = test.result || '';
                    test.leftResult = '';
                    test.rightResult = '';
                }
                
                renderSpecialTests(section);
            }
        }

        function updateSpecialTestName(section, index, value) {
            if (reportData[section + 'Findings'].objectiveFindings.specialTests[index]) {
                reportData[section + 'Findings'].objectiveFindings.specialTests[index].testName = value;
            }
        }

        function updateSpecialTestResult(section, index, value) {
            if (reportData[section + 'Findings'].objectiveFindings.specialTests[index]) {
                reportData[section + 'Findings'].objectiveFindings.specialTests[index].result = value;
            }
        }

        function updateSpecialTestLeftResult(section, index, value) {
            if (reportData[section + 'Findings'].objectiveFindings.specialTests[index]) {
                reportData[section + 'Findings'].objectiveFindings.specialTests[index].leftResult = value;
            }
        }

        function updateSpecialTestRightResult(section, index, value) {
            if (reportData[section + 'Findings'].objectiveFindings.specialTests[index]) {
                reportData[section + 'Findings'].objectiveFindings.specialTests[index].rightResult = value;
            }
        }

        function removeSpecialTest(section, index) {
            reportData[section + 'Findings'].objectiveFindings.specialTests.splice(index, 1);
            renderSpecialTests(section);
        }

        // Questionnaire options update
        function updateQuestionnaireOptions(section, location) {
            var questionnaires = getQuestionnairesByLocation(location);
            var select = document.getElementById(section + 'Questionnaire');
            if (!select) return;
            
            var html = '<option value="">Select Questionnaire</option>';
            questionnaires.forEach(function(questionnaire) {
                html += '<option value="' + questionnaire + '">' + questionnaire + '</option>';
            });
            
            select.innerHTML = html;
        }

        // Toggle "Not tested" functionality
        function toggleNotTested(section, fieldType, checked) {
            var containers = {
                'arom': section + 'AromFields',
                'musclePower': section + 'MusclePowerFields',
                'myotome': section + 'MyotomeFields',
                'handGrip': section + 'HandGripFields'
            };
            
            var container = document.getElementById(containers[fieldType]);
            if (container) {
                if (checked) {
                    container.style.display = 'none';
                } else {
                    container.style.display = 'block';
                }
            }
            
            // Special logic for wrist region: when muscle power is not tested, also hide hand grip
            if (fieldType === 'musclePower') {
                var location = reportData[section + 'Findings'].complaints.location;
                if (location === 'wrist') {
                    var handGripContainer = document.getElementById(section + 'HandGripFields');
                    if (handGripContainer) {
                        if (checked) {
                            handGripContainer.style.display = 'none';
                        } else {
                            handGripContainer.style.display = 'block';
                        }
                    }
                }
            }
            
            // Update data structure
            if (fieldType === 'arom') {
                reportData[section + 'Findings'].objectiveFindings.aromNotTested = checked;
            } else if (fieldType === 'musclePower') {
                reportData[section + 'Findings'].objectiveFindings.musclePowerNotTested = checked;
            } else if (fieldType === 'handGrip') {
                reportData[section + 'Findings'].objectiveFindings.handGripNotTested = checked;
            }
        }

        // Enhanced copy functionality
        function copyFromInitial(targetSection) {
            if (targetSection === 'interim') {
                reportData.interimFindings = JSON.parse(JSON.stringify(reportData.initialFindings));
                reportData.interimFindings.date = getCurrentDate();
                populateInterimFields();
                regenerateAllFields('interim');
            } else if (targetSection === 'final') {
                reportData.finalFindings = JSON.parse(JSON.stringify(reportData.initialFindings));
                reportData.finalFindings.date = getCurrentDate();
                populateFinalFields();
                regenerateAllFields('final');
            }
        }

        function copyFromInterim(targetSection) {
            if (targetSection === 'final') {
                reportData.finalFindings = JSON.parse(JSON.stringify(reportData.interimFindings));
                reportData.finalFindings.date = getCurrentDate();
                populateFinalFields();
                regenerateAllFields('final');
            }
        }

        function regenerateAllFields(section) {
            var location = reportData[section + 'Findings'].complaints.location;
            var side = reportData[section + 'Findings'].complaints.side;
            
            if (location) {
                generateClinicalFields(section, location, side);
                populateGeneratedFields(section);
            }
        }

        // Populate interim fields after copying
        function populateInterimFields() {
            var interimData = reportData.interimFindings;
            if (!interimData) return;
            
            // Populate basic fields with null checks
            var interimDate = document.getElementById('interimDate');
            if (interimDate) interimDate.value = interimData.date || '';
            
            var interimSide = document.getElementById('interimComplaintsSide');
            if (interimSide) interimSide.value = interimData.complaints.side || '';
            
            var interimRegion = document.getElementById('interimPainRegion');
            if (interimRegion) interimRegion.value = interimData.complaints.location || '';
            
            var interimIntensity = document.getElementById('interimPainIntensity');
            if (interimIntensity) interimIntensity.value = interimData.complaints.painIntensity || '';
            
            var interimActivities = document.getElementById('interimOtherFunctionalLimitation');
            if (interimActivities) interimActivities.value = interimData.complaints.otherFunctionalLimitation || '';
            
            var interimImprovement = document.getElementById('interimImprovement');
            if (interimImprovement) interimImprovement.value = interimData.complaints.overallImprovement || '';
            
            // Render dynamic fields
            renderActivities1('interim');
            renderActivities2('interim');
            renderOtherSymptoms('interim');
        }

        // Populate final fields after copying
        function populateFinalFields() {
            var finalData = reportData.finalFindings;
            if (!finalData) return;
            
            // Populate basic fields with null checks
            var finalDate = document.getElementById('finalDate');
            if (finalDate) finalDate.value = finalData.date || '';
            
            var finalSide = document.getElementById('finalComplaintsSide');
            if (finalSide) finalSide.value = finalData.complaints.side || '';
            
            var finalRegion = document.getElementById('finalPainRegion');
            if (finalRegion) finalRegion.value = finalData.complaints.location || '';
            
            var finalIntensity = document.getElementById('finalPainIntensity');
            if (finalIntensity) finalIntensity.value = finalData.complaints.painIntensity || '';
            
            var finalActivities = document.getElementById('finalOtherFunctionalLimitation');
            if (finalActivities) finalActivities.value = finalData.complaints.otherFunctionalLimitation || '';
            
            var finalImprovement = document.getElementById('finalImprovement');
            if (finalImprovement) finalImprovement.value = finalData.complaints.overallImprovement || '';
            
            // Render dynamic fields
            renderActivities1('final');
            renderActivities2('final');
            renderOtherSymptoms('final');
        }

        // Dynamic discharge fields
        function updateDischargeType(dischargeType) {
            reportData.dischargeSummary.componentData.dischargeType = dischargeType;
            
            var fieldsContainer = document.getElementById('dischargeFields');
            var html = '';
            
            switch (dischargeType) {
                case 'Discharged':
                case 'Discharged with static progress':
                    html += '<div class="form-group">';
                    html += '<label>Discharge Date:</label>';
                    html += '<input type="date" class="form-control" onchange="updateNestedField(\'dischargeSummary.componentData.dischargeDate\', this.value)">';
                    html += '</div>';
                    break;
                case 'Still receiving physiotherapy':
                    // No additional date fields needed for "Still receiving physiotherapy"
                    break;
                case 'Defaulted':
                    html += '<div class="form-group">';
                    html += '<label>Default Date (since last scheduled appointment date):</label>';
                    html += '<input type="date" class="form-control" onchange="updateNestedField(\'dischargeSummary.componentData.defaultDate\', this.value)">';
                    html += '</div>';
                    break;
                case 'Cancelled':
                    html += '<div class="form-group">';
                    html += '<label>Cancellation Date:</label>';
                    html += '<input type="date" class="form-control" onchange="updateNestedField(\'dischargeSummary.componentData.cancellationDate\', this.value)">';
                    html += '</div>';
                    html += '<div class="form-group">';
                    html += '<label>Last Scheduled Appointment Date:</label>';
                    html += '<input type="date" class="form-control" onchange="updateNestedField(\'dischargeSummary.componentData.scheduledAppointmentDate\', this.value)">';
                    html += '</div>';
                    html += '<div class="form-group">';
                    html += '<label>Cancellation Reason:</label>';
                    html += '<textarea class="form-control" onchange="updateNestedField(\'dischargeSummary.componentData.cancellationReason\', this.value)"></textarea>';
                    html += '</div>';
                    break;
            }
            
            fieldsContainer.innerHTML = html;
        }

        // Event handlers for complaints and pain region changes
        function updateComplaintsSide(section, side) {
            updateNestedField(section + 'Findings.complaints.side', side);
            var location = reportData[section + 'Findings'].complaints.location;
            if (location) {
                generateClinicalFields(section, location, side);
            }
        }



        // Referral Source Functions
        function addReferralSource() {
            if (!reportData.referralSources) {
                reportData.referralSources = [];
            }
            
            reportData.referralSources.push({
                episode: getEpisodeNumber(reportData.referralSources.length),
                department: '',
                hospital: ''
            });
            
            renderReferralSources();
        }
        
        function removeReferralSource(index) {
            reportData.referralSources.splice(index, 1);
            renderReferralSources();
        }
        
        function updateReferralSource(index, field, value) {
            if (reportData.referralSources[index]) {
                reportData.referralSources[index][field] = value;
            }
        }
        
        function getEpisodeNumber(index) {
            var episodes = ['First', 'Second', 'Third', 'Fourth', 'Fifth'];
            return episodes[index] || (index + 1) + 'th';
        }
        
        function renderReferralSources() {
            var container = document.getElementById('referralSourcesContainer');
            if (!container) return;
            
            var html = '';
            if (!reportData.referralSources || reportData.referralSources.length === 0) {
                reportData.referralSources = [{
                    episode: 'First',
                    department: '',
                    hospital: ''
                }];
            }
            
            reportData.referralSources.forEach(function(source, index) {
                html += '<div style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; margin-bottom: 10px;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
                html += '<h6 style="font-weight: 600; margin: 0;">' + source.episode + ' Referral</h6>';
                if (reportData.referralSources.length > 1) {
                    html += '<button type="button" class="btn btn-secondary btn-small" onclick="removeReferralSource(' + index + ')">Remove</button>';
                }
                html += '</div>';
                
                html += '<div class="grid-2">';
                html += '<div class="form-group">';
                html += '<label>Department:</label>';
                html += '<input type="text" class="form-control" value="' + (source.department || '') + '" ';
                html += 'onchange="updateReferralSource(' + index + ', \'department\', this.value)" ';
                html += 'placeholder="e.g., Department of Orthopedics and Traumatology">';
                html += '</div>';
                
                html += '<div class="form-group">';
                html += '<label>Hospital:</label>';
                html += '<input type="text" class="form-control" value="' + (source.hospital || '') + '" ';
                html += 'onchange="updateReferralSource(' + index + ', \'hospital\', this.value)" ';
                html += 'placeholder="e.g., Tuen Mun Hospital">';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        // Utility functions
        function updateField(fieldName, value) {
            reportData[fieldName] = value;
        }

        function updateNestedField(fieldPath, value) {
            var keys = fieldPath.split('.');
            var obj = reportData;
            
            for (var i = 0; i < keys.length - 1; i++) {
                if (!obj[keys[i]]) {
                    obj[keys[i]] = {};
                }
                obj = obj[keys[i]];
            }
            
            obj[keys[keys.length - 1]] = value;
        }

        // Update nested field with automatic percentage validation
        function updateNestedFieldWithPercentage(fieldPath, value) {
            // Auto-add % sign if only numbers are detected
            if (value && /^\d+$/.test(value.trim())) {
                value = value.trim() + '%';
                // Update the input field to show the % sign if event is available
                if (typeof event !== 'undefined' && event.target) {
                    event.target.value = value;
                }
            }
            
            // Call the original updateNestedField function
            updateNestedField(fieldPath, value);
        }

        function updateTreatmentMethod(treatment, checked) {
            var treatments = reportData.treatments;
            var existingIndex = -1;
            
            for (var i = 0; i < treatments.length; i++) {
                if (treatments[i].method === treatment) {
                    existingIndex = i;
                    break;
                }
            }
            
            if (checked && existingIndex === -1) {
                treatments.push({
                    method: treatment,
                    area: ''
                });
            } else if (!checked && existingIndex !== -1) {
                treatments.splice(existingIndex, 1);
            }
        }

        function showSection(sectionNumber) {
            var sections = document.getElementsByClassName('section');
            for (var i = 0; i < sections.length; i++) {
                sections[i].classList.remove('active');
            }
            
            var tabs = document.getElementsByClassName('nav-tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            document.getElementById('section' + sectionNumber).classList.add('active');
            tabs[sectionNumber - 1].classList.add('active');
        }

        function showClinicalTab(tabName) {
            var contents = document.getElementsByClassName('clinical-content');
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            
            var tabs = document.getElementsByClassName('clinical-tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            document.getElementById(tabName + 'Clinical').classList.add('active');
            
            var targetTab = document.querySelector('[onclick="showClinicalTab(\'' + tabName + '\')"]');
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }

        // Enhanced navigation functions
        function showClinicalTabAndScroll(tabName) {
            showClinicalTab(tabName);
            setTimeout(function() {
                var element = document.getElementById(tabName + 'Complaints');
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }
        
        function toggleInterimSection(enabled) {
            var interimTab = document.getElementById('interimTab');
            var interimContent = document.getElementById('interimClinicalContent');
            
            if (enabled) {
                interimTab.style.display = 'inline-block';
                if (interimContent) {
                    interimContent.style.display = 'block';
                }
            } else {
                interimTab.style.display = 'none';
                if (interimContent) {
                    interimContent.style.display = 'none';
                }
                // Switch to initial tab if interim was active
                var activeTab = document.querySelector('.clinical-tab.active');
                if (activeTab && activeTab.id === 'interimTab') {
                    showClinicalTab('initial');
                }
            }
        }

        function toggleCollapse(contentId) {
            var content = document.getElementById(contentId);
            var icon = document.getElementById(contentId.replace('Content', 'CollapseIcon'));
            
            if (content && icon) {
                if (content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon.textContent = '';
                } else {
                    content.classList.add('collapsed');
                    icon.textContent = '+';
                }
            }
        }

        // Quick navigation function
        function scrollToSection(sectionId) {
            var element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function getCurrentDate() {
            var today = new Date();
            var year = today.getFullYear();
            var month = String(today.getMonth() + 1).padStart(2, '0');
            var day = String(today.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }





        function populateGeneratedFields(section) {
            // Populate AROM fields
            var aromData = reportData[section + 'Findings'].objectiveFindings.aromMovements;
            if (aromData) {
                aromData.forEach(function(arom, index) {
                    var inputs = document.querySelectorAll('#' + section + 'AromFields input');
                    if (inputs[index]) {
                        inputs[index].value = arom.arom || '';
                    }
                });
            }
            
            // Populate muscle power fields
            var musclePowerData = reportData[section + 'Findings'].objectiveFindings.musclePower;
            if (musclePowerData) {
                musclePowerData.forEach(function(muscle, index) {
                    var rows = document.querySelectorAll('#' + section + 'MusclePowerFields .assessment-row');
                    if (rows[index]) {
                        var leftSelect = rows[index].querySelector('.left-grade');
                        var rightSelect = rows[index].querySelector('.right-grade');
                        if (leftSelect) leftSelect.value = muscle.leftGrade || '';
                        if (rightSelect) rightSelect.value = muscle.rightGrade || '';
                    }
                });
            }
            
            // Populate myotome fields
            var myotomeData = reportData[section + 'Findings'].objectiveFindings.myotome;
            if (myotomeData) {
                myotomeData.forEach(function(myotome, index) {
                    var selects = document.querySelectorAll('#' + section + 'MyotomeFields .assessment-row:nth-child(' + (index + 1) + ') select');
                    if (selects[0]) selects[0].value = myotome.leftGrade || '';
                    if (selects[1]) selects[1].value = myotome.rightGrade || '';
                });
            }
            
            // Populate hand grip strength fields
            var handGripData = reportData[section + 'Findings'].objectiveFindings.handGripStrength;
            if (handGripData) {
                var handGripInputs = document.querySelectorAll('#' + section + 'HandGripFields input');
                if (handGripInputs[0]) handGripInputs[0].value = handGripData.leftHandGrip || '';
                if (handGripInputs[1]) handGripInputs[1].value = handGripData.rightHandGrip || '';
                if (handGripInputs[2]) handGripInputs[2].value = handGripData.leftPinchGrip || '';
                if (handGripInputs[3]) handGripInputs[3].value = handGripData.rightPinchGrip || '';
                if (handGripInputs[4]) handGripInputs[4].value = handGripData.leftLateralPinch || '';
                if (handGripInputs[5]) handGripInputs[5].value = handGripData.rightLateralPinch || '';
            }
            
            // Populate toes ROM field (for ankle)
            var toesROMData = reportData[section + 'Findings'].objectiveFindings.toesROM;
            if (toesROMData) {
                var toesROMInput = document.querySelector('#' + section + 'ToesRomContainer input');
                if (toesROMInput) toesROMInput.value = toesROMData;
            }
            
            // Populate gross fingers ROM field (for wrist)
            var grossFingersROMData = reportData[section + 'Findings'].objectiveFindings.grossFingersROM;
            if (grossFingersROMData) {
                var grossFingersROMInput = document.querySelector('#' + section + 'GrossFingersRomContainer input');
                if (grossFingersROMInput) grossFingersROMInput.value = grossFingersROMData;
            }
            
            // Populate additional objective findings
            var objectiveData = reportData[section + 'Findings'].objectiveFindings;
            
            // Tenderness
            var tendernessCheckbox = document.getElementById(section + 'Tenderness');
            if (tendernessCheckbox) tendernessCheckbox.checked = objectiveData.tendernessInclude || false;
            var tendernessArea = document.querySelector('#' + section + 'TendernessFields input');
            if (tendernessArea) tendernessArea.value = objectiveData.tendernessArea || '';
            
            // Swelling
            var swellingCheckbox = document.getElementById(section + 'Swelling');
            if (swellingCheckbox) swellingCheckbox.checked = objectiveData.swellingInclude || false;
            var swellingRadios = document.querySelectorAll('input[name="' + section + 'SwellingPresent"]');
            swellingRadios.forEach(function(radio) {
                if (radio.value === (objectiveData.swellingPresent ? 'true' : 'false')) {
                    radio.checked = true;
                }
            });
            
            // Temperature
            var temperatureCheckbox = document.getElementById(section + 'Temperature');
            if (temperatureCheckbox) temperatureCheckbox.checked = objectiveData.temperatureInclude || false;
            var temperatureRadios = document.querySelectorAll('input[name="' + section + 'TemperatureIncreased"]');
            temperatureRadios.forEach(function(radio) {
                if (radio.value === (objectiveData.temperatureIncreased ? 'true' : 'false')) {
                    radio.checked = true;
                }
            });
            
            // Sensation
            var sensationCheckbox = document.getElementById(section + 'Sensation');
            if (sensationCheckbox) sensationCheckbox.checked = objectiveData.sensationInclude || false;
            var sensationSelect = document.getElementById(section + 'SensationStatus');
            if (sensationSelect) {
                sensationSelect.value = objectiveData.sensationStatus || '';
                // Trigger sensation status change to show sub-fields
                updateSensationStatus(section, objectiveData.sensationStatus);
                
                // Populate sub-fields based on status
                setTimeout(function() {
                    if (objectiveData.sensationStatus === 'reduced') {
                        var reductionInput = document.querySelector('#' + section + 'SensationReducedFields input[onchange*="sensationReduction"]');
                        if (reductionInput) reductionInput.value = objectiveData.sensationReduction || '';
                        var areaReducedInput = document.querySelector('#' + section + 'SensationReducedFields input[onchange*="areaReduced"]');
                        if (areaReducedInput) areaReducedInput.value = objectiveData.areaReduced || '';
                    } else if (objectiveData.sensationStatus === 'hypersensitive') {
                        var areaHypersensitiveInput = document.querySelector('#' + section + 'SensationHypersensitiveFields input');
                        if (areaHypersensitiveInput) areaHypersensitiveInput.value = objectiveData.areaHypersensitive || '';
                    }
                }, 50);
            }
            
            // Reflex
            var reflexCheckbox = document.getElementById(section + 'Reflex');
            if (reflexCheckbox) reflexCheckbox.checked = objectiveData.reflexInclude || false;
            var reflexRadios = document.querySelectorAll('input[name="' + section + 'ReflexStatus"]');
            reflexRadios.forEach(function(radio) {
                if (radio.value === (objectiveData.reflexNormal ? 'true' : 'false')) {
                    radio.checked = true;
                }
            });
            
            // Walking Aid
            var walkingAidSelect = document.querySelector('#' + section + 'ObjectiveContainer select[onchange*="walkingAid"]');
            if (walkingAidSelect) walkingAidSelect.value = objectiveData.walkingAid || '';
            
            // Walking Stability
            var walkingStabilitySelect = document.querySelector('#' + section + 'ObjectiveContainer select[onchange*="walkingStability"]');
            if (walkingStabilitySelect) walkingStabilitySelect.value = objectiveData.walkingStability || '';
            
            // Weight Bearing Status
            var wbCheckbox = document.getElementById(section + 'WeightBearing');
            if (wbCheckbox) wbCheckbox.checked = objectiveData.wbStatusInclude || false;
            var wbSelect = document.querySelector('#' + section + 'WeightBearingFields select');
            if (wbSelect) wbSelect.value = objectiveData.wbStatus || '';
            
            // Trigger show/hide for additional fields and populate data with delay
            setTimeout(function() {
                // Splint/Brace/Cast checkbox and field
                var splintBraceCastCheckbox = document.getElementById(section + 'SplintBraceCast');
                if (splintBraceCastCheckbox) splintBraceCastCheckbox.checked = objectiveData.splintBraceCastInclude || false;
                
                if (objectiveData.splintBraceCastInclude) {
                    toggleAdditionalField(section, 'splintBraceCast', true);
                    setTimeout(function() {
                        var splintBraceCastType = document.querySelector('#' + section + 'SplintBraceCastFields input');
                        if (splintBraceCastType) splintBraceCastType.value = objectiveData.splintBraceCastType || '';
                    }, 10);
                }
                if (objectiveData.tendernessInclude) {
                    toggleAdditionalField(section, 'tenderness', true);
                    setTimeout(function() {
                        var tendernessArea = document.querySelector('#' + section + 'TendernessFields input');
                        if (tendernessArea) tendernessArea.value = objectiveData.tendernessArea || '';
                    }, 10);
                }
                if (objectiveData.swellingInclude) toggleAdditionalField(section, 'swelling', true);
                if (objectiveData.temperatureInclude) toggleAdditionalField(section, 'temperature', true);
                if (objectiveData.sensationInclude) toggleAdditionalField(section, 'sensation', true);
                if (objectiveData.reflexInclude) toggleAdditionalField(section, 'reflex', true);
                if (objectiveData.wbStatusInclude) {
                    toggleAdditionalField(section, 'weightBearing', true);
                    setTimeout(function() {
                        var wbSelect = document.querySelector('#' + section + 'WeightBearingFields select');
                        if (wbSelect) wbSelect.value = objectiveData.wbStatus || '';
                    }, 10);
                }
            }, 20);
            
            // Render fingers/toes and special tests
            var location = reportData[section + 'Findings'].complaints.location;
            if (location === 'hand' || location === 'foot') {
                renderFingersToesFields(section, location);
            }
            renderSpecialTests(section);
            
            // Populate questionnaire fields
            var questionnairesData = reportData[section + 'Findings'].objectiveFindings.questionnaires;
            if (questionnairesData && questionnairesData.length > 0) {
                var questionnaire = questionnairesData[0]; // Use first questionnaire
                var questionnaireSelect = document.getElementById(section + 'Questionnaire');
                if (questionnaireSelect) {
                    questionnaireSelect.value = questionnaire.name || '';
                    console.log('Populated questionnaire name:', questionnaire.name);
                }
                
                // Find questionnaire score input - it's in the same grid as the select
                var questionnaireScore = document.querySelector('#' + section + 'ObjectiveContainer input[onchange*="updateQuestionnaireField"][onchange*="score"]');
                if (questionnaireScore) {
                    questionnaireScore.value = questionnaire.score || '';
                    console.log('Populated questionnaire score:', questionnaire.score);
                } else {
                    // Alternative selector for questionnaire score
                    var scoreInputs = document.querySelectorAll('#' + section + 'ObjectiveContainer .grid-2 input[type="text"]');
                    scoreInputs.forEach(function(input) {
                        if (input.getAttribute('onchange') && input.getAttribute('onchange').includes('score')) {
                            input.value = questionnaire.score || '';
                            console.log('Populated questionnaire score (alternative):', questionnaire.score);
                        }
                    });
                }
            }
            
            // Populate AROM and Muscle Power not-tested checkboxes
            var aromNotTestedCheckbox = document.getElementById(section + 'AromNotTested');
            if (aromNotTestedCheckbox) aromNotTestedCheckbox.checked = objectiveData.aromNotTested || false;
            
            var musclePowerNotTestedCheckbox = document.getElementById(section + 'MusclePowerNotTested');
            if (musclePowerNotTestedCheckbox) musclePowerNotTestedCheckbox.checked = objectiveData.musclePowerNotTested || false;
            
            var handGripNotTestedCheckbox = document.getElementById(section + 'HandGripNotTested');
            if (handGripNotTestedCheckbox) handGripNotTestedCheckbox.checked = objectiveData.handGripNotTested || false;
            
            // Populate special tests
            var specialTestsData = reportData[section + 'Findings'].objectiveFindings.specialTests;
            if (specialTestsData && specialTestsData.length > 0) {
                specialTestsData.forEach(function(test, index) {
                    if (test.testType === 'straight_leg_raise') {
                        // Add straight leg raise test
                        addSpecialTest(section);
                        setTimeout(function() {
                            var testContainers = document.querySelectorAll('#' + section + 'SpecialTestsContainer .special-test-item');
                            var testContainer = testContainers[testContainers.length - 1];
                            if (testContainer) {
                                var typeSelect = testContainer.querySelector('select');
                                if (typeSelect) {
                                    typeSelect.value = 'straight_leg_raise';
                                    typeSelect.dispatchEvent(new Event('change'));
                                    
                                    setTimeout(function() {
                                        var leftSelect = testContainer.querySelector('select[onchange*="leftResult"]');
                                        var rightSelect = testContainer.querySelector('select[onchange*="rightResult"]');
                                        if (leftSelect) leftSelect.value = test.leftResult || '';
                                        if (rightSelect) rightSelect.value = test.rightResult || '';
                                    }, 10);
                                }
                            }
                        }, 10);
                    } else if (test.testType === 'other') {
                        // Add other test
                        addSpecialTest(section);
                        setTimeout(function() {
                            var testContainers = document.querySelectorAll('#' + section + 'SpecialTestsContainer .special-test-item');
                            var testContainer = testContainers[testContainers.length - 1];
                            if (testContainer) {
                                var typeSelect = testContainer.querySelector('select');
                                if (typeSelect) {
                                    typeSelect.value = 'other';
                                    typeSelect.dispatchEvent(new Event('change'));
                                    
                                    setTimeout(function() {
                                        var nameInput = testContainer.querySelector('input[onchange*="testName"]');
                                        var resultSelect = testContainer.querySelector('select[onchange*="result"]');
                                        if (nameInput) nameInput.value = test.testName || '';
                                        if (resultSelect) resultSelect.value = test.result || '';
                                    }, 10);
                                }
                            }
                        }, 10);
                    }
                });
            }
            
            // Populate fingers/toes data with proper joint names
            var fingersToesData = reportData[section + 'Findings'].objectiveFindings.fingersToesData;
            if (fingersToesData && fingersToesData.length > 0) {
                console.log('Populating fingers/toes data:', fingersToesData);
                
                // First ensure the fingers/toes fields are rendered
                var location = reportData[section + 'Findings'].complaints.location;
                if (location === 'hand' || location === 'foot') {
                    renderFingersToesFields(section, location);
                    
                    setTimeout(function() {
                        fingersToesData.forEach(function(fingerToe, fingerIndex) {
                            // Set finger/toe name
                            var nameInput = document.querySelector('#' + section + 'FingersToesFields .finger-toe-item:nth-child(' + (fingerIndex + 1) + ') input[onchange*="updateFingerToeName"]');
                            if (nameInput) {
                                nameInput.value = fingerToe.name || '';
                                nameInput.dispatchEvent(new Event('change'));
                            }
                            
                            if (fingerToe.joints && fingerToe.joints.length > 0) {
                                fingerToe.joints.forEach(function(joint) {
                                    // Find checkbox by joint type
                                    var checkboxes = document.querySelectorAll('#' + section + 'FingersToesFields .finger-toe-item:nth-child(' + (fingerIndex + 1) + ') input[type="checkbox"]');
                                    checkboxes.forEach(function(checkbox) {
                                        var onchangeAttr = checkbox.getAttribute('onchange');
                                        if (onchangeAttr && onchangeAttr.includes(joint.jointType)) {
                                            checkbox.checked = true;
                                            checkbox.dispatchEvent(new Event('change'));
                                            
                                            // Populate range after checkbox is checked
                                            setTimeout(function() {
                                                var rangeInputs = document.querySelectorAll('#' + section + 'FingersToesFields .finger-toe-item:nth-child(' + (fingerIndex + 1) + ') input[type="text"]');
                                                rangeInputs.forEach(function(rangeInput) {
                                                    var rangeOnchange = rangeInput.getAttribute('onchange');
                                                    if (rangeOnchange && rangeOnchange.includes(joint.jointType) && rangeOnchange.includes('range')) {
                                                        rangeInput.value = joint.range || '';
                                                        rangeInput.dispatchEvent(new Event('change'));
                                                        console.log('Populated joint range:', joint.jointType, joint.range);
                                                    }
                                                });
                                            }, 50);
                                        }
                                    });
                                });
                            }
                        });
                    }, 100);
                }
            }

            // Render other symptoms
            renderOtherSymptoms(section);
        }

        function generateDataString() {
            try {
                // Debug muscle power data before export
                console.log('=== MUSCLE POWER DEBUG ===');
                console.log('Initial muscle power:', reportData.initialFindings.objectiveFindings.musclePower);
                console.log('Interim muscle power:', reportData.interimFindings.objectiveFindings.musclePower);
                console.log('Final muscle power:', reportData.finalFindings.objectiveFindings.musclePower);
                
                // Check if muscle power has any valid entries
                var initialMP = reportData.initialFindings.objectiveFindings.musclePower;
                var hasValidMP = initialMP && initialMP.some(function(m) {
                    return m.leftGrade || m.rightGrade;
                });
                console.log('Has valid muscle power entries:', hasValidMP);
                
                if (initialMP && initialMP.length > 0) {
                    console.log('Muscle power entries:');
                    initialMP.forEach(function(entry, index) {
                        console.log('Entry ' + index + ':', {
                            muscleGroup: entry.muscleGroup,
                            leftGrade: entry.leftGrade,
                            rightGrade: entry.rightGrade,
                            leftGradeType: typeof entry.leftGrade,
                            rightGradeType: typeof entry.rightGrade
                        });
                    });
                }
                console.log('=== END MUSCLE POWER DEBUG ===');
                
                // Ensure muscle power data is in all sections before export
                ensureMusclePowerInAllSections();
                
                // Clean up muscle power arrays before export
                cleanupMusclePowerData();
                
                var dataString = JSON.stringify(reportData, null, 2);
                document.getElementById('exportOutput').value = dataString;
                alert('Data string generated successfully! All clinical assessment data is included and compatible with the full app.');
            } catch (error) {
                alert('Error generating data string: ' + error.message);
            }
        }
        
        // Ensure muscle power data exists in all sections
        function ensureMusclePowerInAllSections() {
            var initialMP = reportData.initialFindings.objectiveFindings.musclePower;
            
            // If initial has muscle power data but interim/final don't, copy it
            if (initialMP && initialMP.length > 0) {
                var hasValidInitialMP = initialMP.some(function(m) {
                    return m.muscleGroup && (m.leftGrade || m.rightGrade);
                });
                
                if (hasValidInitialMP) {
                    // Copy to interim if empty
                    var interimMP = reportData.interimFindings.objectiveFindings.musclePower;
                    if (!interimMP || interimMP.length === 0) {
                        reportData.interimFindings.objectiveFindings.musclePower = JSON.parse(JSON.stringify(initialMP));
                        console.log('Copied muscle power to interim findings');
                    }
                    
                    // Copy to final if empty
                    var finalMP = reportData.finalFindings.objectiveFindings.musclePower;
                    if (!finalMP || finalMP.length === 0) {
                        reportData.finalFindings.objectiveFindings.musclePower = JSON.parse(JSON.stringify(initialMP));
                        console.log('Copied muscle power to final findings');
                    }
                }
            }
        }
        
        // Clean up muscle power data to ensure compatibility
        function cleanupMusclePowerData() {
            ['initialFindings', 'interimFindings', 'finalFindings'].forEach(function(section) {
                var musclePower = reportData[section].objectiveFindings.musclePower;
                if (musclePower && Array.isArray(musclePower)) {
                    // Filter out entries with no muscle group or no grades
                    reportData[section].objectiveFindings.musclePower = musclePower.filter(function(entry) {
                        return entry.muscleGroup && (entry.leftGrade || entry.rightGrade);
                    });
                    
                    // Ensure all entries have proper structure
                    reportData[section].objectiveFindings.musclePower = reportData[section].objectiveFindings.musclePower.map(function(entry) {
                        return {
                            muscleGroup: entry.muscleGroup || '',
                            leftGrade: entry.leftGrade || '',
                            rightGrade: entry.rightGrade || '',
                            leftGrip: entry.leftGrip || undefined,
                            rightGrip: entry.rightGrip || undefined,
                            pinchGrip: entry.pinchGrip || undefined,
                            lateralPinch: entry.lateralPinch || undefined
                        };
                    });
                    
                    console.log('Cleaned ' + section + ' muscle power:', reportData[section].objectiveFindings.musclePower);
                }
            });
        }

        function copyDataString() {
            var output = document.getElementById('exportOutput');
            if (!output.value) {
                generateDataString();
            }
            
            output.select();
            document.execCommand('copy');
            alert('Data string copied to clipboard!');
        }

        // Corporate-friendly mock data functions
        function showMockDataOptions() {
            try {
                var mockDataOptions = document.getElementById('mockDataOptions');
                if (mockDataOptions) {
                    mockDataOptions.style.display = 'block';
                }
            } catch (error) {
                // Fallback for corporate environments
                var choice = prompt('Select Mock Data Type:\n1. Back Pain Case\n2. Wrist Fracture Case\n3. Hand Tendon Case\n\nEnter 1, 2, or 3:');
                if (choice === '1') {
                    fillBackCaseMockData();
                } else if (choice === '2') {
                    fillWristCaseMockData();
                } else if (choice === '3') {
                    fillHandCaseMockData();
                }
            }
        }
        
        function hideMockDataOptions() {
            try {
                var mockDataOptions = document.getElementById('mockDataOptions');
                if (mockDataOptions) {
                    mockDataOptions.style.display = 'none';
                }
            } catch (error) {
                // Silent fail for corporate environments
            }
        }
        
        // ===== MOCK DATA FUNCTIONS =====
        // Mock data functions are now loaded from mock-data-clean.js
        // This provides clean, structured mock data following proper flow:
        // 1. fillBaseData() - Sets common data structure
        // 2. Set case-specific data (diagnosis, location, AROM, muscle power, etc.)
        // 3. updateAllFormFields() - Populates basic form fields
        // 4. generateClinicalFields() - Creates dynamic UI elements
        // 5. populateGeneratedFields() - Fills the dynamic elements with data


        
        // ===== END MOCK DATA SECTION =====
        
        // Update pain region and generate appropriate fields
        function updatePainRegion(section, location) {
            // Update the data
            reportData[section + 'Findings'].complaints.location = location;
            
            // Hide side field for back/neck regions
            var sideContainer = document.getElementById(section + 'SideContainer');
            if (sideContainer) {
                if (location === 'back' || location === 'neck') {
                    sideContainer.style.display = 'none';
                    // Set default to bilateral for back/neck
                    reportData[section + 'Findings'].complaints.side = 'bilateral';
                    document.getElementById(section + 'ComplaintsSide').value = 'bilateral';
                } else {
                    sideContainer.style.display = 'block';
                }
            }
            
            // Generate clinical fields based on location
            generateClinicalFields(section, location, reportData[section + 'Findings'].complaints.side || 'bilateral');
            
            // Show/hide location-specific containers
            var containers = {
                'fingersToesContainer': ['hand', 'foot'],
                'toesRomContainer': ['ankle'],
                'grossFingersRomContainer': ['wrist'],
                'handGripContainer': ['hand', 'wrist'],
                'musclePowerContainer': ['shoulder', 'elbow', 'wrist', 'hip', 'knee', 'ankle'],
                'myotomeContainer': ['back', 'neck']
            };
            
            Object.keys(containers).forEach(function(containerKey) {
                var container = document.getElementById(section + containerKey.charAt(0).toUpperCase() + containerKey.slice(1));
                if (container) {
                    if (containers[containerKey].indexOf(location) !== -1) {
                        container.style.display = 'block';
                    } else {
                        container.style.display = 'none';
                    }
                }
            });
            
            // Generate hand grip fields based on location
            if (location === 'hand') {
                generateHandGripFields(section);
            } else if (location === 'wrist') {
                generateWristHandGripFields(section);
            }
            
            // Initialize other symptoms if not already done
            if (!reportData[section + 'Findings'].complaints.otherSymptoms || reportData[section + 'Findings'].complaints.otherSymptoms.length === 0) {
                reportData[section + 'Findings'].complaints.otherSymptoms = [{ symptom: '', intensity: '' }];
            }
            renderOtherSymptoms(section);
        }

        // Initialize the app
        // Update nested field function
        function updateNestedField(path, value) {
            var keys = path.split('.');
            var obj = reportData;
            
            // Navigate to the parent object
            for (var i = 0; i < keys.length - 1; i++) {
                if (!obj[keys[i]]) {
                    obj[keys[i]] = {};
                }
                obj = obj[keys[i]];
            }
            
            // Set the final value
            obj[keys[keys.length - 1]] = value;
            
            // Debug logging for WB status
            if (path.includes('wbStatus')) {
                console.log('WB Status updated:', path, value);
                console.log('Current WB data:', {
                    wbStatusInclude: reportData.initialFindings.objectiveFindings.wbStatusInclude,
                    wbStatus: reportData.initialFindings.objectiveFindings.wbStatus
                });
            }
        }
        
        // Update field function for simple fields
        function updateField(fieldName, value) {
            reportData[fieldName] = value;
        }

        // Update questionnaire field function
        function updateQuestionnaireField(section, field, value) {
            // Ensure questionnaires array exists and has at least one entry
            if (!reportData[section + 'Findings'].objectiveFindings.questionnaires) {
                reportData[section + 'Findings'].objectiveFindings.questionnaires = [];
            }
            if (reportData[section + 'Findings'].objectiveFindings.questionnaires.length === 0) {
                reportData[section + 'Findings'].objectiveFindings.questionnaires.push({ name: '', score: '' });
            }
            
            // Update the first questionnaire entry
            reportData[section + 'Findings'].objectiveFindings.questionnaires[0][field] = value;
            
            console.log('Questionnaire updated:', section, field, value);
            console.log('Current questionnaires:', reportData[section + 'Findings'].objectiveFindings.questionnaires);
        }

        console.log('Complete Lite App (Full App Compatible) initialized successfully');
        
        // Initialize referral sources
        renderReferralSources();
        
        // Initialize interim and final objective containers with same structure as initial
        document.addEventListener('DOMContentLoaded', function() {
            // Add auto-lowercase first word functionality using your suggested approach
            function addAutoLowercaseListener(input) {
                input.addEventListener('input', function(e) {
                    const parts = e.target.value.split(' ');
                    if (parts[0]) {
                        parts[0] = parts[0].toLowerCase();
                        const newValue = parts.join(' ');
                        if (newValue !== e.target.value) {
                            e.target.value = newValue;
                        }
                    }
                });
            }
            
            // Apply to existing fields with auto-lowercase-first-word class
            function applyAutoLowercaseListeners() {
                const inputs = document.querySelectorAll('.auto-lowercase-first-word');
                inputs.forEach(function(input) {
                    addAutoLowercaseListener(input);
                });
            }
            
            // Initial application
            applyAutoLowercaseListeners();
            
            // Also try to apply after a short delay in case elements are still being created
            setTimeout(function() {
                applyAutoLowercaseListeners();
            }, 1000);
            
            // Alternative approach: Target specific fields by their onchange attributes
            function applyAutoLowercaseByAttribute() {
                const allInputs = document.querySelectorAll('input[type="text"]');
                
                allInputs.forEach(function(input) {
                    const onchangeAttr = input.getAttribute('onchange');
                    if (onchangeAttr) {
                        // Check if this is a field that needs normalization
                        if (onchangeAttr.includes('tendernessArea') || 
                            onchangeAttr.includes('areaReduced') || 
                            onchangeAttr.includes('areaHypersensitive') ||
                            onchangeAttr.includes('updateOtherSymptom') && onchangeAttr.includes('symptom')) {
                            addAutoLowercaseListener(input);
                        }
                    }
                });
            }
            
            // Apply alternative approach
            applyAutoLowercaseByAttribute();
            
            // Also apply after delay
            setTimeout(function() {
                applyAutoLowercaseByAttribute();
            }, 2000);
            
            // Re-apply when dynamic content is added (for interim/final sections and other symptoms)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // Try both class-based and attribute-based approaches
                                const newInputsByClass = node.querySelectorAll('.auto-lowercase-first-word');
                                newInputsByClass.forEach(function(input) {
                                    addAutoLowercaseListener(input);
                                });
                                
                                // Also check by attribute
                                const newInputsByAttr = node.querySelectorAll('input[type="text"]');
                                newInputsByAttr.forEach(function(input) {
                                    const onchangeAttr = input.getAttribute('onchange');
                                    if (onchangeAttr && (
                                        onchangeAttr.includes('tendernessArea') || 
                                        onchangeAttr.includes('areaReduced') || 
                                        onchangeAttr.includes('areaHypersensitive') ||
                                        (onchangeAttr.includes('updateOtherSymptom') && onchangeAttr.includes('symptom'))
                                    )) {
                                        addAutoLowercaseListener(input);
                                    }
                                });
                            }
                        });
                    }
                });
            });
            
            // Observe the entire document for dynamic changes
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // Copy initial objective container structure to interim and final
            var initialContainer = document.getElementById('initialObjectiveContainer');
            var interimContainer = document.getElementById('interimObjectiveContainer');
            var finalContainer = document.getElementById('finalObjectiveContainer');
            
            if (initialContainer && interimContainer && finalContainer) {
                // Clone structure and update IDs for interim
                var interimHTML = initialContainer.innerHTML.replace(/initial/g, 'interim');
                interimContainer.innerHTML = interimHTML;
                
                // Clone structure and update IDs for final
                var finalHTML = initialContainer.innerHTML.replace(/initial/g, 'final');
                finalContainer.innerHTML = finalHTML;
            }
            
            // Initialize other symptoms for all sections
            renderOtherSymptoms('initial');
            
            // Clone other symptoms containers to interim and final
            var initialOtherSymptomsContainer = document.getElementById('initialOtherSymptomsContainer');
            var interimOtherSymptomsContainer = document.getElementById('interimOtherSymptomsContainer');
            var finalOtherSymptomsContainer = document.getElementById('finalOtherSymptomsContainer');
            
            if (initialOtherSymptomsContainer && interimOtherSymptomsContainer && finalOtherSymptomsContainer) {
                // Initialize interim and final other symptoms containers
                var interimOtherSymptomsHTML = initialOtherSymptomsContainer.innerHTML.replace(/initial/g, 'interim');
                interimOtherSymptomsContainer.innerHTML = interimOtherSymptomsHTML;
                
                var finalOtherSymptomsHTML = initialOtherSymptomsContainer.innerHTML.replace(/initial/g, 'final');
                finalOtherSymptomsContainer.innerHTML = finalOtherSymptomsHTML;
            }
        });
    </script>
    
    <!-- Embedded Mock Data System (Corporate Environment Compatible) -->
    <script>
        // ===== EMBEDDED MOCK DATA SYSTEM =====
        // Eliminates CORS restrictions by embedding functions directly in HTML
        
        // Base data function - sets common structure
        function fillBaseData() {
            // Section 1: Reference Information
            reportData.ourRef = 'REF2025001';
            reportData.ourRef2 = 'SUB001';
            reportData.yourRef = 'DOC123';
            reportData.yourRefDate = '2024-12-01';
            reportData.reportDate = '2025-01-15';
            reportData.recipient = 'Dr. Wong';
            
            // Section 2: Patient Information
            reportData.patientName = 'CHAN, T. M.';
            reportData.patientSex = 'Male';
            reportData.patientAge = '45';
            reportData.hkidNo = 'A123456(7)';
            reportData.physiotherapyOpdNo = 'PT001234';
            
            // Section 4: Source of Referral
            reportData.referralSources = [{
                episode: 'First',
                department: 'Department of Orthopedics and Traumatology',
                hospital: 'Tuen Mun Hospital'
            }];
            
            // Section 5: Duration of Treatment
            reportData.totalSessions = '8';
            reportData.registrationDate = '2024-12-01';
            reportData.treatmentPeriodStart = '2024-12-15';
            reportData.treatmentPeriodEnd = '2025-01-15';
            reportData.caseTherapists = 'Jane Smith, PT';
            reportData.reportWriter = 'Jane Smith';
            reportData.attendedSessions = '8';
            reportData.defaultedSessions = '0';
            
            // Section 7: Treatment
            reportData.treatments = [
                { method: 'Manual therapy', area: '' },
                { method: 'Exercise therapy', area: '' }
            ];
            reportData.otherTreatment = 'Patient education and home exercise program';
            
            // Section 8: Discharge Summary
            reportData.dischargeSummary = {
                componentData: {
                    dischargeType: 'Discharged',
                    dischargeDate: '2025-01-15',
                    defaultDate: '',
                    cancellationDate: '',
                    scheduledAppointmentDate: '',
                    cancellationReason: ''
                }
            };
            
            // Section 9: Therapist Details
            reportData.consentDate = '2025-01-15';
            reportData.declarationName = 'Jane Smith';
            reportData.declarationTitle = 'Senior Physiotherapist';
            reportData.educationQualifications = 'Bachelor of Physiotherapy, Master of Sports Physiotherapy';
        }
        
        // Mock Data Case 1: Back Pain
        function fillBackCaseMockData() {
            try {
                // Step 1: Fill base data
                fillBaseData();
                
                // Step 2: Set case-specific data
                reportData.diagnosis = 'Chronic lower back pain with muscle spasm and reduced mobility';
                
                // Initial findings
                reportData.initialFindings = {
                    date: '2024-12-15',
                    complaints: {
                        side: 'bilateral',
                        location: 'back',
                        painIntensity: '8',
                        otherSymptoms: [
                            { symptom: 'muscle stiffness', intensity: '7' },
                            { symptom: 'reduced mobility', intensity: '6' }
                        ],
                        activities1: [
                            { activity: 'sitting', duration: '15', unit: 'minutes' },
                            { activity: 'reading', duration: '10', unit: 'minutes' }
                        ],
                        activities2: [
                            { activity: 'walking', duration: '5', unit: 'minutes', aid: 'unaided' },
                            { activity: 'standing', duration: '10', unit: 'minutes', aid: 'unaided' }
                        ],
                        otherFunctionalLimitation: 'He has difficulty with bending and lifting activities. He cannot perform household chores for more than 5 minutes.',
                        overallImprovement: '0'
                    },
                    objectiveFindings: {
                        aromMovements: [
                            { movement: 'Flexion', arom: '2/5', prom: '' },
                            { movement: 'Extension', arom: '2/5', prom: '' },
                            { movement: 'Right Rotation', arom: '3/5', prom: '' },
                            { movement: 'Left Rotation', arom: '3/5', prom: '' },
                            { movement: 'Right Side Flexion', arom: '3/5', prom: '' },
                            { movement: 'Left Side Flexion', arom: '3/5', prom: '' }
                        ],
                        handJoints: [],
                        fingersToesData: [],
                        toesROM: '',
                        grossFingersROM: '',
                        musclePower: [],
                        handGripStrength: {
                            leftHandGrip: '', rightHandGrip: '', leftPinchGrip: '',
                            rightPinchGrip: '', leftLateralPinch: '', rightLateralPinch: ''
                        },
                        myotome: [
                            { level: 'L2', leftGrade: '4', rightGrade: '4' },
                            { level: 'L3', leftGrade: '4', rightGrade: '4' },
                            { level: 'L4', leftGrade: '3', rightGrade: '3' },
                            { level: 'L5', leftGrade: '3', rightGrade: '3' },
                            { level: 'S1', leftGrade: '4', rightGrade: '4' }
                        ],
                        aromNotTested: false,
                        musclePowerNotTested: false,
                        includeProm: false,
                        splintBraceCastInclude: false,
                        splintBraceCastType: '',
                        tendernessInclude: true,
                        tendernessArea: 'lower lumbar region, bilateral paraspinal muscles',
                        swellingInclude: true,
                        swellingPresent: false,
                        temperatureInclude: true,
                        temperatureIncreased: false,
                        sensationInclude: true,
                        sensationStatus: 'intact',
                        sensationReduction: '',
                        areaReduced: '',
                        areaHypersensitive: '',
                        reflexInclude: true,
                        reflexNormal: true,
                        walkingAid: 'unaided',
                        walkingStability: 'fair',
                        wbStatusInclude: true,
                        wbStatus: 'full weight bearing',
                        specialTests: [
                            { testType: 'straight_leg_raise', leftResult: 'positive', rightResult: 'negative' },
                            { testType: 'other', testName: 'slump test', result: 'positive' }
                        ],
                        questionnaires: [
                            { name: 'Roland-Morris Disability Questionnaire', score: '18' }
                        ]
                    }
                };
                
                // Final findings
                reportData.finalFindings = {
                    date: '2025-01-15',
                    complaints: {
                        side: 'bilateral',
                        location: 'back',
                        painIntensity: '2',
                        otherSymptoms: [
                            { symptom: 'minimal stiffness', intensity: '2' },
                            { symptom: 'good mobility', intensity: '1' }
                        ],
                        activities1: [
                            { activity: 'sitting', duration: '60', unit: 'minutes' },
                            { activity: 'reading', duration: '45', unit: 'minutes' }
                        ],
                        activities2: [
                            { activity: 'walking', duration: '30', unit: 'minutes', aid: 'unaided' },
                            { activity: 'standing', duration: '45', unit: 'minutes', aid: 'unaided' }
                        ],
                        otherFunctionalLimitation: 'He is able to perform all daily activities without restriction. He can now lift objects up to 10kg without difficulty.',
                        overallImprovement: '8'
                    },
                    objectiveFindings: {
                        aromMovements: [
                            { movement: 'Flexion', arom: '5/5', prom: '' },
                            { movement: 'Extension', arom: '5/5', prom: '' },
                            { movement: 'Right Rotation', arom: '5/5', prom: '' },
                            { movement: 'Left Rotation', arom: '5/5', prom: '' },
                            { movement: 'Right Side Flexion', arom: '5/5', prom: '' },
                            { movement: 'Left Side Flexion', arom: '5/5', prom: '' }
                        ],
                        handJoints: [],
                        fingersToesData: [],
                        toesROM: '',
                        grossFingersROM: '',
                        musclePower: [],
                        handGripStrength: {
                            leftHandGrip: '', rightHandGrip: '', leftPinchGrip: '',
                            rightPinchGrip: '', leftLateralPinch: '', rightLateralPinch: ''
                        },
                        myotome: [
                            { level: 'L2', leftGrade: '5', rightGrade: '5' },
                            { level: 'L3', leftGrade: '5', rightGrade: '5' },
                            { level: 'L4', leftGrade: '5', rightGrade: '5' },
                            { level: 'L5', leftGrade: '5', rightGrade: '5' },
                            { level: 'S1', leftGrade: '5', rightGrade: '5' }
                        ],
                        aromNotTested: false,
                        musclePowerNotTested: false,
                        includeProm: false,
                        splintBraceCastInclude: false,
                        splintBraceCastType: '',
                        tendernessInclude: false,
                        tendernessArea: '',
                        swellingInclude: true,
                        swellingPresent: false,
                        temperatureInclude: true,
                        temperatureIncreased: false,
                        sensationInclude: true,
                        sensationStatus: 'intact',
                        sensationReduction: '',
                        areaReduced: '',
                        areaHypersensitive: '',
                        reflexInclude: true,
                        reflexNormal: true,
                        walkingAid: 'unaided',
                        walkingStability: 'good',
                        wbStatusInclude: true,
                        wbStatus: 'full weight bearing',
                        specialTests: [
                            { testType: 'straight_leg_raise', leftResult: 'negative', rightResult: 'negative' },
                            { testType: 'other', testName: 'slump test', result: 'negative' }
                        ],
                        questionnaires: [
                            { name: 'Roland-Morris Disability Questionnaire', score: '2' }
                        ]
                    }
                };
                
                // Step 3: Update all form fields
                updateAllFormFields();
                
                // Step 4: Generate dynamic UI elements
                generateClinicalFields('initial', 'back', 'bilateral');
                generateClinicalFields('final', 'back', 'bilateral');
                
                // Step 5: Populate the dynamic elements with data
                populateGeneratedFields('initial');
                populateGeneratedFields('final');
                
                // Step 6: Populate treatment checkboxes
                populateTreatmentCheckboxes();
                
                // Step 7: Populate discharge data
                populateDischargeData();
                
                alert('Back pain case mock data filled successfully!');
            } catch (error) {
                console.error('Error loading back case mock data:', error);
                alert('Error loading back case mock data. Please check console for details.');
            }
        }
        
        // Mock Data Case 2: Wrist Fracture
        function fillWristCaseMockData() {
            try {
                // Step 1: Fill base data
                fillBaseData();
                
                // Step 2: Set case-specific data
                reportData.diagnosis = 'Right wrist fracture with immobilization, post-brace removal rehabilitation';
                
                // Initial findings - AROM and muscle power not tested due to brace
                reportData.initialFindings = {
                    date: '2024-12-15',
                    complaints: {
                        side: 'right',
                        location: 'wrist',
                        painIntensity: '6',
                        otherSymptoms: [
                            { symptom: 'stiffness', intensity: '8' },
                            { symptom: 'weakness', intensity: '7' }
                        ],
                        activities1: [
                            { activity: 'writing', duration: '2', unit: 'minutes' },
                            { activity: 'typing', duration: '5', unit: 'minutes' }
                        ],
                        activities2: [
                            { activity: 'carrying', duration: '1', unit: 'minutes', aid: 'both hands' }
                        ],
                        otherFunctionalLimitation: 'He is unable to perform fine motor tasks and has difficulty with daily activities requiring wrist movement.',
                        overallImprovement: '0'
                    },
                    objectiveFindings: {
                        aromMovements: [
                            { movement: 'Flexion', arom: 'not-tested', prom: '' },
                            { movement: 'Extension', arom: 'not-tested', prom: '' },
                            { movement: 'Pronation', arom: 'not-tested', prom: '' },
                            { movement: 'Supination', arom: 'not-tested', prom: '' },
                            { movement: 'Radial Deviation', arom: 'not-tested', prom: '' },
                            { movement: 'Ulnar Deviation', arom: 'not-tested', prom: '' }
                        ],
                        handJoints: [],
                        fingersToesData: [],
                        toesROM: '',
                        grossFingersROM: '',
                        musclePower: [
                            { muscleGroup: 'Wrist flexors', leftGrade: '', rightGrade: 'not-tested' },
                            { muscleGroup: 'Wrist extensors', leftGrade: '', rightGrade: 'not-tested' },
                            { muscleGroup: 'Pronator teres', leftGrade: '', rightGrade: 'not-tested' },
                            { muscleGroup: 'Supinator', leftGrade: '', rightGrade: 'not-tested' }
                        ],
                        handGripStrength: {
                            leftHandGrip: '', rightHandGrip: '', leftPinchGrip: '',
                            rightPinchGrip: '', leftLateralPinch: '', rightLateralPinch: ''
                        },
                        myotome: [],
                        aromNotTested: true,
                        musclePowerNotTested: true,
                        includeProm: false,
                        splintBraceCastInclude: true,
                        splintBraceCastType: 'short arm cast',
                        tendernessInclude: true,
                        tendernessArea: 'right wrist, radial styloid process',
                        swellingInclude: true,
                        swellingPresent: true,
                        temperatureInclude: false,
                        temperatureIncreased: false,
                        sensationInclude: true,
                        sensationStatus: 'intact',
                        sensationReduction: '',
                        areaReduced: '',
                        areaHypersensitive: '',
                        reflexInclude: false,
                        reflexNormal: true,
                        walkingAid: 'unaided',
                        walkingStability: 'good',
                        wbStatusInclude: false,
                        wbStatus: '',
                        specialTests: [],
                        questionnaires: [
                            { name: 'QuickDASH', score: '68' }
                        ]
                    }
                };
                
                // Final findings - improvement after brace removal
                reportData.finalFindings = {
                    date: '2025-01-15',
                    complaints: {
                        side: 'right',
                        location: 'wrist',
                        painIntensity: '2',
                        otherSymptoms: [
                            { symptom: 'mild stiffness', intensity: '3' },
                            { symptom: 'improved strength', intensity: '2' }
                        ],
                        activities1: [
                            { activity: 'writing', duration: '15', unit: 'minutes' },
                            { activity: 'typing', duration: '30', unit: 'minutes' }
                        ],
                        activities2: [
                            { activity: 'carrying', duration: '10', unit: 'minutes', aid: 'unaided' }
                        ],
                        otherFunctionalLimitation: 'He is able to perform most daily activities with minimal difficulty. Some heavy lifting activities remain challenging.',
                        overallImprovement: '7'
                    },
                    objectiveFindings: {
                        aromMovements: [
                            { movement: 'Flexion', arom: '65', prom: '' },
                            { movement: 'Extension', arom: '60', prom: '' },
                            { movement: 'Pronation', arom: '75', prom: '' },
                            { movement: 'Supination', arom: '70', prom: '' },
                            { movement: 'Radial Deviation', arom: '18', prom: '' },
                            { movement: 'Ulnar Deviation', arom: '28', prom: '' }
                        ],
                        handJoints: [],
                        fingersToesData: [],
                        toesROM: '',
                        grossFingersROM: '4/5 of full range',
                        musclePower: [
                            { muscleGroup: 'Wrist flexors', leftGrade: '', rightGrade: '4' },
                            { muscleGroup: 'Wrist extensors', leftGrade: '', rightGrade: '4' },
                            { muscleGroup: 'Pronator teres', leftGrade: '', rightGrade: '4' },
                            { muscleGroup: 'Supinator', leftGrade: '', rightGrade: '4' }
                        ],
                        handGripStrength: {
                            leftHandGrip: '', rightHandGrip: '28', leftPinchGrip: '',
                            rightPinchGrip: '', leftLateralPinch: '', rightLateralPinch: ''
                        },
                        myotome: [],
                        aromNotTested: false,
                        musclePowerNotTested: false,
                        includeProm: false,
                        splintBraceCastInclude: false,
                        splintBraceCastType: '',
                        tendernessInclude: false,
                        tendernessArea: '',
                        swellingInclude: true,
                        swellingPresent: false,
                        temperatureInclude: false,
                        temperatureIncreased: false,
                        sensationInclude: true,
                        sensationStatus: 'intact',
                        sensationReduction: '',
                        areaReduced: '',
                        areaHypersensitive: '',
                        reflexInclude: false,
                        reflexNormal: true,
                        walkingAid: 'unaided',
                        walkingStability: 'good',
                        wbStatusInclude: false,
                        wbStatus: '',
                        specialTests: [],
                        questionnaires: [
                            { name: 'QuickDASH', score: '15' }
                        ]
                    }
                };
                
                // Step 3: Update all form fields
                updateAllFormFields();
                
                // Step 4: Generate dynamic UI elements
                generateClinicalFields('initial', 'wrist', 'right');
                generateClinicalFields('final', 'wrist', 'right');
                
                // Step 5: Populate the dynamic elements with data
                populateGeneratedFields('initial');
                populateGeneratedFields('final');
                
                // Step 6: Populate treatment checkboxes
                populateTreatmentCheckboxes();
                
                // Step 7: Populate discharge data
                populateDischargeData();
                
                alert('Wrist fracture case mock data filled successfully!');
            } catch (error) {
                console.error('Error loading wrist case mock data:', error);
                alert('Error loading wrist case mock data. Please check console for details.');
            }
        }
        
        // Mock Data Case 3: Hand Tendon Rupture Repair
        function fillHandCaseMockData() {
            try {
                // Step 1: Fill base data
                fillBaseData();
                
                // Step 2: Set case-specific data
                reportData.diagnosis = 'Right hand multiple finger tendon rupture repair, post-surgical rehabilitation';
                
                // Initial findings - finger ROM not tested due to splint immobilization
                reportData.initialFindings = {
                    date: '2024-12-15',
                    complaints: {
                        side: 'right',
                        location: 'hand',
                        painIntensity: '5',
                        otherSymptoms: [
                            { symptom: 'stiffness in fingers', intensity: '8' },
                            { symptom: 'reduced grip strength', intensity: '9' }
                        ],
                        activities1: [
                            { activity: 'writing', duration: '1', unit: 'minutes' },
                            { activity: 'buttoning', duration: '0', unit: 'minutes' }
                        ],
                        activities2: [
                            { activity: 'grasping', duration: '0', unit: 'minutes', aid: 'unable' }
                        ],
                        otherFunctionalLimitation: 'He is unable to perform fine motor activities and is dependent on left hand for all tasks. He cannot button clothes or write properly.',
                        overallImprovement: '0'
                    },
                    objectiveFindings: {
                        aromMovements: [],
                        handJoints: [],
                        fingersToesData: [],
                        toesROM: '',
                        grossFingersROM: '',
                        musclePower: [],
                        handGripStrength: {
                            leftHandGrip: '', rightHandGrip: '', leftPinchGrip: '',
                            rightPinchGrip: '', leftLateralPinch: '', rightLateralPinch: ''
                        },
                        myotome: [],
                        aromNotTested: true,
                        musclePowerNotTested: true,
                        includeProm: false,
                        splintBraceCastInclude: true,
                        splintBraceCastType: 'dynamic extension splint',
                        tendernessInclude: true,
                        tendernessArea: 'right hand, surgical site over flexor tendons',
                        swellingInclude: true,
                        swellingPresent: true,
                        temperatureInclude: false,
                        temperatureIncreased: false,
                        sensationInclude: true,
                        sensationStatus: 'reduced',
                        sensationReduction: '50%',
                        areaReduced: 'fingertips of index, middle, and ring fingers',
                        areaHypersensitive: '',
                        reflexInclude: false,
                        reflexNormal: true,
                        walkingAid: 'unaided',
                        walkingStability: 'good',
                        wbStatusInclude: false,
                        wbStatus: '',
                        specialTests: [],
                        questionnaires: [
                            { name: 'QuickDASH', score: '85' }
                        ]
                    }
                };
                
                // Final findings - improvement after splint removal
                reportData.finalFindings = {
                    date: '2025-01-15',
                    complaints: {
                        side: 'right',
                        location: 'hand',
                        painIntensity: '1',
                        otherSymptoms: [
                            { symptom: 'mild finger stiffness', intensity: '3' },
                            { symptom: 'improved grip strength', intensity: '2' }
                        ],
                        activities1: [
                            { activity: 'writing', duration: '10', unit: 'minutes' },
                            { activity: 'buttoning', duration: '2', unit: 'minutes' }
                        ],
                        activities2: [
                            { activity: 'grasping', duration: '5', unit: 'minutes', aid: 'unaided' }
                        ],
                        otherFunctionalLimitation: 'He is able to perform most fine motor activities with some difficulty. Heavy gripping activities remain challenging.',
                        overallImprovement: '7'
                    },
                    objectiveFindings: {
                        aromMovements: [],
                        handJoints: [],
                        fingersToesData: [
                            {
                                name: 'Index finger',
                                joints: [
                                    { jointType: 'mcpj', range: '0-85' },
                                    { jointType: 'pipj', range: '0-75' },
                                    { jointType: 'dipj', range: '0-60' }
                                ]
                            },
                            {
                                name: 'Middle finger',
                                joints: [
                                    { jointType: 'mcpj', range: '0-80' },
                                    { jointType: 'pipj', range: '0-70' },
                                    { jointType: 'dipj', range: '0-55' }
                                ]
                            },
                            {
                                name: 'Ring finger',
                                joints: [
                                    { jointType: 'mcpj', range: '0-75' },
                                    { jointType: 'pipj', range: '0-65' },
                                    { jointType: 'dipj', range: '0-50' }
                                ]
                            }
                        ],
                        toesROM: '',
                        grossFingersROM: '',
                        musclePower: [],
                        handGripStrength: {
                            leftHandGrip: '', rightHandGrip: '22', leftPinchGrip: '',
                            rightPinchGrip: '4', leftLateralPinch: '', rightLateralPinch: '5'
                        },
                        myotome: [],
                        aromNotTested: false,
                        musclePowerNotTested: false,
                        includeProm: false,
                        splintBraceCastInclude: false,
                        splintBraceCastType: '',
                        tendernessInclude: false,
                        tendernessArea: '',
                        swellingInclude: true,
                        swellingPresent: false,
                        temperatureInclude: false,
                        temperatureIncreased: false,
                        sensationInclude: true,
                        sensationStatus: 'intact',
                        sensationReduction: '',
                        areaReduced: '',
                        areaHypersensitive: '',
                        reflexInclude: false,
                        reflexNormal: true,
                        walkingAid: 'unaided',
                        walkingStability: 'good',
                        wbStatusInclude: false,
                        wbStatus: '',
                        specialTests: [],
                        questionnaires: [
                            { name: 'QuickDASH', score: '25' }
                        ]
                    }
                };
                
                // Step 3: Update all form fields
                updateAllFormFields();
                
                // Step 4: Generate dynamic UI elements
                generateClinicalFields('initial', 'hand', 'right');
                generateClinicalFields('final', 'hand', 'right');
                
                // Step 5: Populate the dynamic elements with data
                populateGeneratedFields('initial');
                populateGeneratedFields('final');
                
                // Step 6: Populate treatment checkboxes
                populateTreatmentCheckboxes();
                
                // Step 7: Populate discharge data
                populateDischargeData();
                
                alert('Hand tendon rupture case mock data filled successfully!');
            } catch (error) {
                console.error('Error loading hand case mock data:', error);
                alert('Error loading hand case mock data. Please check console for details.');
            }
        }
        
        // Helper functions for mock data
        function updateAllFormFields() {
            // Section 1: Reference Information
            safeSetValue('ourRef', reportData.ourRef);
            safeSetValue('ourRef2', reportData.ourRef2);
            safeSetValue('yourRef', reportData.yourRef);
            safeSetValue('yourRefDate', reportData.yourRefDate);
            safeSetValue('reportDate', reportData.reportDate);
            safeSetValue('recipient', reportData.recipient);
            
            // Section 2: Patient Information
            safeSetValue('patientName', reportData.patientName);
            safeSetValue('patientSex', reportData.patientSex);
            safeSetValue('patientAge', reportData.patientAge);
            safeSetValue('hkidNo', reportData.hkidNo);
            safeSetValue('physiotherapyOpdNo', reportData.physiotherapyOpdNo);
            
            // Section 3: Diagnosis
            safeSetValue('diagnosis', reportData.diagnosis);
            
            // Section 5: Duration of Treatment
            safeSetValue('totalSessions', reportData.totalSessions);
            safeSetValue('registrationDate', reportData.registrationDate);
            safeSetValue('treatmentPeriodStart', reportData.treatmentPeriodStart);
            safeSetValue('treatmentPeriodEnd', reportData.treatmentPeriodEnd);
            safeSetValue('caseTherapists', reportData.caseTherapists);
            safeSetValue('reportWriter', reportData.reportWriter);
            safeSetValue('attendedSessions', reportData.attendedSessions);
            safeSetValue('defaultedSessions', reportData.defaultedSessions);
            
            // Section 6: Clinical Information - Initial
            if (reportData.initialFindings) {
                safeSetValue('initialDate', reportData.initialFindings.date);
                safeSetValue('initialComplaintsSide', reportData.initialFindings.complaints.side);
                safeSetValue('initialPainRegion', reportData.initialFindings.complaints.location);
                safeSetValue('initialPainIntensity', reportData.initialFindings.complaints.painIntensity);
                safeSetValue('initialOtherFunctionalLimitation', reportData.initialFindings.complaints.otherFunctionalLimitation);
                safeSetValue('initialImprovement', reportData.initialFindings.complaints.overallImprovement);
            }
            
            // Section 6: Clinical Information - Final
            if (reportData.finalFindings) {
                safeSetValue('finalDate', reportData.finalFindings.date);
                safeSetValue('finalComplaintsSide', reportData.finalFindings.complaints.side);
                safeSetValue('finalPainRegion', reportData.finalFindings.complaints.location);
                safeSetValue('finalPainIntensity', reportData.finalFindings.complaints.painIntensity);
                safeSetValue('finalOtherFunctionalLimitation', reportData.finalFindings.complaints.otherFunctionalLimitation);
                safeSetValue('finalImprovement', reportData.finalFindings.complaints.overallImprovement);
            }
            
            // Section 7: Treatment
            safeSetValue('otherTreatment', reportData.otherTreatment);
            
            // Section 8: Discharge Summary
            if (reportData.dischargeSummary && reportData.dischargeSummary.componentData) {
                safeSetValue('dischargeType', reportData.dischargeSummary.componentData.dischargeType);
                
                // Trigger discharge type change to show appropriate fields
                var dischargeTypeSelect = document.getElementById('dischargeType');
                if (dischargeTypeSelect && reportData.dischargeSummary.componentData.dischargeType) {
                    dischargeTypeSelect.value = reportData.dischargeSummary.componentData.dischargeType;
                    updateDischargeType(reportData.dischargeSummary.componentData.dischargeType);
                    
                    // Populate discharge date after fields are created
                    setTimeout(function() {
                        if (reportData.dischargeSummary.componentData.dischargeDate) {
                            var dischargeDateInput = document.querySelector('#dischargeFields input[type="date"]');
                            if (dischargeDateInput) {
                                dischargeDateInput.value = reportData.dischargeSummary.componentData.dischargeDate;
                            }
                        }
                    }, 100);
                }
            }
            
            // Section 9: Therapist Details
            safeSetValue('consentDate', reportData.consentDate);
            safeSetValue('declarationName', reportData.declarationName);
            safeSetValue('declarationTitle', reportData.declarationTitle);
            safeSetValue('educationQualifications', reportData.educationQualifications);
            
            // Render dynamic elements
            if (reportData.initialFindings) {
                renderOtherSymptoms('initial');
                renderActivities1('initial');
                renderActivities2('initial');
            }
            if (reportData.finalFindings) {
                renderOtherSymptoms('final');
                renderActivities1('final');
                renderActivities2('final');
            }
        }
        
        // New function to populate treatment checkboxes
        function populateTreatmentCheckboxes() {
            if (reportData.treatments && reportData.treatments.length > 0) {
                reportData.treatments.forEach(function(treatment, index) {
                    var checkbox = document.querySelector('input[value="' + treatment.method + '"]');
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }
        }
        
        // New function to populate discharge data
        function populateDischargeData() {
            if (reportData.dischargeSummary && reportData.dischargeSummary.componentData) {
                var dischargeType = document.getElementById('dischargeType');
                if (dischargeType) {
                    dischargeType.value = reportData.dischargeSummary.componentData.dischargeType;
                }
                
                var dischargeDate = document.getElementById('dischargeDate');
                if (dischargeDate) {
                    dischargeDate.value = reportData.dischargeSummary.componentData.dischargeDate;
                }
            }
        }
        
        // Safe value setting function
        function safeSetValue(elementId, value) {
            var element = document.getElementById(elementId);
            if (element && value !== undefined && value !== null) {
                element.value = value;
            }
        }
    </script>
</body>
</html>