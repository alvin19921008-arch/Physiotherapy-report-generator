<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physiotherapy Report Generator - Lite App v2.1 Polished</title>
    <meta name="description" content="Data collection tool for physiotherapy medical reports - Full App Compatible">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #2563eb;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #64748b;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8fafc;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #64748b;
            transition: all 0.3s ease;
            border-right: 1px solid #e2e8f0;
        }

        .nav-tab:last-child {
            border-right: none;
        }

        .nav-tab:hover {
            background: #e2e8f0;
            color: #334155;
        }

        .nav-tab.active {
            background: #2563eb;
            color: white;
        }

        .section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 1.8rem;
            color: #1e293b;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-col {
            flex: 1;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-primary:disabled {
            background: #2563eb;
            opacity: 0.8;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .clinical-tabs {
            display: flex;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .clinical-tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .clinical-tab.active {
            background: #2563eb;
            color: white;
        }

        .clinical-content {
            display: none;
        }

        .clinical-content.active {
            display: block;
        }

        .export-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .export-output {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .checkbox {
            margin-right: 8px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .small-input {
            width: 120px;
        }

        .wide-input {
            width: 100%;
        }

        .finger-toe-panel {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .finger-toe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .joint-checkboxes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .joint-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .joint-ranges {
            margin-top: 15px;
        }

        .muscle-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 15px;
        }

        .muscle-label {
            min-width: 150px;
            font-weight: 500;
        }

        .muscle-input {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .status-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-ready {
            background: #dcfce7;
            color: #166534;
        }

        .status-incomplete {
            background: #fef3c7;
            color: #92400e;
        }

        .copy-buttons {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 6px;
        }

        .clinical-navigation {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .clinical-navigation .btn {
            min-width: 180px;
        }

        .clinical-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .clinical-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #64748b;
            transition: all 0.2s;
        }

        .clinical-tab:hover {
            color: #374151;
            background: #f8fafc;
        }

        .clinical-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background: #f8fafc;
        }

        .clinical-content {
            display: none;
        }

        .clinical-content.active {
            display: block;
        }

        .treatment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .treatment-category {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
        }

        .treatment-category h4 {
            margin-bottom: 10px;
            color: #374151;
        }

        .treatment-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .discharge-section {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        .discharge-section h4 {
            margin-bottom: 15px;
            color: #374151;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .treatment-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Physiotherapy Report Generator - Lite App v4.4 Debug Fixed</h1>
            <div class="subtitle">Navigation Debug | Early Function Definition | Corporate Compatible</div>
            <div style="margin-top: 15px;">
                <div id="mockDataContainer" style="display: inline-block; margin-right: 10px;">
                    <!-- Mock data selector will be rendered here -->
                </div>
                <button type="button" class="btn btn-success" onclick="generateDataString()">Generate Data String</button>
                <button type="button" class="btn btn-secondary" onclick="testFunction()" style="margin-left: 10px;">Test JS</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection(1)">Section 1: Reference</button>
            <button class="nav-tab" onclick="showSection(2)">Section 2: Patient Info</button>
            <button class="nav-tab" onclick="showSection(3)">Section 3: Diagnosis</button>
            <button class="nav-tab" onclick="showSection(4)">Section 4: Referral</button>
            <button class="nav-tab" onclick="showSection(5)">Section 5: Duration</button>
            <button class="nav-tab" onclick="showSection(6)">Section 6: Clinical</button>
            <button class="nav-tab" onclick="showSection(7)">Section 7: Treatment</button>
            <button class="nav-tab" onclick="showSection(8)">Section 8: Discharge</button>
            <button class="nav-tab" onclick="showSection(9)">Section 9: Declaration</button>
        </div>

        <!-- Section 1: Reference Information -->
        <div id="section1" class="section active">
            <h2 class="section-title">Section 1: Reference Information</h2>
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Our Reference</label>
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                        <span style="color: #64748b; font-size: 14px;">(</span>
                        <input type="text" id="ourRef" class="form-input" placeholder="Enter reference number" onchange="updateField('ourRef', this.value)" style="width: 120px;">
                        <span style="color: #64748b; font-size: 14px;">) in PHY/OA/</span>
                        <input type="text" id="ourRef2" class="form-input" placeholder="Enter second part" onchange="updateField('ourRef2', this.value)" style="width: 120px;">
                    </div>
                </div>
                <div class="form-col">
                    <label class="form-label">Your Reference:</label>
                    <input type="text" id="yourRef" class="form-input" placeholder="Insert Your Reference" onchange="updateField('yourRef', this.value)">
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Your Reference Date:</label>
                    <input type="date" id="yourRefDate" class="form-input" onchange="updateField('yourRefDate', this.value)">
                </div>
                <div class="form-col">
                    <label class="form-label">Report Date:</label>
                    <input type="date" id="reportDate" class="form-input" onchange="updateField('reportDate', this.value)">
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Recipient:</label>
                    <input type="text" id="recipient" class="form-input" placeholder="Recipient name" onchange="updateField('recipient', this.value)">
                </div>
            </div>
        </div>

        <!-- Section 2: Patient Information -->
        <div id="section2" class="section">
            <h2 class="section-title">Section 2: Patient Information</h2>
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Patient Name:</label>
                    <input type="text" id="patientName" class="form-input" placeholder="e.g., John Doe" onchange="updateField('patientName', this.value)">
                </div>
                <div class="form-col">
                    <label class="form-label">Sex:</label>
                    <select id="patientSex" class="form-select" onchange="updateField('patientSex', this.value)">
                        <option value="">Select Sex</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Age:</label>
                    <input type="text" id="patientAge" class="form-input" placeholder="e.g., 45" onchange="updateField('patientAge', this.value)">
                </div>
                <div class="form-col">
                    <label class="form-label">HKID No:</label>
                    <input type="text" id="hkidNo" class="form-input" placeholder="e.g., A123456(7)" onchange="updateField('hkidNo', this.value)">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Physiotherapy OPD No:</label>
                <input type="text" id="physiotherapyOpdNo" class="form-input" placeholder="e.g., PT123456" onchange="updateField('physiotherapyOpdNo', this.value)">
            </div>
        </div>

        <!-- Section 3: Diagnosis -->
        <div id="section3" class="section">
            <h2 class="section-title">Section 3: Diagnosis</h2>
            <div class="form-group">
                <label class="form-label">Diagnosis:</label>
                <textarea id="diagnosis" class="form-textarea" placeholder="Enter diagnosis details..." onchange="updateField('diagnosis', this.value)"></textarea>
            </div>
        </div>

        <!-- Section 4: Source of Referral -->
        <div id="section4" class="section">
            <h2 class="section-title">Section 4: Source of Referral</h2>
            <div id="referralSourcesContainer">
                <!-- Referral sources will be dynamically generated -->
            </div>
            <button type="button" class="btn btn-secondary btn-small" onclick="addReferralSource()">Add Referral Source</button>
        </div>

        <!-- Section 5: Duration of Treatment -->
        <div id="section5" class="section">
            <h2 class="section-title">Section 5: Duration of Treatment</h2>
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Total Sessions:</label>
                    <input type="text" id="totalSessions" class="form-input" placeholder="e.g., 12" onchange="updateField('totalSessions', this.value)">
                </div>
                <div class="form-col">
                    <label class="form-label">Attended Sessions:</label>
                    <input type="text" id="attendedSessions" class="form-input" placeholder="e.g., 10" onchange="updateField('attendedSessions', this.value)">
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Defaulted Sessions:</label>
                    <input type="text" id="defaultedSessions" class="form-input" placeholder="e.g., 2" onchange="updateField('defaultedSessions', this.value)">
                </div>
                <div class="form-col">
                    <label class="form-label">Registration Date:</label>
                    <input type="date" id="registrationDate" class="form-input" onchange="updateField('registrationDate', this.value)">
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Treatment Period Start:</label>
                    <input type="date" id="treatmentPeriodStart" class="form-input" onchange="updateField('treatmentPeriodStart', this.value)">
                </div>
                <div class="form-col">
                    <label class="form-label">Treatment Period End:</label>
                    <input type="date" id="treatmentPeriodEnd" class="form-input" onchange="updateField('treatmentPeriodEnd', this.value)">
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Case Therapists:</label>
                    <input type="text" id="caseTherapists" class="form-input" placeholder="e.g., John Smith, Jane Doe" onchange="updateField('caseTherapists', this.value)">
                </div>
                <div class="form-col">
                    <label class="form-label">Report Writer:</label>
                    <input type="text" id="reportWriter" class="form-input" placeholder="e.g., Dr. Johnson" onchange="updateField('reportWriter', this.value)">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Referral Info:</label>
                <textarea id="referralInfo" class="form-textarea" placeholder="Additional referral information..." onchange="updateField('referralInfo', this.value)"></textarea>
            </div>
        </div>

        <!-- Section 6: Clinical Findings -->
        <div id="section6" class="section">
            <h2 class="section-title">Section 6: Clinical Findings</h2>
            
            <!-- Clinical Tabs -->
            <div class="clinical-tabs">
                <button class="clinical-tab active" onclick="showClinicalTab('initial')">Initial Findings</button>
                <button class="clinical-tab" onclick="showClinicalTab('interim')">Interim Findings</button>
                <button class="clinical-tab" onclick="showClinicalTab('final')">Final Findings</button>
            </div>

            <!-- Clinical Content will be dynamically generated -->
            <div id="initialClinical" class="clinical-content active">
                <!-- Initial findings content -->
            </div>
            <div id="interimClinical" class="clinical-content">
                <!-- Interim findings content -->
            </div>
            <div id="finalClinical" class="clinical-content">
                <!-- Final findings content -->
            </div>
        </div>

        <!-- Section 7: Treatment Methods -->
        <div id="section7" class="section">
            <h2 class="section-title">Section 7: Treatment Methods</h2>
            <div id="treatmentMethodsContainer">
                <!-- Treatment methods will be dynamically generated -->
            </div>
            <div class="form-group">
                <label class="form-label">Other Treatment:</label>
                <textarea id="otherTreatment" class="form-textarea" placeholder="Describe other treatments..." onchange="updateField('otherTreatment', this.value)"></textarea>
            </div>
        </div>

        <!-- Section 8: Discharge Summary -->
        <div id="section8" class="section">
            <h2 class="section-title">Section 8: Discharge Summary</h2>
            <div id="dischargeSummaryContainer">
                <!-- Discharge summary will be dynamically generated -->
            </div>
        </div>

        <!-- Section 9: Declaration -->
        <div id="section9" class="section">
            <h2 class="section-title">Section 9: Declaration</h2>
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Consent Date:</label>
                    <input type="date" id="consentDate" class="form-input" onchange="updateField('consentDate', this.value)">
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Therapist Name:</label>
                    <input type="text" id="therapistName" class="form-input" placeholder="e.g., Dr. Smith" onchange="updateNestedField('therapistDetails', 'name', this.value)">
                </div>
                <div class="form-col">
                    <label class="form-label">Therapist Title:</label>
                    <input type="text" id="therapistTitle" class="form-input" placeholder="e.g., Senior Physiotherapist" onchange="updateNestedField('therapistDetails', 'title', this.value)">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Therapist Qualifications:</label>
                <input type="text" id="therapistQualifications" class="form-input" placeholder="e.g., BSc (Hons) Physiotherapy" onchange="updateNestedField('therapistDetails', 'qualifications', this.value)">
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <h3 style="margin-bottom: 15px;">Data Export</h3>
            <p style="margin-bottom: 15px; color: #64748b;">Click "Generate Data String" to create a data string compatible with the full app. Copy and paste this string into the full app to import all your data.</p>
            <div id="exportOutput" class="export-output">
                Click "Generate Data String" to create exportable data...
            </div>
            <button type="button" class="btn btn-success" onclick="copyDataString()" style="margin-top: 15px;">Copy Data String</button>
        </div>
    </div>

    <script>
        // ===== LITE APP v4.3 - SIMPLIFIED =====
        // Vanilla JS equivalent of full app with perfect data compatibility
        
        // Simple test function to verify JavaScript is working
        function testFunction() {
            alert('JavaScript is working!');
        }
        
        // Navigation function - defined early for accessibility
        function showSection(sectionNumber) {
            try {
                // Hide all sections
                var sections = document.getElementsByClassName('section');
                for (var i = 0; i < sections.length; i++) {
                    sections[i].classList.remove('active');
                }
                
                // Remove active class from all tabs
                var tabs = document.getElementsByClassName('nav-tab');
                for (var i = 0; i < tabs.length; i++) {
                    tabs[i].classList.remove('active');
                }
                
                // Show target section
                var targetSection = document.getElementById('section' + sectionNumber);
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Activate corresponding tab
                if (tabs[sectionNumber - 1]) {
                    tabs[sectionNumber - 1].classList.add('active');
                }
                
                // Update state
                if (typeof LiteAppState !== 'undefined') {
                    LiteAppState.currentSection = sectionNumber;
                }
                
                // Scroll to top
                window.scrollTo(0, 0);
            } catch (error) {
                alert('Navigation error: ' + error.message);
            }
        }
        
        // Clinical tab navigation function - defined early
        function showClinicalTab(tabName) {
            try {
                // Hide all clinical content
                var clinicalTabs = ['initial', 'interim', 'final'];
                for (var i = 0; i < clinicalTabs.length; i++) {
                    var tabContent = document.getElementById(clinicalTabs[i] + 'Clinical');
                    var tabButton = document.querySelector('[onclick="showClinicalTab(\'' + clinicalTabs[i] + '\')"');
                    
                    if (tabContent) {
                        tabContent.classList.remove('active');
                    }
                    if (tabButton) {
                        tabButton.classList.remove('active');
                    }
                }
                
                // Show target tab content
                var targetTab = document.getElementById(tabName + 'Clinical');
                var targetButton = document.querySelector('[onclick="showClinicalTab(\'' + tabName + '\')"');
                
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                if (targetButton) {
                    targetButton.classList.add('active');
                }
                
                // Update state
                if (typeof LiteAppState !== 'undefined') {
                    LiteAppState.currentClinicalTab = tabName;
                }
            } catch (error) {
                alert('Clinical tab error: ' + error.message);
            }
        }
        
        // Ensure functions are globally accessible
        window.showSection = showSection;
        window.showClinicalTab = showClinicalTab;
        window.testFunction = testFunction;
        
        // Global state container (mirrors React state)
        var LiteAppState = {
            reportData: null,
            currentSection: 1,
            currentClinicalTab: 'initial'
        };

        // Create empty clinical findings structure (mirrors createEmptyClinicalFindings)
        function createEmptyClinicalFindings() {
            return {
                date: '',
                complaints: {
                    side: '',
                    location: '',
                    painIntensity: '',
                    otherSymptoms: '',
                    symptomIntensity: '',
                    activities1: [{ activity: '', duration: '', unit: 'minutes' }],
                    activities2: [{ activity: '', duration: '', unit: 'minutes', aid: '' }],
                    otherFunctionalActivities: '',
                    overallImprovement: ''
                },
                objectiveFindings: {
                    aromMovements: [],
                    handJoints: [],
                    fingersToesData: [],
                    toesROM: '',
                    musclePower: [],
                    myotome: [],
                    handGripStrength: { 
                        leftHandGrip: '', 
                        rightHandGrip: '', 
                        leftPinchGrip: '', 
                        rightPinchGrip: '', 
                        leftLateralPinch: '', 
                        rightLateralPinch: '' 
                    },
                    aromNotTested: false,
                    musclePowerNotTested: false,
                    includeProm: false,
                    tendernessInclude: false,
                    tendernessArea: '',
                    swellingInclude: false,
                    swellingPresent: false,
                    temperatureInclude: false,
                    temperatureIncreased: false,
                    sensationInclude: false,
                    sensationStatus: 'intact',
                    sensationReduction: '',
                    areaReduced: '',
                    areaHypersensitive: '',
                    reflexInclude: false,
                    reflexNormal: true,
                    walkingAid: '',
                    walkingStability: '',
                    wbStatusInclude: false,
                    wbStatus: '',
                    specialTests: [],
                    questionnaires: []
                }
            };
        }

        // Create initial report data structure (mirrors createInitialReportData)
        function createInitialReportData() {
            var today = new Date();
            var year = today.getFullYear();
            var month = (today.getMonth() + 1).toString();
            var day = today.getDate().toString();
            
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            
            var dateString = year + '-' + month + '-' + day;

            return {
                // Section 1: Reference Information
                ourRef: '',
                ourRef2: '',
                yourRef: '',
                yourRefDate: '',
                reportDate: dateString,
                recipient: '',
                
                // Section 2: Patient Information
                patientName: '',
                patientSex: '',
                patientAge: '',
                hkidNo: '',
                physiotherapyOpdNo: '',
                
                // Section 3: Diagnosis
                diagnosis: '',
                
                // Section 4: Source of Referral
                referralSources: [{ episode: '1st', department: '', hospital: '' }],
                
                // Section 5: Duration of Treatment
                totalSessions: '',
                referralInfo: '',
                registrationDate: '',
                treatmentPeriodStart: '',
                treatmentPeriodEnd: '',
                caseTherapists: '',
                reportWriter: '',
                attendedSessions: '',
                defaultedSessions: '',
                
                // Section 6: Clinical Information
                initialFindings: createEmptyClinicalFindings(),
                interimFindings: createEmptyClinicalFindings(),
                finalFindings: createEmptyClinicalFindings(),
                
                // Section 7: Treatment
                treatments: [],
                otherTreatment: '',
                
                // Section 8: Discharge Summary (Exact structure matching full app)
                dischargeSummary: {
                    painChange: '',
                    painIntensity: '',
                    symptomChange: '',
                    symptomIntensity: '',
                    activityImprovement: {
                        from: '',
                        to: ''
                    },
                    aromImprovement: {
                        region: '',
                        movement: '',
                        from: '',
                        to: ''
                    },
                    musclePowerImprovement: {
                        region: '',
                        muscleGroup: '',
                        from: '',
                        to: ''
                    },
                    overallImprovement: '',
                    dischargeDate: '',
                    componentData: {
                        dischargeType: '',
                        dischargeDate: '',
                        cancellationDate: '',
                        appointmentDate: '',
                        cancellationReason: ''
                    }
                },
                
                // Declaration
                consentDate: '',
                therapistDetails: {
                    name: '',
                    title: '',
                    qualifications: ''
                }
            };
        }

        // ===== DATA MANAGEMENT FUNCTIONS =====

        // Update simple field
        function updateField(fieldName, value) {
            if (LiteAppState.reportData) {
                LiteAppState.reportData[fieldName] = value;
            }
        }

        // Update nested field
        function updateNestedField(parentField, childField, value) {
            if (LiteAppState.reportData && LiteAppState.reportData[parentField]) {
                LiteAppState.reportData[parentField][childField] = value;
            }
        }

        // Update clinical findings field
        function updateClinicalField(section, fieldPath, value) {
            if (!LiteAppState.reportData) return;
            
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;
            
            var pathParts = fieldPath.split('.');
            var current = findings;
            
            // Navigate to the parent object
            for (var i = 0; i < pathParts.length - 1; i++) {
                if (!current[pathParts[i]]) {
                    current[pathParts[i]] = {};
                }
                current = current[pathParts[i]];
            }
            
            // Set the final value
            current[pathParts[pathParts.length - 1]] = value;
        }

        // ===== NAVIGATION FUNCTIONS =====





        // ===== DYNAMIC CONTENT GENERATION =====

        // Get AROM movements based on location
        function getAromMovements(location) {
            var movements = {
                'back': ['Flexion', 'Extension', 'Right Rotation', 'Left Rotation', 'Right Side Flexion', 'Left Side Flexion'],
                'neck': ['Flexion', 'Extension', 'Right Rotation', 'Left Rotation', 'Right Side Flexion', 'Left Side Flexion'],
                'shoulder': ['Flexion', 'Abduction', 'Extension', 'External Rotation', 'Internal Rotation', 'Hand behind back', 'Hand behind neck'],
                'elbow': ['Flexion', 'Extension', 'Pronation', 'Supination'],
                'wrist': ['Flexion', 'Extension', 'Pronation', 'Supination', 'Radial Deviation', 'Ulnar Deviation'],
                'hip': ['Flexion', 'Abduction', 'Extension', 'External Rotation', 'Internal Rotation'],
                'knee': ['Flexion', 'Extension'],
                'ankle': ['Plantarflexion', 'Dorsiflexion', 'Eversion', 'Inversion'],
                'hand': [],
                'foot': []
            };
            return movements[location] || [];
        }

        // Get muscle groups based on location
        function getMuscleGroups(location) {
            var muscles = {
                'shoulder': ['Flexor', 'Abductor', 'Extensor', 'External Rotator', 'Internal Rotator'],
                'elbow': ['Flexor', 'Extensor', 'Pronator', 'Supinator'],
                'wrist': ['Flexor', 'Extensor', 'Pronator', 'Supinator', 'Radial Deviator', 'Ulnar Deviator'],
                'hip': ['Flexor', 'Extensor', 'Abductor', 'External Rotator', 'Internal Rotator'],
                'knee': ['Flexor', 'Extensor'],
                'ankle': ['Plantarflexor', 'Dorsiflexor', 'Evertor', 'Invertor', 'Toes'],
                'foot': ['Plantarflexor', 'Dorsiflexor', 'Evertor', 'Invertor', 'Toes']
            };
            return muscles[location] || [];
        }

        // Get myotome levels based on location
        function getMyotomeLevels(location) {
            var levels = {
                'back': ['L2', 'L3', 'L4', 'L5', 'S1'],
                'neck': ['C5', 'C6', 'C7', 'C8', 'T1']
            };
            return levels[location] || [];
        }

        // Get small joint options based on location
        function getSmallJointOptions(location) {
            var joints = {
                'hand': [
                    { value: 'CMCJ', label: 'CMCJ' },
                    { value: 'MCPJ', label: 'MCPJ' },
                    { value: 'PIPJ', label: 'PIPJ' },
                    { value: 'DIPJ', label: 'DIPJ' },
                    { value: 'IPJ', label: 'IPJ' }
                ],
                'foot': [
                    { value: 'MTPJ', label: 'MTPJ' },
                    { value: 'PIPJ', label: 'PIPJ' },
                    { value: 'DIPJ', label: 'DIPJ' },
                    { value: 'IPJ', label: 'IPJ' }
                ]
            };
            return joints[location] || [];
        }

        // ===== CLINICAL FINDINGS COMPONENT =====

        function renderClinicalFindings(section) {
            var container = document.getElementById(section + 'Clinical');
            if (!container) return;

            var html = '';
            
            // Copy buttons for interim and final
            if (section !== 'initial') {
                html += '<div class="copy-buttons">';
                html += '<button type="button" class="btn btn-secondary btn-small" onclick="copyFromInitial(\"' + section + '\")">Copy from Initial Findings</button>';
                html += '<p style="margin-top: 10px; color: #64748b; font-size: 14px;">Click to copy all data from Initial Clinical Findings, then modify as needed.</p>';
                html += '</div>';
            }

            // Date field
            html += '<div class="form-group">';
            html += '<label class="form-label">Date:</label>';
            html += '<input type="date" id="' + section + 'Date" class="form-input" onchange="updateClinicalField(\'' + section + '\', \'date\', this.value)">';
            html += '</div>';

            // Patient Complaints section
            html += '<div style="margin-bottom: 30px;">';
            html += '<h4 style="margin-bottom: 15px; color: #374151;">I. Patient Complaints</h4>';
            
            // Side and Location
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<label class="form-label">Side:</label>';
            html += '<select id="' + section + 'Side" class="form-select" onchange="updateClinicalField(\'' + section + '\', \'complaints.side\', this.value)">';
            html += '<option value="">Select Side</option>';
            html += '<option value="Left">Left</option>';
            html += '<option value="Right">Right</option>';
            html += '<option value="Bilateral">Bilateral</option>';
            html += '</select>';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<label class="form-label">Pain Region:</label>';
            html += '<select id="' + section + 'Location" class="form-select" onchange="updateLocationFields(\'' + section + '\', this.value)">';
            html += '<option value="">Select Region</option>';
            html += '<option value="back">Back</option>';
            html += '<option value="neck">Neck</option>';
            html += '<option value="shoulder">Shoulder</option>';
            html += '<option value="elbow">Elbow</option>';
            html += '<option value="wrist">Wrist</option>';
            html += '<option value="hand">Hand</option>';
            html += '<option value="hip">Hip</option>';
            html += '<option value="knee">Knee</option>';
            html += '<option value="ankle">Ankle</option>';
            html += '<option value="foot">Foot</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';

            // Pain Intensity and Other Symptoms
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<label class="form-label">Pain Intensity (NPRS):</label>';
            html += '<input type="number" id="' + section + 'PainIntensity" class="form-input" min="0" max="10" placeholder="0-10" onchange="updateClinicalField(\'' + section + '\', \'complaints.painIntensity\', this.value)">';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<label class="form-label">Other Symptoms:</label>';
            html += '<input type="text" id="' + section + 'OtherSymptoms" class="form-input" placeholder="e.g., tingling, numbness" onchange="updateClinicalField(\'' + section + '\', \'complaints.otherSymptoms\', this.value)">';
            html += '</div>';
            html += '</div>';

            // Symptom Intensity
            html += '<div class="form-group">';
            html += '<label class="form-label">Other symptoms intensity:</label>';
            html += '<input type="text" id="' + section + 'SymptomsIntensity" class="form-input" placeholder="e.g., 5 or 4-6" onchange="updateClinicalField(\'' + section + '\', \'complaints.symptomIntensity\', this.value)">';
            html += '</div>';

            // Functional Activities
            html += '<div class="form-group">';
            html += '<label class="form-label">Functional Activity - Sitting/Reading:</label>';
            html += '<div class="grid-3">';
            html += '<div>';
            html += '<select id="' + section + 'Activity1" class="form-select" onchange="updateActivityField(\'' + section + '\', 0, \'activity\', this.value, \'activities1\')">';
            html += '<option value="">Select activity</option>';
            html += '<option value="reading">Reading</option>';
            html += '<option value="sitting">Sitting</option>';
            html += '</select>';
            html += '</div>';
            html += '<div>';
            html += '<input type="text" id="' + section + 'Activity1Duration" class="form-input" placeholder="e.g., 30" onchange="updateActivityField(\'' + section + '\', 0, \'duration\', this.value, \'activities1\')">';
            html += '</div>';
            html += '<div>';
            html += '<select id="' + section + 'Activity1Unit" class="form-select" onchange="updateActivityField(\'' + section + '\', 0, \'unit\', this.value, \'activities1\')">';
            html += '<option value="minutes">Minutes</option>';
            html += '<option value="hours">Hours</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Walking/Standing Activity
            html += '<div class="form-group">';
            html += '<label class="form-label">Functional Activity - Walking/Standing:</label>';
            html += '<div class="grid-2">';
            html += '<div>';
            html += '<div class="grid-2">';
            html += '<div>';
            html += '<select id="' + section + 'Activity2" class="form-select" onchange="updateActivityField(\'' + section + '\', 0, \'activity\', this.value, \'activities2\')">';
            html += '<option value="">Select activity</option>';
            html += '<option value="walking">Walking</option>';
            html += '<option value="standing">Standing</option>';
            html += '</select>';
            html += '</div>';
            html += '<div>';
            html += '<input type="text" id="' + section + 'Activity2Duration" class="form-input" placeholder="e.g., 10" onchange="updateActivityField(\'' + section + '\', 0, \'duration\', this.value, \'activities2\')">';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '<div>';
            html += '<div class="grid-2">';
            html += '<div>';
            html += '<select id="' + section + 'Activity2Unit" class="form-select" onchange="updateActivityField(\'' + section + '\', 0, \'unit\', this.value, \'activities2\')">';
            html += '<option value="minutes">Minutes</option>';
            html += '<option value="hours">Hours</option>';
            html += '</select>';
            html += '</div>';
            html += '<div>';
            html += '<select id="' + section + 'Activity2Aid" class="form-select" onchange="updateActivityField(\'' + section + '\', 0, \'aid\', this.value, \'activities2\')">';
            html += '<option value="">Select Aid</option>';
            html += '<option value="unaided">Unaided</option>';
            html += '<option value="stick">Stick</option>';
            html += '<option value="quadruped">Quadruped</option>';
            html += '<option value="frame">Frame</option>';
            html += '<option value="elbow crutches">Elbow Crutches</option>';
            html += '<option value="rollator">Rollator</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Other Functional Activities
            html += '<div class="form-group">';
            html += '<label class="form-label">Other Functional Activities:</label>';
            html += '<textarea id="' + section + 'OtherFunctionalActivities" class="form-textarea" placeholder="Describe other functional activities" onchange="updateClinicalField(\'' + section + '\', \'complaints.otherFunctionalActivities\', this.value)"></textarea>';
            html += '</div>';

            // Overall Improvement
            html += '<div class="form-group">';
            html += '<label class="form-label">Overall Subjective Improvement (NGRCS):</label>';
            html += '<select id="' + section + 'OverallImprovement" class="form-select" onchange="updateClinicalField(\'' + section + '\', \'complaints.overallImprovement\', this.value)">';
            html += '<option value="">Select Improvement</option>';
            for (var i = 0; i <= 10; i++) {
                html += '<option value="' + i + '">' + i + ' out of 10</option>';
            }
            html += '</select>';
            html += '</div>';

            html += '</div>';

            // Objective Findings section
            html += '<div style="margin-bottom: 30px;">';
            html += '<h4 style="margin-bottom: 15px; color: #374151;">II. Objective Findings</h4>';

            // AROM Section
            html += '<div class="form-group">';
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<label class="form-label">Active Range of Movement (AROM):</label>';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<div class="checkbox-group">';
            html += '<input type="checkbox" id="' + section + 'AromNotTested" class="checkbox" onchange="toggleAromPanel(\'' + section + '\', this.checked)">';
            html += '<label for="' + section + 'AromNotTested">Not tested</label>';
            html += '<input type="checkbox" id="' + section + 'IncludeProm" class="checkbox" style="margin-left: 20px;" onchange="updateAromFields(\'' + section + '\')">';
            html += '<label for="' + section + 'IncludeProm">Include PROM</label>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '<div id="' + section + 'AromPanel">';
            html += '<div id="' + section + 'AromMovements"></div>';
            
            // Toes ROM for ankle
            html += '<div id="' + section + 'ToesRomSection" style="display: none;">';
            html += '<div class="muscle-row">';
            html += '<div class="muscle-label">Toes Range of Motion</div>';
            html += '<div class="muscle-input">';
            html += '<input type="text" id="' + section + 'ToesROM" class="form-input wide-input" placeholder="***input format, e.g.: 2/3 of full range***" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.toesROM\', this.value)">';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // Fingers/Toes ROM for hand/foot
            html += '<div id="' + section + 'FingersToesSection" style="display: none;">';
            html += '<div class="section-header" id="' + section + 'FingersToesHeader">Fingers Range of Motion</div>';
            html += '<div id="' + section + 'FingersToesContainer"></div>';
            html += '<button type="button" class="btn btn-small btn-secondary" onclick="addFingerToe(\'' + section + '\')">Add Finger</button>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Hand Grip Strength Section
            html += '<div class="form-group" id="' + section + 'HandGripGroup" style="display: none;">';
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<label class="form-label">Hand Grip Strength Testing:</label>';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<div class="checkbox-group">';
            html += '<input type="checkbox" id="' + section + 'HandGripNotTested" class="checkbox" onchange="toggleHandGripPanel(\'' + section + '\', this.checked)">';
            html += '<label for="' + section + 'HandGripNotTested">Not tested</label>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '<div id="' + section + 'HandGripPanel">';
            html += '<div class="grid-3">';
            html += '<div><strong>Test Type</strong></div>';
            html += '<div><strong>Left (kgf)</strong></div>';
            html += '<div><strong>Right (kgf)</strong></div>';
            html += '</div>';
            html += '<div class="grid-3">';
            html += '<div>Hand Grip</div>';
            html += '<div><input type="number" id="' + section + 'LeftHandGrip" class="form-input" step="0.1" placeholder="e.g., 25" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.handGripStrength.leftHandGrip\', this.value)"></div>';
            html += '<div><input type="number" id="' + section + 'RightHandGrip" class="form-input" step="0.1" placeholder="e.g., 28" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.handGripStrength.rightHandGrip\', this.value)"></div>';
            html += '</div>';
            html += '<div class="grid-3">';
            html += '<div>Pinch Grip</div>';
            html += '<div><input type="number" id="' + section + 'LeftPinchGrip" class="form-input" step="0.1" placeholder="e.g., 8" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.handGripStrength.leftPinchGrip\', this.value)"></div>';
            html += '<div><input type="number" id="' + section + 'RightPinchGrip" class="form-input" step="0.1" placeholder="e.g., 8" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.handGripStrength.rightPinchGrip\', this.value)"></div>';
            html += '</div>';
            html += '<div class="grid-3">';
            html += '<div>Lateral Pinch</div>';
            html += '<div><input type="number" id="' + section + 'LeftLateralPinch" class="form-input" step="0.1" placeholder="e.g., 10" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.handGripStrength.leftLateralPinch\', this.value)"></div>';
            html += '<div><input type="number" id="' + section + 'RightLateralPinch" class="form-input" step="0.1" placeholder="e.g., 10" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.handGripStrength.rightLateralPinch\', this.value)"></div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Muscle Power Section
            html += '<div class="form-group" id="' + section + 'MusclePowerGroup">';
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<label class="form-label" id="' + section + 'MusclePowerLabel">Muscle Power (Oxford Manual Muscle Testing Scale):</label>';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<div class="checkbox-group">';
            html += '<input type="checkbox" id="' + section + 'MusclePowerNotTested" class="checkbox" onchange="toggleMusclePowerPanel(\'' + section + '\', this.checked)">';
            html += '<label for="' + section + 'MusclePowerNotTested">Not tested</label>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '<div id="' + section + 'MusclePowerPanel">';
            html += '<div id="' + section + 'MusclePowerContainer"></div>';
            html += '</div>';
            html += '</div>';

            // Myotome Section
            html += '<div class="form-group" id="' + section + 'MyotomeGroup" style="display: none;">';
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<label class="form-label">Myotome Testing:</label>';
            html += '</div>';
            html += '</div>';
            html += '<div id="' + section + 'MyotomeContainer"></div>';
            html += '</div>';

            // Tenderness Section
            html += '<div class="form-group">';
            html += '<div class="checkbox-group">';
            html += '<input type="checkbox" id="' + section + 'TendernessInclude" class="checkbox" onchange="toggleTendernessPanel(\'' + section + '\', this.checked)">';
            html += '<label for="' + section + 'TendernessInclude">Include tenderness</label>';
            html += '</div>';
            html += '<div id="' + section + 'TendernessPanel" style="display: none;">';
            html += '<div class="form-group">';
            html += '<label class="form-label">Tenderness Area:</label>';
            html += '<input type="text" id="' + section + 'TendernessArea" class="form-input" placeholder="e.g., over lateral epicondyle" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.tendernessArea\', this.value)">';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Swelling Section
            html += '<div class="form-group">';
            html += '<div class="checkbox-group">';
            html += '<input type="checkbox" id="' + section + 'SwellingInclude" class="checkbox" onchange="toggleSwellingPanel(\'' + section + '\', this.checked)">';
            html += '<label for="' + section + 'SwellingInclude">Include swelling</label>';
            html += '</div>';
            html += '<div id="' + section + 'SwellingPanel" style="display: none;">';
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<input type="radio" id="' + section + 'SwellingPresent" name="' + section + 'Swelling" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.swellingPresent\', true)">';
            html += '<label for="' + section + 'SwellingPresent">Present</label>';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<input type="radio" id="' + section + 'SwellingAbsent" name="' + section + 'Swelling" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.swellingPresent\', false)">';
            html += '<label for="' + section + 'SwellingAbsent">Absent</label>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Temperature Section
            html += '<div class="form-group">';
            html += '<div class="checkbox-group">';
            html += '<input type="checkbox" id="' + section + 'TemperatureInclude" class="checkbox" onchange="toggleTemperaturePanel(\'' + section + '\', this.checked)">';
            html += '<label for="' + section + 'TemperatureInclude">Include temperature</label>';
            html += '</div>';
            html += '<div id="' + section + 'TemperaturePanel" style="display: none;">';
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<input type="radio" id="' + section + 'TemperatureIncreased" name="' + section + 'Temperature" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.temperatureIncreased\', true)">';
            html += '<label for="' + section + 'TemperatureIncreased">Increased</label>';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<input type="radio" id="' + section + 'TemperatureNormal" name="' + section + 'Temperature" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.temperatureIncreased\', false)">';
            html += '<label for="' + section + 'TemperatureNormal">Normal</label>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Sensation Section
            html += '<div class="form-group">';
            html += '<div class="checkbox-group">';
            html += '<input type="checkbox" id="' + section + 'SensationInclude" class="checkbox" onchange="toggleSensationPanel(\'' + section + '\', this.checked)">';
            html += '<label for="' + section + 'SensationInclude">Include sensation</label>';
            html += '</div>';
            html += '<div id="' + section + 'SensationPanel" style="display: none;">';
            html += '<div class="form-group">';
            html += '<label class="form-label">Sensation Status:</label>';
            html += '<select id="' + section + 'SensationStatus" class="form-select" onchange="updateSensationFields(\'' + section + '\', this.value)">';
            html += '<option value="intact">Intact</option>';
            html += '<option value="reduced">Reduced</option>';
            html += '<option value="hypersensitive">Hypersensitivity</option>';
            html += '</select>';
            html += '</div>';
            html += '<div id="' + section + 'SensationReduced" style="display: none;">';
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<label class="form-label">Reduction Percentage:</label>';
            html += '<input type="text" id="' + section + 'SensationReduction" class="form-input" placeholder="e.g., 50%" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.sensationReduction\', this.value)">';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<label class="form-label">Over Which Area:</label>';
            html += '<input type="text" id="' + section + 'AreaReduced" class="form-input" placeholder="e.g., dorsal aspect of hand" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.areaReduced\', this.value)">';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '<div id="' + section + 'SensationHypersensitive" style="display: none;">';
            html += '<div class="form-group">';
            html += '<label class="form-label">Over Which Area:</label>';
            html += '<input type="text" id="' + section + 'AreaHypersensitive" class="form-input" placeholder="e.g., dorsal aspect of hand" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.areaHypersensitive\', this.value)">';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Reflex Section
            html += '<div class="form-group">';
            html += '<div class="checkbox-group">';
            html += '<input type="checkbox" id="' + section + 'ReflexInclude" class="checkbox" onchange="toggleReflexPanel(\'' + section + '\', this.checked)">';
            html += '<label for="' + section + 'ReflexInclude">Include reflex finding</label>';
            html += '</div>';
            html += '<div id="' + section + 'ReflexPanel" style="display: none;">';
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<input type="radio" id="' + section + 'ReflexNormal" name="' + section + 'Reflex" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.reflexNormal\', true)">';
            html += '<label for="' + section + 'ReflexNormal">Normal</label>';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<input type="radio" id="' + section + 'ReflexAbnormal" name="' + section + 'Reflex" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.reflexNormal\', false)">';
            html += '<label for="' + section + 'ReflexAbnormal">Abnormal</label>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Gait Section
            html += '<div class="form-group">';
            html += '<h5 class="font-medium">Gait</h5>';
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<label class="form-label">Walking Aid:</label>';
            html += '<select id="' + section + 'WalkingAid" class="form-select" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.walkingAid\', this.value)">';
            html += '<option value="">Select walking aid</option>';
            html += '<option value="unaided">Unaided</option>';
            html += '<option value="stick">Stick</option>';
            html += '<option value="quadruped">Quadruped</option>';
            html += '<option value="frame">Frame</option>';
            html += '<option value="elbow crutches">Elbow Crutches</option>';
            html += '<option value="rollator">Rollator</option>';
            html += '</select>';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<label class="form-label">Walking Stability:</label>';
            html += '<select id="' + section + 'WalkingStability" class="form-select" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.walkingStability\', this.value)">';
            html += '<option value="">Select stability</option>';
            html += '<option value="good">Good</option>';
            html += '<option value="normal">Normal</option>';
            html += '<option value="acceptable">Acceptable</option>';
            html += '<option value="satisfactory">Satisfactory</option>';
            html += '<option value="fair">Fair</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';
            html += '<div class="checkbox-group">';
            html += '<input type="checkbox" id="' + section + 'WbStatusInclude" class="checkbox" onchange="toggleWbStatusPanel(\'' + section + '\', this.checked)">';
            html += '<label for="' + section + 'WbStatusInclude">WB Status</label>';
            html += '</div>';
            html += '<div id="' + section + 'WbStatusPanel" style="display: none;">';
            html += '<select id="' + section + 'WbStatus" class="form-select" onchange="updateClinicalField(\'' + section + '\', \'objectiveFindings.wbStatus\', this.value)">';
            html += '<option value="">Select WB status</option>';
            html += '<option value="partial weight bearing">Partial weight bearing</option>';
            html += '<option value="full weight bearing">Full weight bearing</option>';
            html += '<option value="non weight bearing">Non weight bearing</option>';
            html += '<option value="toe touching down">Toe touching down</option>';
            html += '<option value="weight bearing as tolerated">Weight bearing as tolerated</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';

            // Special Tests Section
            html += '<div class="form-group">';
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<label class="form-label">Special Tests:</label>';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<button type="button" class="btn btn-secondary btn-small" onclick="addSpecialTest(\'' + section + '\')" style="float: right;">Add Test</button>';
            html += '</div>';
            html += '</div>';
            html += '<div id="' + section + 'SpecialTestsContainer"></div>';
            html += '</div>';

            // Questionnaires Section
            html += '<div class="form-group">';
            html += '<div class="form-row">';
            html += '<div class="form-col">';
            html += '<label class="form-label">Questionnaires:</label>';
            html += '</div>';
            html += '<div class="form-col">';
            html += '<button type="button" class="btn btn-secondary btn-small" onclick="addQuestionnaire(\'' + section + '\')" style="float: right;">Add Questionnaire</button>';
            html += '</div>';
            html += '</div>';
            html += '<div id="' + section + 'QuestionnairesContainer"></div>';
            html += '</div>';

            // Smart Navigation System - Direct Access to All Sections
            html += '<div class="clinical-navigation" style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">';
            
            // Section indicator at top
            var sectionTitle = section.charAt(0).toUpperCase() + section.slice(1) + ' Findings';
            html += '<div style="text-align: center; margin-bottom: 15px;">';
            html += '<span style="font-weight: 600; color: #374151; font-size: 16px;">' + sectionTitle + '</span>';
            html += '</div>';
            
            // Direct navigation buttons to all sections
            html += '<div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">';
            
            // Initial Findings button
            if (section !== 'initial') {
                html += '<button type="button" class="btn btn-secondary" onclick="jumpToClinicalTab(\"initial\")" style="min-width: 140px;">Initial Findings</button>';
            } else {
                html += '<button type="button" class="btn btn-primary" disabled style="min-width: 140px;">Initial Findings</button>';
            }
            
            // Interim Findings button
            if (section !== 'interim') {
                html += '<button type="button" class="btn btn-secondary" onclick="jumpToClinicalTab(\"interim\")" style="min-width: 140px;">Interim Findings</button>';
            } else {
                html += '<button type="button" class="btn btn-primary" disabled style="min-width: 140px;">Interim Findings</button>';
            }
            
            // Final Findings button
            if (section !== 'final') {
                html += '<button type="button" class="btn btn-secondary" onclick="jumpToClinicalTab(\"final\")" style="min-width: 140px;">Final Findings</button>';
            } else {
                html += '<button type="button" class="btn btn-primary" disabled style="min-width: 140px;">Final Findings</button>';
            }
            
            html += '</div>';
            html += '</div>';

            html += '</div>';

            container.innerHTML = html;
        }

        // Update location-based fields
        function updateLocationFields(section, location) {
            updateClinicalField(section, 'complaints.location', location);
            
            // Show/hide toes ROM for ankle
            var toesRomSection = document.getElementById(section + 'ToesRomSection');
            if (toesRomSection) {
                toesRomSection.style.display = (location === 'ankle') ? 'block' : 'none';
            }

            // Show/hide fingers/toes ROM for hand/foot
            var fingersToesSection = document.getElementById(section + 'FingersToesSection');
            var fingersToesHeader = document.getElementById(section + 'FingersToesHeader');
            if (fingersToesSection && fingersToesHeader) {
                if (location === 'hand' || location === 'foot') {
                    fingersToesSection.style.display = 'block';
                    fingersToesHeader.textContent = (location === 'hand' ? 'Fingers' : 'Toes') + ' Range of Motion';
                    var addButton = fingersToesSection.querySelector('button');
                    if (addButton) {
                        addButton.textContent = 'Add ' + (location === 'hand' ? 'Finger' : 'Toe');
                    }
                } else {
                    fingersToesSection.style.display = 'none';
                }
            }

            // Show/hide hand grip for hand
            var handGripGroup = document.getElementById(section + 'HandGripGroup');
            if (handGripGroup) {
                handGripGroup.style.display = (location === 'hand') ? 'block' : 'none';
            }

            // Show/hide myotome for back/neck
            var myotomeGroup = document.getElementById(section + 'MyotomeGroup');
            if (myotomeGroup) {
                if (location === 'back' || location === 'neck') {
                    myotomeGroup.style.display = 'block';
                    generateMyotomeFields(section, location);
                } else {
                    myotomeGroup.style.display = 'none';
                }
            }

            // Update muscle power label
            var musclePowerLabel = document.getElementById(section + 'MusclePowerLabel');
            if (musclePowerLabel) {
                if (location === 'back' || location === 'neck') {
                    musclePowerLabel.textContent = 'Myotome Testing:';
                } else if (location === 'hand') {
                    musclePowerLabel.textContent = 'Hand Grip Strength Testing:';
                } else {
                    musclePowerLabel.textContent = 'Muscle Power (Oxford Manual Muscle Testing Scale):';
                }
            }

            // Update AROM movements
            updateAromFields(section);
            
            // Update muscle power groups
            generateMusclePowerFields(section, location);
            
            // Update special tests and questionnaires based on location
            renderSpecialTests(section);
            renderQuestionnaires(section);
        }

        // Update AROM fields with side-specific logic for back/neck
        function updateAromFields(section) {
            var locationSelect = document.getElementById(section + 'Location');
            var container = document.getElementById(section + 'AromMovements');
            if (!locationSelect || !container) return;

            var location = locationSelect.value;
            var movements = getAromMovements(location);
            container.innerHTML = '';

            if (movements.length === 0) return;

            var includePromCheckbox = document.getElementById(section + 'IncludeProm');
            var includeProm = includePromCheckbox ? includePromCheckbox.checked : false;
            var isBackNeck = (location === 'back' || location === 'neck');
            var sideSelect = document.getElementById(section + 'Side');
            var side = sideSelect ? sideSelect.value.toLowerCase() : '';
            
            for (var i = 0; i < movements.length; i++) {
                var movementDiv = document.createElement('div');
                movementDiv.className = 'muscle-row';
                
                var html = '<div class="muscle-label">' + movements[i] + '</div>';
                html += '<div class="muscle-input">';
                
                if (isBackNeck && (side === 'left' || side === 'right')) {
                    // For back/neck with specific side, show only the unaffected side
                    var showSide = (side === 'left') ? 'Right' : 'Left';
                    html += '<input type="text" class="form-input small-input arom-value" placeholder="e.g., 3/5" onchange="updateAromMovement(\'' + section + '\', ' + i + ', \'arom\', this.value)">';
                    
                    if (includeProm) {
                        html += '<input type="text" class="form-input small-input prom-value" placeholder="e.g., 4/5" style="margin-left: 10px;" onchange="updateAromMovement(\'' + section + '\', ' + i + ', \'prom\', this.value)">';
                    }
                } else {
                    // Normal AROM input for other regions or bilateral back/neck
                    html += '<input type="text" class="form-input small-input arom-value" placeholder="' + 
                            (isBackNeck ? 'e.g., 3/5' : 'e.g., 90') + '" onchange="updateAromMovement(\'' + section + '\', ' + i + ', \'arom\', this.value)">';
                    
                    if (includeProm) {
                        html += '<input type="text" class="form-input small-input prom-value" placeholder="' + 
                                (isBackNeck ? 'e.g., 4/5' : 'e.g., 95') + '" style="margin-left: 10px;" onchange="updateAromMovement(\'' + section + '\', ' + i + ', \'prom\', this.value)">';
                    }
                }
                
                html += '</div>';
                movementDiv.innerHTML = html;
                container.appendChild(movementDiv);
            }

            // Initialize AROM movements array
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings) {
                findings.objectiveFindings.aromMovements = [];
                for (var i = 0; i < movements.length; i++) {
                    findings.objectiveFindings.aromMovements.push({
                        movement: movements[i],
                        arom: '',
                        prom: ''
                    });
                }
            }
        }

        // Update AROM movement value
        function updateAromMovement(section, index, type, value) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings && findings.objectiveFindings.aromMovements[index]) {
                findings.objectiveFindings.aromMovements[index][type] = value;
            }
        }

        // Generate muscle power fields with smart auto-fill
        function generateMusclePowerFields(section, location) {
            var container = document.getElementById(section + 'MusclePowerContainer');
            if (!container) return;

            // Skip if back/neck (uses myotome) or hand (uses grip strength)
            if (location === 'back' || location === 'neck' || location === 'hand') {
                container.innerHTML = '';
                return;
            }

            var muscleGroups = getMuscleGroups(location);
            if (muscleGroups.length === 0) {
                container.innerHTML = '';
                return;
            }

            var sideSelect = document.getElementById(section + 'Side');
            var side = sideSelect ? sideSelect.value.toLowerCase() : '';
            
            var html = '';
            
            // Smart Auto-fill section
            html += '<div style="background: #f0f9ff; padding: 15px; border-radius: 6px; margin-bottom: 15px;">';
            html += '<p style="color: #1e40af; font-weight: 500; margin-bottom: 10px;"><strong>Smart Auto-fill:</strong> Select a grade to apply to all muscle groups, then modify individual groups as needed.</p>';
            html += '<div style="display: flex; gap: 10px; align-items: center;">';
            html += '<select id="' + section + 'AutoFillGrade" class="form-select" style="width: 120px;" onchange="autoFillMusclePower(\'' + section + '\', this.value)">';
            html += '<option value="">Grade</option>';
            for (var j = 0; j <= 5; j++) {
                html += '<option value="' + j + '">' + j + '/5</option>';
            }
            html += '</select>';
            html += '<span style="color: #64748b; font-size: 14px;">Apply to all muscle groups</span>';
            html += '<button type="button" class="btn btn-secondary btn-small" onclick="clearAllMusclePower(\"' + section + '\")" style="margin-left: 10px;">Clear All</button>';
            html += '</div>';
            html += '</div>';
            
            // Individual muscle groups
            for (var i = 0; i < muscleGroups.length; i++) {
                html += '<div class="muscle-row">';
                html += '<div class="muscle-label">' + muscleGroups[i] + '</div>';
                html += '<div class="muscle-input">';
                
                // Only show the unaffected side for unilateral conditions
                if (side === 'left') {
                    // Show only right side for left-sided condition
                    html += '<select class="form-select small-input" onchange="updateMusclePower(\'' + section + '\', ' + i + ', \'rightGrade\', this.value)">';
                    html += '<option value="">Grade</option>';
                    for (var j = 0; j <= 5; j++) {
                        html += '<option value="' + j + '">' + j + ' out of 5</option>';
                    }
                    html += '</select>';
                } else if (side === 'right') {
                    // Show only left side for right-sided condition
                    html += '<select class="form-select small-input" onchange="updateMusclePower(\'' + section + '\', ' + i + ', \'leftGrade\', this.value)">';
                    html += '<option value="">Grade</option>';
                    for (var j = 0; j <= 5; j++) {
                        html += '<option value="' + j + '">' + j + ' out of 5</option>';
                    }
                    html += '</select>';
                } else {
                    // Show single grade field for bilateral or no side specified
                    html += '<select class="form-select small-input" onchange="updateMusclePower(\'' + section + '\', ' + i + ', \'leftGrade\', this.value)">';
                    html += '<option value="">Grade</option>';
                    for (var j = 0; j <= 5; j++) {
                        html += '<option value="' + j + '">' + j + ' out of 5</option>';
                    }
                    html += '</select>';
                }
                
                html += '</div>';
                html += '</div>';
            }

            container.innerHTML = html;

            // Initialize muscle power array
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings) {
                findings.objectiveFindings.musclePower = [];
                for (var i = 0; i < muscleGroups.length; i++) {
                    findings.objectiveFindings.musclePower.push({
                        muscleGroup: muscleGroups[i],
                        leftGrade: '',
                        rightGrade: ''
                    });
                }
            }
        }

        // Auto-fill muscle power grades
        function autoFillMusclePower(section, grade) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;
            
            var sideSelect = document.getElementById(section + 'Side');
            var side = sideSelect ? sideSelect.value.toLowerCase() : '';
            var container = document.getElementById(section + 'MusclePowerContainer');
            if (!container) return;
            
            // Update data and UI simultaneously
            var selects = container.querySelectorAll('select');
            
            for (var i = 0; i < findings.objectiveFindings.musclePower.length; i++) {
                if (side === 'left') {
                    findings.objectiveFindings.musclePower[i].rightGrade = grade;
                    // Update UI - skip auto-fill select (index 0), find the right select for this muscle
                    if (selects[i + 1]) {
                        selects[i + 1].value = grade;
                    }
                } else if (side === 'right') {
                    findings.objectiveFindings.musclePower[i].leftGrade = grade;
                    // Update UI - skip auto-fill select (index 0), find the left select for this muscle
                    if (selects[i + 1]) {
                        selects[i + 1].value = grade;
                    }
                } else {
                    findings.objectiveFindings.musclePower[i].leftGrade = grade;
                    // Update UI - skip auto-fill select (index 0), find the select for this muscle
                    if (selects[i + 1]) {
                        selects[i + 1].value = grade;
                    }
                }
            }
        }

        // Clear all muscle power grades
        function clearAllMusclePower(section) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;
            
            var container = document.getElementById(section + 'MusclePowerContainer');
            if (!container) return;
            
            // Clear data and UI simultaneously
            var selects = container.querySelectorAll('select');
            
            for (var i = 0; i < findings.objectiveFindings.musclePower.length; i++) {
                findings.objectiveFindings.musclePower[i].leftGrade = '';
                findings.objectiveFindings.musclePower[i].rightGrade = '';
                
                // Clear UI - skip auto-fill select (index 0)
                if (selects[i + 1]) {
                    selects[i + 1].value = '';
                }
            }
        }

        // Populate muscle power fields with existing data
        function populateMusclePowerFields(section) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;
            
            var container = document.getElementById(section + 'MusclePowerContainer');
            if (!container) return;
            
            var selects = container.querySelectorAll('select');
            var sideSelect = document.getElementById(section + 'Side');
            var side = sideSelect ? sideSelect.value.toLowerCase() : '';
            
            // Skip the auto-fill select (first one)
            for (var i = 1; i < selects.length; i++) {
                var muscleIndex = i - 1;
                if (findings.objectiveFindings.musclePower[muscleIndex]) {
                    var muscle = findings.objectiveFindings.musclePower[muscleIndex];
                    if (side === 'left') {
                        selects[i].value = muscle.rightGrade || '';
                    } else if (side === 'right') {
                        selects[i].value = muscle.leftGrade || '';
                    } else {
                        selects[i].value = muscle.leftGrade || '';
                    }
                }
            }
        }

        // Update muscle power value
        function updateMusclePower(section, index, type, value) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings && findings.objectiveFindings.musclePower[index]) {
                findings.objectiveFindings.musclePower[index][type] = value;
            }
        }

        // Auto-fill myotome grades
        function autoFillMyotome(section, grade) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;
            
            var container = document.getElementById(section + 'MyotomeContainer');
            if (!container) return;
            
            // Update data and UI simultaneously
            var selects = container.querySelectorAll('select');
            
            for (var i = 0; i < findings.objectiveFindings.myotome.length; i++) {
                findings.objectiveFindings.myotome[i].leftGrade = grade;
                findings.objectiveFindings.myotome[i].rightGrade = grade;
                
                // Update UI - skip auto-fill select (index 0), then pairs (left, right)
                var leftSelectIndex = (i * 2) + 1;
                var rightSelectIndex = (i * 2) + 2;
                
                if (selects[leftSelectIndex]) {
                    selects[leftSelectIndex].value = grade;
                }
                if (selects[rightSelectIndex]) {
                    selects[rightSelectIndex].value = grade;
                }
            }
        }

        // Clear all myotome grades
        function clearAllMyotome(section) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;
            
            var container = document.getElementById(section + 'MyotomeContainer');
            if (!container) return;
            
            // Clear data and UI simultaneously
            var selects = container.querySelectorAll('select');
            
            for (var i = 0; i < findings.objectiveFindings.myotome.length; i++) {
                findings.objectiveFindings.myotome[i].leftGrade = '';
                findings.objectiveFindings.myotome[i].rightGrade = '';
                
                // Clear UI - skip auto-fill select (index 0), then pairs (left, right)
                var leftSelectIndex = (i * 2) + 1;
                var rightSelectIndex = (i * 2) + 2;
                
                if (selects[leftSelectIndex]) {
                    selects[leftSelectIndex].value = '';
                }
                if (selects[rightSelectIndex]) {
                    selects[rightSelectIndex].value = '';
                }
            }
        }

        // Populate myotome fields with existing data
        function populateMyotomeFields(section) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;
            
            var container = document.getElementById(section + 'MyotomeContainer');
            if (!container) return;
            
            var selects = container.querySelectorAll('select');
            
            // Skip the auto-fill select (first one) and process pairs (left, right)
            for (var i = 1; i < selects.length; i += 2) {
                var myotomeIndex = Math.floor((i - 1) / 2);
                if (findings.objectiveFindings.myotome[myotomeIndex]) {
                    var myotome = findings.objectiveFindings.myotome[myotomeIndex];
                    selects[i].value = myotome.leftGrade || '';     // Left select
                    if (selects[i + 1]) {
                        selects[i + 1].value = myotome.rightGrade || ''; // Right select
                    }
                }
            }
        }

        // Generate myotome fields with smart auto-fill
        function generateMyotomeFields(section, location) {
            var container = document.getElementById(section + 'MyotomeContainer');
            if (!container) return;

            var levels = getMyotomeLevels(location);
            if (levels.length === 0) {
                container.innerHTML = '';
                return;
            }

            var html = '';
            
            // Smart Auto-fill section
            html += '<div style="background: #f0f9ff; padding: 15px; border-radius: 6px; margin-bottom: 15px;">';
            html += '<p style="color: #1e40af; font-weight: 500; margin-bottom: 10px;"><strong>Smart Auto-fill:</strong> Select a grade to apply to all levels, then modify individual levels as needed.</p>';
            html += '<div style="display: flex; gap: 10px; align-items: center;">';
            html += '<select id="' + section + 'AutoFillMyotome" class="form-select" style="width: 120px;" onchange="autoFillMyotome(\'' + section + '\', this.value)">';
            html += '<option value="">Grade</option>';
            for (var j = 0; j <= 5; j++) {
                html += '<option value="' + j + '">' + j + '/5</option>';
            }
            html += '</select>';
            html += '<span style="color: #64748b; font-size: 14px;">Auto-fill all levels</span>';
            html += '<button type="button" class="btn btn-secondary btn-small" onclick="clearAllMyotome(\"' + section + '\")" style="margin-left: 10px;">Clear All</button>';
            html += '</div>';
            html += '</div>';
            
            // Individual myotome levels
            for (var i = 0; i < levels.length; i++) {
                html += '<div class="grid-3">';
                html += '<div class="muscle-label">' + levels[i] + '</div>';
                html += '<div>';
                html += '<select class="form-select myotome-left" onchange="updateMyotome(\'' + section + '\', ' + i + ', \'leftGrade\', this.value)">';
                html += '<option value="">Left</option>';
                for (var j = 0; j <= 5; j++) {
                    html += '<option value="' + j + '">' + j + '/5</option>';
                }
                html += '</select>';
                html += '</div>';
                html += '<div>';
                html += '<select class="form-select myotome-right" onchange="updateMyotome(\'' + section + '\', ' + i + ', \'rightGrade\', this.value)">';
                html += '<option value="">Right</option>';
                for (var j = 0; j <= 5; j++) {
                    html += '<option value="' + j + '">' + j + '/5</option>';
                }
                html += '</select>';
                html += '</div>';
                html += '</div>';
            }

            container.innerHTML = html;

            // Initialize myotome array
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings) {
                findings.objectiveFindings.myotome = [];
                for (var i = 0; i < levels.length; i++) {
                    findings.objectiveFindings.myotome.push({
                        level: levels[i],
                        leftGrade: '',
                        rightGrade: ''
                    });
                }
            }
        }

        // Update myotome value
        function updateMyotome(section, index, type, value) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings && findings.objectiveFindings.myotome[index]) {
                findings.objectiveFindings.myotome[index][type] = value;
            }
        }

        // Update activity field
        function updateActivityField(section, index, field, value, activityType) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings && findings.complaints[activityType] && findings.complaints[activityType][index]) {
                findings.complaints[activityType][index][field] = value;
            }
        }

        // Toggle panels
        function toggleAromPanel(section, notTested) {
            var panel = document.getElementById(section + 'AromPanel');
            if (panel) {
                panel.style.display = notTested ? 'none' : 'block';
            }
            updateClinicalField(section, 'objectiveFindings.aromNotTested', notTested);
        }

        function toggleHandGripPanel(section, notTested) {
            var panel = document.getElementById(section + 'HandGripPanel');
            if (panel) {
                panel.style.display = notTested ? 'none' : 'block';
            }
            updateClinicalField(section, 'objectiveFindings.handGripNotTested', notTested);
        }

        function toggleMusclePowerPanel(section, notTested) {
            var panel = document.getElementById(section + 'MusclePowerPanel');
            if (panel) {
                panel.style.display = notTested ? 'none' : 'block';
            }
            updateClinicalField(section, 'objectiveFindings.musclePowerNotTested', notTested);
        }

        // New toggle functions for additional objective findings
        function toggleTendernessPanel(section, include) {
            var panel = document.getElementById(section + 'TendernessPanel');
            if (panel) {
                panel.style.display = include ? 'block' : 'none';
            }
            updateClinicalField(section, 'objectiveFindings.tendernessInclude', include);
        }

        function toggleSwellingPanel(section, include) {
            var panel = document.getElementById(section + 'SwellingPanel');
            if (panel) {
                panel.style.display = include ? 'block' : 'none';
            }
            updateClinicalField(section, 'objectiveFindings.swellingInclude', include);
        }

        function toggleTemperaturePanel(section, include) {
            var panel = document.getElementById(section + 'TemperaturePanel');
            if (panel) {
                panel.style.display = include ? 'block' : 'none';
            }
            updateClinicalField(section, 'objectiveFindings.temperatureInclude', include);
        }

        function toggleSensationPanel(section, include) {
            var panel = document.getElementById(section + 'SensationPanel');
            if (panel) {
                panel.style.display = include ? 'block' : 'none';
            }
            updateClinicalField(section, 'objectiveFindings.sensationInclude', include);
        }

        function updateSensationFields(section, status) {
            updateClinicalField(section, 'objectiveFindings.sensationStatus', status);
            
            var reducedPanel = document.getElementById(section + 'SensationReduced');
            var hypersensitivePanel = document.getElementById(section + 'SensationHypersensitive');
            
            if (reducedPanel) {
                reducedPanel.style.display = (status === 'reduced') ? 'block' : 'none';
            }
            if (hypersensitivePanel) {
                hypersensitivePanel.style.display = (status === 'hypersensitive') ? 'block' : 'none';
            }
        }

        function toggleReflexPanel(section, include) {
            var panel = document.getElementById(section + 'ReflexPanel');
            if (panel) {
                panel.style.display = include ? 'block' : 'none';
            }
            updateClinicalField(section, 'objectiveFindings.reflexInclude', include);
        }

        function toggleWbStatusPanel(section, include) {
            var panel = document.getElementById(section + 'WbStatusPanel');
            if (panel) {
                panel.style.display = include ? 'block' : 'none';
            }
            updateClinicalField(section, 'objectiveFindings.wbStatusInclude', include);
        }

        // Special Tests Functions
        function addSpecialTest(section) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;
            
            findings.objectiveFindings.specialTests.push({ testName: '', result: '' });
            renderSpecialTests(section);
        }

        function removeSpecialTest(section, index) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;
            
            findings.objectiveFindings.specialTests.splice(index, 1);
            renderSpecialTests(section);
        }

        function updateSpecialTest(section, index, field, value) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings && findings.objectiveFindings.specialTests[index]) {
                findings.objectiveFindings.specialTests[index][field] = value;
            }
        }

        function renderSpecialTests(section) {
            var container = document.getElementById(section + 'SpecialTestsContainer');
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!container || !findings) return;

            var html = '';
            var tests = findings.objectiveFindings.specialTests;
            var location = findings.complaints.location;

            // Show prompt for back region
            if (location === 'back' && tests.length === 0) {
                html += '<div class="form-group" style="background: #fef3c7; padding: 10px; border-radius: 6px; margin-bottom: 10px;">';
                html += '<p style="color: #92400e; font-size: 14px; margin: 0;">Please input straight leg raise result for back region.</p>';
                html += '</div>';
            }

            for (var i = 0; i < tests.length; i++) {
                html += '<div class="form-group" style="border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; margin-bottom: 10px;">';
                html += '<div class="form-row">';
                html += '<div class="form-col">';
                html += '<input type="text" class="form-input" placeholder="Test Name (e.g., Phalen\'s test)" value="' + (tests[i].testName || '') + '" onchange="updateSpecialTest(\'' + section + '\', ' + i + ', \'testName\', this.value)">';
                html += '</div>';
                html += '<div class="form-col">';
                html += '<select class="form-select" onchange="updateSpecialTest(\'' + section + '\', ' + i + ', \'result\', this.value)">';
                html += '<option value="">Result</option>';
                html += '<option value="positive"' + (tests[i].result === 'positive' ? ' selected' : '') + '>Positive</option>';
                html += '<option value="negative"' + (tests[i].result === 'negative' ? ' selected' : '') + '>Negative</option>';
                html += '</select>';
                html += '</div>';
                if (tests.length > 0) {
                    html += '<div class="form-col" style="flex: 0 0 auto;">';
                    html += '<button type="button" class="btn btn-secondary btn-small" onclick="removeSpecialTest(\'' + section + '\', ' + i + ')">Remove</button>';
                    html += '</div>';
                }
                html += '</div>';
                html += '<p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0;">Type full name of the test, e.g. straight leg raise</p>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // Questionnaires Functions
        function addQuestionnaire(section) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;
            
            findings.objectiveFindings.questionnaires.push({ name: '', score: '' });
            renderQuestionnaires(section);
        }

        function removeQuestionnaire(section, index) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;
            
            findings.objectiveFindings.questionnaires.splice(index, 1);
            renderQuestionnaires(section);
        }

        function updateQuestionnaire(section, index, field, value) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings && findings.objectiveFindings.questionnaires[index]) {
                findings.objectiveFindings.questionnaires[index][field] = value;
            }
        }

        function renderQuestionnaires(section) {
            var container = document.getElementById(section + 'QuestionnairesContainer');
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!container || !findings) return;

            var html = '';
            var questionnaires = findings.objectiveFindings.questionnaires;
            var location = findings.complaints.location;
            var regionQuestionnaires = getRegionQuestionnaires(location);

            for (var i = 0; i < questionnaires.length; i++) {
                html += '<div class="form-group" style="border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; margin-bottom: 10px;">';
                html += '<div class="form-row">';
                html += '<div class="form-col">';
                html += '<select class="form-select" onchange="updateQuestionnaire(\'' + section + '\', ' + i + ', \'name\', this.value)">';
                html += '<option value="">Select questionnaire</option>';
                for (var j = 0; j < regionQuestionnaires.length; j++) {
                    html += '<option value="' + regionQuestionnaires[j] + '"' + (questionnaires[i].name === regionQuestionnaires[j] ? ' selected' : '') + '>' + regionQuestionnaires[j] + '</option>';
                }
                html += '</select>';
                html += '</div>';
                html += '<div class="form-col">';
                html += '<input type="text" class="form-input" placeholder="Score (e.g., 45%)" value="' + (questionnaires[i].score || '') + '" onchange="updateQuestionnaire(\'' + section + '\', ' + i + ', \'score\', this.value)">';
                html += '</div>';
                if (questionnaires.length > 0) {
                    html += '<div class="form-col" style="flex: 0 0 auto;">';
                    html += '<button type="button" class="btn btn-secondary btn-small" onclick="removeQuestionnaire(\'' + section + '\', ' + i + ')">Remove</button>';
                    html += '</div>';
                }
                html += '</div>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // Get region-specific questionnaires
        function getRegionQuestionnaires(location) {
            var questionnaires = {
                'shoulder': ['QuickDASH'],
                'elbow': ['QuickDASH'],
                'wrist': ['QuickDASH'],
                'hand': ['QuickDASH'],
                'hip': ['Lower Extremity Functional Scale'],
                'ankle': ['Lower Extremity Functional Scale'],
                'foot': ['Lower Extremity Functional Scale'],
                'neck': ['Northwick Park Neck Pain Questionnaire'],
                'back': ['Roland-Morris Disability Questionnaire'],
                'knee': ['Lower Extremity Functional Scale', 'Knee Injury & Osteoarthritis Outcome Score-Pain', 'Knee Injury & Osteoarthritis Outcome Score-PS', 'Knee Injury & Osteoarthritis Outcome Score-QoL']
            };
            return questionnaires[location] || [];
        }

        // Add finger/toe
        function addFingerToe(section) {
            var locationSelect = document.getElementById(section + 'Location');
            var container = document.getElementById(section + 'FingersToesContainer');
            if (!locationSelect || !container) return;

            var location = locationSelect.value;
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;

            var fingerToeIndex = findings.objectiveFindings.fingersToesData.length;
            var fingerToeData = { name: '', joints: [] };
            findings.objectiveFindings.fingersToesData.push(fingerToeData);

            var fingerToeDiv = document.createElement('div');
            fingerToeDiv.className = 'finger-toe-panel';
            fingerToeDiv.setAttribute('data-section', section);
            fingerToeDiv.setAttribute('data-index', fingerToeIndex);

            var html = '<div class="finger-toe-header">';
            html += '<div class="finger-toe-name">';
            html += '<label class="form-label">' + (location === 'hand' ? 'Finger' : 'Toe') + ' Name</label>';
            html += '<input type="text" class="form-input finger-toe-name-input" placeholder="' + 
                    (location === 'hand' ? 'e.g., Middle finger' : 'e.g., 2nd toe') + '" onchange="updateFingerToeName(\'' + section + '\', ' + fingerToeIndex + ', this.value)">';
            html += '</div>';
            
            if (findings.objectiveFindings.fingersToesData.length > 1) {
                html += '<div class="finger-toe-remove">';
                html += '<button type="button" class="btn btn-small btn-secondary" onclick="removeFingerToe(\'' + section + '\', ' + fingerToeIndex + ')">Remove</button>';
                html += '</div>';
            }
            html += '</div>';

            html += '<div class="form-group">';
            html += '<label class="form-label">Small Joints</label>';
            html += '<div class="joint-checkboxes">';
            
            var jointOptions = getSmallJointOptions(location);
            var halfLength = Math.ceil(jointOptions.length / 2);
            
            html += '<div class="joint-checkbox-col">';
            for (var i = 0; i < halfLength; i++) {
                html += '<div class="joint-checkbox-item">';
                html += '<input type="checkbox" id="' + section + '_joint_' + fingerToeIndex + '_' + jointOptions[i].value + '" class="checkbox" onchange="toggleJoint(\'' + section + '\', ' + fingerToeIndex + ', \'' + jointOptions[i].value + '\', this.checked)">';
                html += '<label for="' + section + '_joint_' + fingerToeIndex + '_' + jointOptions[i].value + '">' + jointOptions[i].label + '</label>';
                html += '</div>';
            }
            html += '</div>';
            
            html += '<div class="joint-checkbox-col">';
            for (var i = halfLength; i < jointOptions.length; i++) {
                html += '<div class="joint-checkbox-item">';
                html += '<input type="checkbox" id="' + section + '_joint_' + fingerToeIndex + '_' + jointOptions[i].value + '" class="checkbox" onchange="toggleJoint(\'' + section + '\', ' + fingerToeIndex + ', \'' + jointOptions[i].value + '\', this.checked)">';
                html += '<label for="' + section + '_joint_' + fingerToeIndex + '_' + jointOptions[i].value + '">' + jointOptions[i].label + '</label>';
                html += '</div>';
            }
            html += '</div>';
            html += '</div>';

            html += '<div class="joint-ranges" id="' + section + '_joint_ranges_' + fingerToeIndex + '"></div>';
            html += '</div>';

            fingerToeDiv.innerHTML = html;
            container.appendChild(fingerToeDiv);
        }

        // Update finger/toe name
        function updateFingerToeName(section, index, name) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings && findings.objectiveFindings.fingersToesData[index]) {
                findings.objectiveFindings.fingersToesData[index].name = name;
            }
        }

        // Toggle joint
        function toggleJoint(section, fingerToeIndex, jointType, checked) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings || !findings.objectiveFindings.fingersToesData[fingerToeIndex]) return;

            var joints = findings.objectiveFindings.fingersToesData[fingerToeIndex].joints;
            
            if (checked) {
                // Add joint
                joints.push({ jointType: jointType, range: '' });
            } else {
                // Remove joint
                for (var i = 0; i < joints.length; i++) {
                    if (joints[i].jointType === jointType) {
                        joints.splice(i, 1);
                        break;
                    }
                }
            }

            updateJointRanges(section, fingerToeIndex);
        }

        // Update joint ranges
        function updateJointRanges(section, fingerToeIndex) {
            var container = document.getElementById(section + '_joint_ranges_' + fingerToeIndex);
            var findings = LiteAppState.reportData[section + 'Findings'];
            
            if (!container || !findings || !findings.objectiveFindings.fingersToesData[fingerToeIndex]) return;

            var joints = findings.objectiveFindings.fingersToesData[fingerToeIndex].joints;
            var locationSelect = document.getElementById(section + 'Location');
            var location = locationSelect ? locationSelect.value : '';
            var jointOptions = getSmallJointOptions(location);

            container.innerHTML = '';

            if (joints.length > 0) {
                var headerDiv = document.createElement('div');
                headerDiv.innerHTML = '<label class="form-label">Joint Ranges</label>';
                container.appendChild(headerDiv);

                for (var i = 0; i < joints.length; i++) {
                    var joint = joints[i];
                    var jointOption = null;
                    for (var j = 0; j < jointOptions.length; j++) {
                        if (jointOptions[j].value === joint.jointType) {
                            jointOption = jointOptions[j];
                            break;
                        }
                    }
                    
                    if (jointOption) {
                        var rangeDiv = document.createElement('div');
                        rangeDiv.className = 'muscle-row';
                        rangeDiv.innerHTML = 
                            '<div class="muscle-label">' + jointOption.label + '</div>' +
                            '<div class="muscle-input">' +
                                '<input type="text" class="form-input small-input" placeholder="e.g., 5-70" value="' + joint.range + '" onchange="updateJointRange(\'' + section + '\', ' + fingerToeIndex + ', ' + i + ', this.value)">' +
                            '</div>';
                        container.appendChild(rangeDiv);
                    }
                }
            }
        }

        // Update joint range
        function updateJointRange(section, fingerToeIndex, jointIndex, value) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings && findings.objectiveFindings.fingersToesData[fingerToeIndex] && 
                findings.objectiveFindings.fingersToesData[fingerToeIndex].joints[jointIndex]) {
                findings.objectiveFindings.fingersToesData[fingerToeIndex].joints[jointIndex].range = value;
            }
        }

        // Remove finger/toe
        function removeFingerToe(section, index) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (findings && findings.objectiveFindings.fingersToesData[index]) {
                findings.objectiveFindings.fingersToesData.splice(index, 1);
                
                // Re-render the container
                var container = document.getElementById(section + 'FingersToesContainer');
                if (container) {
                    container.innerHTML = '';
                    // Re-add all remaining finger/toe panels
                    for (var i = 0; i < findings.objectiveFindings.fingersToesData.length; i++) {
                        addFingerToe(section);
                        // Restore data
                        var nameInput = container.querySelector('[data-index="' + i + '"] .finger-toe-name-input');
                        if (nameInput) {
                            nameInput.value = findings.objectiveFindings.fingersToesData[i].name;
                        }
                    }
                }
            }
        }

        // Copy from initial findings to target section - REWRITTEN BASED ON FULL APP LOGIC
        function copyFromInitial(targetSection) {
            console.log('=== COPY FUNCTION START ===');
            console.log('Target section:', targetSection);
            
            var sourceFindings = LiteAppState.reportData.initialFindings;
            var targetFindings = LiteAppState.reportData[targetSection + 'Findings'];
            
            if (!sourceFindings) {
                console.error('Source findings not found');
                return;
            }
            
            console.log('Source findings:', sourceFindings);
            console.log('Target findings before copy:', targetFindings);
            
            // EXACT SAME LOGIC AS FULL APP: Deep copy using JSON parse/stringify
            var copiedFindings = JSON.parse(JSON.stringify(sourceFindings));
            
            // EXACT SAME LOGIC AS FULL APP: Preserve the original date of the target section
            var originalDate = targetFindings ? targetFindings.date : '';
            copiedFindings.date = originalDate;
            
            console.log('Preserving original date:', originalDate);
            
            // Update the target findings
            LiteAppState.reportData[targetSection + 'Findings'] = copiedFindings;
            
            console.log('Target findings after copy:', LiteAppState.reportData[targetSection + 'Findings']);
            
            // COMPLETE RE-RENDER: Just like React would do automatically
            console.log('Re-rendering entire clinical findings section for:', targetSection);
            renderClinicalFindings(targetSection);
            
            // CRITICAL: Add delay to ensure DOM is updated before populating fields
            setTimeout(function() {
                console.log('Populating form fields after DOM update for:', targetSection);
                populateFormFields(targetSection);
                console.log('Form fields populated successfully');
            }, 100);
            
            console.log('=== COPY FUNCTION END ===');
            
            alert('Clinical findings copied from Initial to ' + (targetSection.charAt(0).toUpperCase() + targetSection.slice(1)) + ' section successfully!');
        }

        // Populate form fields with data
        function populateFormFields(section) {
            var findings = LiteAppState.reportData[section + 'Findings'];
            if (!findings) return;

            // Populate basic fields
            var dateInput = document.getElementById(section + 'Date');
            if (dateInput) dateInput.value = findings.date || '';

            var sideSelect = document.getElementById(section + 'Side');
            if (sideSelect) sideSelect.value = findings.complaints.side || '';

            var locationSelect = document.getElementById(section + 'Location');
            if (locationSelect) {
                locationSelect.value = findings.complaints.location || '';
                updateLocationFields(section, findings.complaints.location);
            }

            var painIntensityInput = document.getElementById(section + 'PainIntensity');
            if (painIntensityInput) painIntensityInput.value = findings.complaints.painIntensity || '';

            var otherSymptomsInput = document.getElementById(section + 'OtherSymptoms');
            if (otherSymptomsInput) otherSymptomsInput.value = findings.complaints.otherSymptoms || '';

            var symptomsIntensityInput = document.getElementById(section + 'SymptomsIntensity');
            if (symptomsIntensityInput) symptomsIntensityInput.value = findings.complaints.symptomIntensity || '';

            // Populate activity fields
            if (findings.complaints.activities1 && findings.complaints.activities1[0]) {
                var activity1Select = document.getElementById(section + 'Activity1');
                if (activity1Select) activity1Select.value = findings.complaints.activities1[0].activity || '';

                var activity1DurationInput = document.getElementById(section + 'Activity1Duration');
                if (activity1DurationInput) activity1DurationInput.value = findings.complaints.activities1[0].duration || '';

                var activity1UnitSelect = document.getElementById(section + 'Activity1Unit');
                if (activity1UnitSelect) activity1UnitSelect.value = findings.complaints.activities1[0].unit || 'minutes';
            }

            if (findings.complaints.activities2 && findings.complaints.activities2[0]) {
                var activity2Select = document.getElementById(section + 'Activity2');
                if (activity2Select) activity2Select.value = findings.complaints.activities2[0].activity || '';

                var activity2DurationInput = document.getElementById(section + 'Activity2Duration');
                if (activity2DurationInput) activity2DurationInput.value = findings.complaints.activities2[0].duration || '';

                var activity2UnitSelect = document.getElementById(section + 'Activity2Unit');
                if (activity2UnitSelect) activity2UnitSelect.value = findings.complaints.activities2[0].unit || 'minutes';

                var activity2AidSelect = document.getElementById(section + 'Activity2Aid');
                if (activity2AidSelect) activity2AidSelect.value = findings.complaints.activities2[0].aid || '';
            }

            var otherFunctionalActivitiesTextarea = document.getElementById(section + 'OtherFunctionalActivities');
            if (otherFunctionalActivitiesTextarea) otherFunctionalActivitiesTextarea.value = findings.complaints.otherFunctionalActivities || '';

            var overallImprovementSelect = document.getElementById(section + 'OverallImprovement');
            if (overallImprovementSelect) overallImprovementSelect.value = findings.complaints.overallImprovement || '';

            // Populate objective findings checkboxes
            var aromNotTestedCheckbox = document.getElementById(section + 'AromNotTested');
            if (aromNotTestedCheckbox) {
                aromNotTestedCheckbox.checked = findings.objectiveFindings.aromNotTested || false;
                toggleAromPanel(section, aromNotTestedCheckbox.checked);
            }

            var includePromCheckbox = document.getElementById(section + 'IncludeProm');
            if (includePromCheckbox) {
                includePromCheckbox.checked = findings.objectiveFindings.includeProm || false;
                updateAromFields(section);
            }

            var handGripNotTestedCheckbox = document.getElementById(section + 'HandGripNotTested');
            if (handGripNotTestedCheckbox) {
                handGripNotTestedCheckbox.checked = findings.objectiveFindings.handGripNotTested || false;
                toggleHandGripPanel(section, handGripNotTestedCheckbox.checked);
            }

            var musclePowerNotTestedCheckbox = document.getElementById(section + 'MusclePowerNotTested');
            if (musclePowerNotTestedCheckbox) {
                musclePowerNotTestedCheckbox.checked = findings.objectiveFindings.musclePowerNotTested || false;
                toggleMusclePowerPanel(section, musclePowerNotTestedCheckbox.checked);
            }

            // Populate hand grip strength
            if (findings.objectiveFindings.handGripStrength) {
                var leftHandGripInput = document.getElementById(section + 'LeftHandGrip');
                if (leftHandGripInput) leftHandGripInput.value = findings.objectiveFindings.handGripStrength.leftHandGrip || '';

                var rightHandGripInput = document.getElementById(section + 'RightHandGrip');
                if (rightHandGripInput) rightHandGripInput.value = findings.objectiveFindings.handGripStrength.rightHandGrip || '';

                var leftPinchGripInput = document.getElementById(section + 'LeftPinchGrip');
                if (leftPinchGripInput) leftPinchGripInput.value = findings.objectiveFindings.handGripStrength.leftPinchGrip || '';

                var rightPinchGripInput = document.getElementById(section + 'RightPinchGrip');
                if (rightPinchGripInput) rightPinchGripInput.value = findings.objectiveFindings.handGripStrength.rightPinchGrip || '';

                var leftLateralPinchInput = document.getElementById(section + 'LeftLateralPinch');
                if (leftLateralPinchInput) leftLateralPinchInput.value = findings.objectiveFindings.handGripStrength.leftLateralPinch || '';

                var rightLateralPinchInput = document.getElementById(section + 'RightLateralPinch');
                if (rightLateralPinchInput) rightLateralPinchInput.value = findings.objectiveFindings.handGripStrength.rightLateralPinch || '';
            }

            // Populate additional objective findings
            var tendernessIncludeCheckbox = document.getElementById(section + 'TendernessInclude');
            if (tendernessIncludeCheckbox) {
                tendernessIncludeCheckbox.checked = findings.objectiveFindings.tendernessInclude || false;
                toggleTendernessPanel(section, tendernessIncludeCheckbox.checked);
            }

            var tendernessAreaInput = document.getElementById(section + 'TendernessArea');
            if (tendernessAreaInput) tendernessAreaInput.value = findings.objectiveFindings.tendernessArea || '';

            var swellingIncludeCheckbox = document.getElementById(section + 'SwellingInclude');
            if (swellingIncludeCheckbox) {
                swellingIncludeCheckbox.checked = findings.objectiveFindings.swellingInclude || false;
                toggleSwellingPanel(section, swellingIncludeCheckbox.checked);
            }

            var swellingPresentRadio = document.getElementById(section + 'SwellingPresent');
            var swellingAbsentRadio = document.getElementById(section + 'SwellingAbsent');
            if (swellingPresentRadio && swellingAbsentRadio) {
                swellingPresentRadio.checked = findings.objectiveFindings.swellingPresent === true;
                swellingAbsentRadio.checked = findings.objectiveFindings.swellingPresent === false;
            }

            var temperatureIncludeCheckbox = document.getElementById(section + 'TemperatureInclude');
            if (temperatureIncludeCheckbox) {
                temperatureIncludeCheckbox.checked = findings.objectiveFindings.temperatureInclude || false;
                toggleTemperaturePanel(section, temperatureIncludeCheckbox.checked);
            }

            var temperatureIncreasedRadio = document.getElementById(section + 'TemperatureIncreased');
            var temperatureNormalRadio = document.getElementById(section + 'TemperatureNormal');
            if (temperatureIncreasedRadio && temperatureNormalRadio) {
                temperatureIncreasedRadio.checked = findings.objectiveFindings.temperatureIncreased === true;
                temperatureNormalRadio.checked = findings.objectiveFindings.temperatureIncreased === false;
            }

            var sensationIncludeCheckbox = document.getElementById(section + 'SensationInclude');
            if (sensationIncludeCheckbox) {
                sensationIncludeCheckbox.checked = findings.objectiveFindings.sensationInclude || false;
                toggleSensationPanel(section, sensationIncludeCheckbox.checked);
            }

            var sensationStatusSelect = document.getElementById(section + 'SensationStatus');
            if (sensationStatusSelect) {
                sensationStatusSelect.value = findings.objectiveFindings.sensationStatus || 'intact';
                updateSensationFields(section, sensationStatusSelect.value);
            }

            var sensationReductionInput = document.getElementById(section + 'SensationReduction');
            if (sensationReductionInput) sensationReductionInput.value = findings.objectiveFindings.sensationReduction || '';

            var areaReducedInput = document.getElementById(section + 'AreaReduced');
            if (areaReducedInput) areaReducedInput.value = findings.objectiveFindings.areaReduced || '';

            var areaHypersensitiveInput = document.getElementById(section + 'AreaHypersensitive');
            if (areaHypersensitiveInput) areaHypersensitiveInput.value = findings.objectiveFindings.areaHypersensitive || '';

            var reflexIncludeCheckbox = document.getElementById(section + 'ReflexInclude');
            if (reflexIncludeCheckbox) {
                reflexIncludeCheckbox.checked = findings.objectiveFindings.reflexInclude || false;
                toggleReflexPanel(section, reflexIncludeCheckbox.checked);
            }

            var reflexNormalRadio = document.getElementById(section + 'ReflexNormal');
            var reflexAbnormalRadio = document.getElementById(section + 'ReflexAbnormal');
            if (reflexNormalRadio && reflexAbnormalRadio) {
                reflexNormalRadio.checked = findings.objectiveFindings.reflexNormal === true;
                reflexAbnormalRadio.checked = findings.objectiveFindings.reflexNormal === false;
            }

            var walkingAidSelect = document.getElementById(section + 'WalkingAid');
            if (walkingAidSelect) walkingAidSelect.value = findings.objectiveFindings.walkingAid || '';

            var walkingStabilitySelect = document.getElementById(section + 'WalkingStability');
            if (walkingStabilitySelect) walkingStabilitySelect.value = findings.objectiveFindings.walkingStability || '';

            var wbStatusIncludeCheckbox = document.getElementById(section + 'WbStatusInclude');
            if (wbStatusIncludeCheckbox) {
                wbStatusIncludeCheckbox.checked = findings.objectiveFindings.wbStatusInclude || false;
                toggleWbStatusPanel(section, wbStatusIncludeCheckbox.checked);
            }

            var wbStatusSelect = document.getElementById(section + 'WbStatus');
            if (wbStatusSelect) wbStatusSelect.value = findings.objectiveFindings.wbStatus || '';

            // Populate toes ROM for ankle
            var toesROMInput = document.getElementById(section + 'ToesROM');
            if (toesROMInput) toesROMInput.value = findings.objectiveFindings.toesROM || '';
        }

        // ===== REFERRAL SOURCES =====

        function initializeReferralSources() {
            renderReferralSources();
        }

        function renderReferralSources() {
            var container = document.getElementById('referralSourcesContainer');
            if (!container || !LiteAppState.reportData) return;

            var html = '';
            var sources = LiteAppState.reportData.referralSources;

            for (var i = 0; i < sources.length; i++) {
                html += '<div class="form-group" style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 6px; margin-bottom: 15px;">';
                html += '<div class="form-row">';
                html += '<div class="form-col">';
                html += '<label class="form-label">Episode:</label>';
                html += '<select class="form-select" onchange="updateReferralSource(' + i + ', \'episode\', this.value)">';
                html += '<option value="">Select Episode</option>';
                html += '<option value="1st"' + (sources[i].episode === '1st' ? ' selected' : '') + '>1st</option>';
                html += '<option value="2nd"' + (sources[i].episode === '2nd' ? ' selected' : '') + '>2nd</option>';
                html += '<option value="3rd"' + (sources[i].episode === '3rd' ? ' selected' : '') + '>3rd</option>';
                html += '<option value="4th"' + (sources[i].episode === '4th' ? ' selected' : '') + '>4th</option>';
                html += '</select>';
                html += '</div>';
                html += '<div class="form-col">';
                html += '<label class="form-label">Department:</label>';
                html += '<input type="text" class="form-input" placeholder="e.g., Orthopedics" value="' + (sources[i].department || '') + '" onchange="updateReferralSource(' + i + ', \'department\', this.value)">';
                html += '</div>';
                html += '</div>';
                html += '<div class="form-row">';
                html += '<div class="form-col">';
                html += '<label class="form-label">Hospital:</label>';
                html += '<input type="text" class="form-input" placeholder="e.g., General Hospital" value="' + (sources[i].hospital || '') + '" onchange="updateReferralSource(' + i + ', \'hospital\', this.value)">';
                html += '</div>';
                if (sources.length > 1) {
                    html += '<div class="form-col" style="display: flex; align-items: end;">';
                    html += '<button type="button" class="btn btn-secondary btn-small" onclick="removeReferralSource(' + i + ')">Remove</button>';
                    html += '</div>';
                }
                html += '</div>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function addReferralSource() {
            if (!LiteAppState.reportData) return;
            
            LiteAppState.reportData.referralSources.push({
                episode: '',
                department: '',
                hospital: ''
            });
            
            renderReferralSources();
        }

        function removeReferralSource(index) {
            if (!LiteAppState.reportData || LiteAppState.reportData.referralSources.length <= 1) return;
            
            LiteAppState.reportData.referralSources.splice(index, 1);
            renderReferralSources();
        }

        function updateReferralSource(index, field, value) {
            if (!LiteAppState.reportData || !LiteAppState.reportData.referralSources[index]) return;
            
            LiteAppState.reportData.referralSources[index][field] = value;
        }

        // ===== TREATMENT METHODS =====

        function initializeTreatmentMethods() {
            renderTreatmentMethods();
        }

        function renderTreatmentMethods() {
            var container = document.getElementById('treatmentMethodsContainer');
            if (!container) return;

            var treatmentCategories = [
                {
                    title: 'Thermal Therapy',
                    methods: [
                        { id: 'hotPack', label: 'Hot pack', areas: ['Back', 'Neck', 'Shoulder', 'Knee'] },
                        { id: 'coldPack', label: 'Cold pack', areas: ['Back', 'Neck', 'Shoulder', 'Knee'] },
                        { id: 'waxTherapy', label: 'Wax therapy', areas: ['Hand', 'Wrist', 'Foot'] },
                        { id: 'hydrotherapy', label: 'Hydrotherapy', areas: ['Full Body', 'Lower Limb'] }
                    ]
                },
                {
                    title: 'Electrical Therapy',
                    methods: [
                        { id: 'interferentialElectricalTherapy', label: 'Interferential electrical therapy', areas: ['Back', 'Neck', 'Shoulder', 'Knee'] },
                        { id: 'neuromuscularElectricalStimulation', label: 'Neuromuscular electrical stimulation', areas: ['Muscle Specific'] },
                        { id: 'transcutaneousElectricalNerveStimulation', label: 'Transcutaneous Electrical Nerve Stimulation (TENS)', areas: ['Pain Areas'] },
                        { id: 'ultrasoundTherapy', label: 'Ultrasound therapy', areas: ['Soft Tissue'] },
                        { id: 'pulsedElectromagneticFieldTherapy', label: 'Pulsed electromagnetic field therapy', areas: ['Joint', 'Bone'] },
                        { id: 'shockwaveTherapy', label: 'Shockwave therapy', areas: ['Tendon', 'Plantar Fascia'] },
                        { id: 'microCurrentTherapy', label: 'Micro-current therapy', areas: ['Wound', 'Tissue Healing'] },
                        { id: 'infraredLightTherapy', label: 'Infrared light therapy', areas: ['Superficial Tissue'] },
                        { id: 'polarizedPolychromaticLightTherapy', label: 'Polarized polychromatic light therapy', areas: ['Wound', 'Pain Areas'] },
                        { id: 'highElectromagneticInductiveTherapy', label: 'High electromagnetic inductive therapy', areas: ['Deep Muscle'] },
                        { id: 'pulsedShortwaveTherapy', label: 'Pulsed shortwave therapy', areas: ['Deep Tissue'] },
                        { id: 'flowpulseTherapy', label: 'Flowpulse therapy', areas: ['Circulation'] },
                        { id: 'laserTherapy', label: 'Laser therapy', areas: ['Tissue Repair', 'Pain Relief'] }
                    ]
                },
                {
                    title: 'Traction Therapy',
                    methods: [
                        { id: 'intermittentLumbarTraction', label: 'Intermittent lumbar traction', areas: ['Lumbar Spine'] },
                        { id: 'intermittentNeckTraction', label: 'Intermittent neck traction', areas: ['Cervical Spine'] }
                    ]
                },
                {
                    title: 'Manual Therapy',
                    methods: [
                        { id: 'manualTherapy', label: 'Manual therapy', areas: ['Back', 'Neck', 'Shoulder', 'Hip', 'Knee'] }
                    ]
                },
                {
                    title: 'Exercise Therapy',
                    methods: [
                        { id: 'mobilizationExercise', label: 'Mobilization exercise', areas: ['Joint Specific'] },
                        { id: 'strengtheningExercise', label: 'Strengthening exercise', areas: ['Muscle Specific'] },
                        { id: 'exerciseTherapy', label: 'Exercise therapy', areas: ['General'] }
                    ]
                },
                {
                    title: 'Functional Training',
                    methods: [
                        { id: 'balanceTraining', label: 'Balance training', areas: ['Standing', 'Dynamic'] },
                        { id: 'gaitTraining', label: 'Gait training', areas: ['Walking', 'Stairs'] },
                        { id: 'functionalTraining', label: 'Functional training', areas: ['ADL Specific'] }
                    ]
                },
                {
                    title: 'Others',
                    methods: [
                        { id: 'desensitizationTraining', label: 'De-sensitization training', areas: ['Affected Area'] },
                        { id: 'acupuncture', label: 'Acupuncture', areas: ['Acupoints'] }
                    ]
                }
            ];

            var html = '<div class="treatment-grid">';

            for (var i = 0; i < treatmentCategories.length; i++) {
                var category = treatmentCategories[i];
                html += '<div class="treatment-category">';
                html += '<h4>' + category.title + '</h4>';

                for (var j = 0; j < category.methods.length; j++) {
                    var method = category.methods[j];
                    html += '<div class="treatment-item">';
                    html += '<input type="checkbox" id="' + method.id + '" class="checkbox" onchange="updateTreatmentMethod(\'' + method.id + '\', \'' + method.label + '\', this.checked)">';
                    html += '<label for="' + method.id + '">' + method.label + '</label>';
                    html += '</div>';
                }

                html += '</div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function updateTreatmentMethod(methodId, methodLabel, checked) {
            if (!LiteAppState.reportData) return;

            if (checked) {
                // Add treatment method (no area field needed)
                var existingIndex = -1;
                for (var i = 0; i < LiteAppState.reportData.treatments.length; i++) {
                    if (LiteAppState.reportData.treatments[i].method === methodLabel) {
                        existingIndex = i;
                        break;
                    }
                }
                
                if (existingIndex === -1) {
                    LiteAppState.reportData.treatments.push({
                        method: methodLabel,
                        area: '' // Empty area for full app compatibility
                    });
                }
            } else {
                // Remove treatment method
                for (var i = LiteAppState.reportData.treatments.length - 1; i >= 0; i--) {
                    if (LiteAppState.reportData.treatments[i].method === methodLabel) {
                        LiteAppState.reportData.treatments.splice(i, 1);
                    }
                }
            }
        }


        // ===== DISCHARGE SUMMARY =====

        function initializeDischargeSummary() {
            renderDischargeSummary();
        }

        // ===== DISCHARGE SUMMARY - DISCHARGE STATUS ONLY (FROM FULL APP) =====
        
        function renderDischargeSummary() {
            var container = document.getElementById('dischargeSummaryContainer');
            if (!container) return;

            var html = '';

            // Discharge Status Section (Exact copy from full app)
            html += '<div class="discharge-section">';
            html += '<h4>Discharge Status</h4>';
            
            // Discharge Type
            html += '<div class="form-group">';
            html += '<label class="form-label">Discharge Type</label>';
            html += '<select id="dischargeType" class="form-select" onchange="updateDischargeType(this.value)">';
            html += '<option value="">Select discharge type</option>';
            html += '<option value="completed">Discharged</option>';
            html += '<option value="static">Discharged with static progress</option>';
            html += '<option value="ongoing">Still receiving physiotherapy</option>';
            html += '<option value="defaulted">Defaulted</option>';
            html += '<option value="cancelled">Cancelled</option>';
            html += '</select>';
            html += '</div>';
            
            // Conditional fields based on discharge type
            html += '<div id="dischargeFields"></div>';
            
            html += '</div>';

            container.innerHTML = html;
        }
        
        function updateDischargeType(dischargeType) {
            if (!LiteAppState.reportData) return;
            
            // Update the discharge type in data
            if (!LiteAppState.reportData.dischargeSummary.componentData) {
                LiteAppState.reportData.dischargeSummary.componentData = {};
            }
            LiteAppState.reportData.dischargeSummary.componentData.dischargeType = dischargeType;
            
            // Render conditional fields
            renderDischargeFields(dischargeType);
        }
        
        function renderDischargeFields(dischargeType) {
            var container = document.getElementById('dischargeFields');
            if (!container) return;
            
            var html = '';
            
            // Discharge Date for completed and static
            if (dischargeType === 'completed' || dischargeType === 'static') {
                html += '<div class="form-group">';
                html += '<label class="form-label">Discharge Date</label>';
                html += '<input type="date" id="dischargeDate" class="form-input" onchange="updateDischargeField(\'dischargeDate\', this.value)">';
                html += '</div>';
            }
            
            // Default Date for defaulted
            if (dischargeType === 'defaulted') {
                html += '<div class="form-group">';
                html += '<label class="form-label">Default Date</label>';
                html += '<input type="date" id="defaultDate" class="form-input" onchange="updateDischargeField(\'dischargeDate\', this.value)">';
                html += '</div>';
            }
            
            // Cancellation fields for cancelled
            if (dischargeType === 'cancelled') {
                html += '<div class="form-row">';
                html += '<div class="form-col">';
                html += '<label class="form-label">Cancellation Date</label>';
                html += '<input type="date" id="cancellationDate" class="form-input" onchange="updateDischargeField(\'cancellationDate\', this.value)">';
                html += '</div>';
                html += '<div class="form-col">';
                html += '<label class="form-label">Scheduled Appointment Date</label>';
                html += '<input type="date" id="appointmentDate" class="form-input" onchange="updateDischargeField(\'appointmentDate\', this.value)">';
                html += '</div>';
                html += '</div>';
                html += '<div class="form-group">';
                html += '<label class="form-label">Cancellation Reason</label>';
                html += '<input type="text" id="cancellationReason" class="form-input" placeholder="e.g., personal reasons, medical condition" onchange="updateDischargeField(\'cancellationReason\', this.value)">';
                html += '</div>';
            }
            
            container.innerHTML = html;
            
            // Populate existing values if they exist
            populateDischargeFields();
        }
        
        function updateDischargeField(field, value) {
            if (!LiteAppState.reportData) return;
            
            if (!LiteAppState.reportData.dischargeSummary.componentData) {
                LiteAppState.reportData.dischargeSummary.componentData = {};
            }
            
            LiteAppState.reportData.dischargeSummary.componentData[field] = value;
        }
        
        function populateDischargeFields() {
            if (!LiteAppState.reportData || !LiteAppState.reportData.dischargeSummary.componentData) return;
            
            var data = LiteAppState.reportData.dischargeSummary.componentData;
            
            // Populate discharge type
            var dischargeTypeSelect = document.getElementById('dischargeType');
            if (dischargeTypeSelect && data.dischargeType) {
                dischargeTypeSelect.value = data.dischargeType;
            }
            
            // Populate other fields
            var fields = ['dischargeDate', 'cancellationDate', 'appointmentDate', 'cancellationReason'];
            for (var i = 0; i < fields.length; i++) {
                var field = fields[i];
                var element = document.getElementById(field) || document.getElementById('defaultDate');
                if (element && data[field]) {
                    element.value = data[field];
                }
            }
        }



        // ===== ENHANCED MOCK DATA =====

        // Mock data selector state
        var showMockDataSelector = false;
        
        function toggleMockDataSelector() {
            showMockDataSelector = !showMockDataSelector;
            renderMockDataSelector();
        }
        
        function renderMockDataSelector() {
            var container = document.getElementById('mockDataContainer');
            if (!container) return;
            
            var html = '';
            
            if (!showMockDataSelector) {
                html += '<button type="button" class="btn btn-secondary" onclick="toggleMockDataSelector()">Fill Mock Data</button>';
            } else {
                html += '<div class="mock-data-selector" style="display: inline-block;">';
                html += '<div class="mock-scenarios" style="display: flex; gap: 5px; margin-bottom: 5px;">';
                html += '<button type="button" class="btn btn-primary btn-small" onclick="fillMockDataByScenario(\'back\')">Back Case</button>';
                html += '<button type="button" class="btn btn-success btn-small" onclick="fillMockDataByScenario(\'hand\')">Hand Case</button>';
                html += '</div>';
                html += '<button type="button" class="btn btn-secondary btn-small" onclick="toggleMockDataSelector()">Cancel</button>';
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function fillMockDataByScenario(scenario) {
            switch (scenario) {
                case 'back':
                    fillBackCaseMockData();
                    break;
                case 'hand':
                    fillHandCaseMockData();
                    break;
                default:
                    alert('Invalid scenario');
                    return;
            }
            
            // Hide selector after selection
            showMockDataSelector = false;
            renderMockDataSelector();
        }
        
        function fillBackCaseMockData() {
            if (!LiteAppState.reportData) return;

            // Fill basic information - Back Case
            LiteAppState.reportData.ourRef = 'PT/2024/BACK001';
            LiteAppState.reportData.yourRef = 'DOC/2024/BACK001';
            LiteAppState.reportData.recipient = 'Dr. Michael Chen';
            LiteAppState.reportData.patientName = 'Wong, Tai Ming';
            LiteAppState.reportData.patientSex = 'Male';
            LiteAppState.reportData.patientAge = '45';
            LiteAppState.reportData.hkidNo = 'A123456(7)';
            LiteAppState.reportData.physiotherapyOpdNo = 'PT123456';
            LiteAppState.reportData.diagnosis = 'Lower back pain with muscle spasm';
            LiteAppState.reportData.totalSessions = '12';
            LiteAppState.reportData.attendedSessions = '10';
            LiteAppState.reportData.defaultedSessions = '2';
            LiteAppState.reportData.registrationDate = '2024-11-01';
            LiteAppState.reportData.treatmentPeriodStart = '2024-11-05';
            LiteAppState.reportData.treatmentPeriodEnd = '2024-12-10';
            LiteAppState.reportData.caseTherapists = 'Sarah Johnson, PT';
            LiteAppState.reportData.reportWriter = 'Dr. Sarah Johnson';
            LiteAppState.reportData.consentDate = '2024-11-01';
            
            // Fill referral sources
            LiteAppState.reportData.referralSources = [
                { episode: '1st', department: 'Orthopedics', hospital: 'Queen Mary Hospital' }
            ];
            
            // Fill initial findings - Back Case
            var initialFindings = LiteAppState.reportData.initialFindings;
            initialFindings.date = '2024-11-05';
            initialFindings.complaints.side = '';
            initialFindings.complaints.location = 'back';
            initialFindings.complaints.painIntensity = '8';
            initialFindings.complaints.otherSymptoms = 'Stiffness, muscle spasm';
            initialFindings.complaints.symptomIntensity = '7';
            initialFindings.complaints.activities1[0] = { activity: 'sitting', duration: '10', unit: 'minutes' };
            initialFindings.complaints.activities2[0] = { activity: 'walking', duration: '5', unit: 'minutes', aid: 'unaided' };
            initialFindings.complaints.overallImprovement = '2';
            
            // Objective findings - Back Case Initial
            initialFindings.objectiveFindings.aromMovements = [
                { movement: 'Flexion', arom: '30', prom: '40' },
                { movement: 'Extension', arom: '10', prom: '15' },
                { movement: 'Left Lateral Flexion', arom: '20', prom: '25' },
                { movement: 'Right Lateral Flexion', arom: '18', prom: '23' },
                { movement: 'Left Rotation', arom: '25', prom: '30' },
                { movement: 'Right Rotation', arom: '22', prom: '28' }
            ];
            
            initialFindings.objectiveFindings.musclePower = [
                { muscleGroup: 'Erector Spinae', leftGrade: '3', rightGrade: '3' },
                { muscleGroup: 'Multifidus', leftGrade: '2', rightGrade: '2' },
                { muscleGroup: 'Quadratus Lumborum', leftGrade: '3', rightGrade: '2' },
                { muscleGroup: 'Psoas Major', leftGrade: '3', rightGrade: '3' }
            ];
            
            initialFindings.objectiveFindings.myotome = [
                { level: 'L1', leftGrade: '4', rightGrade: '4' },
                { level: 'L2', leftGrade: '4', rightGrade: '3' },
                { level: 'L3', leftGrade: '3', rightGrade: '3' },
                { level: 'L4', leftGrade: '4', rightGrade: '4' },
                { level: 'L5', leftGrade: '3', rightGrade: '3' },
                { level: 'S1', leftGrade: '4', rightGrade: '4' }
            ];
            
            initialFindings.objectiveFindings.includeProm = true;
            initialFindings.objectiveFindings.tendernessInclude = true;
            initialFindings.objectiveFindings.tendernessArea = 'L4-L5 paraspinal muscles';
            initialFindings.objectiveFindings.swellingInclude = false;
            initialFindings.objectiveFindings.temperatureInclude = false;
            initialFindings.objectiveFindings.sensationInclude = true;
            initialFindings.objectiveFindings.sensationStatus = 'intact';
            initialFindings.objectiveFindings.walkingAid = 'unaided';
            initialFindings.objectiveFindings.walkingStability = 'fair';
            
            initialFindings.objectiveFindings.specialTests = [
                { testName: 'Straight Leg Raise', result: 'Positive at 45 bilaterally' },
                { testName: 'Slump Test', result: 'Positive' }
            ];
            
            initialFindings.objectiveFindings.questionnaires = [
                { name: 'Oswestry Disability Index', score: '68%' },
                { name: 'Roland Morris Disability Questionnaire', score: '18/24' }
            ];
            
            // Fill final findings - Back Case (showing improvement)
            var finalFindings = LiteAppState.reportData.finalFindings;
            finalFindings.date = '2024-12-10';
            finalFindings.complaints.side = '';
            finalFindings.complaints.location = 'back';
            finalFindings.complaints.painIntensity = '3';
            finalFindings.complaints.otherSymptoms = 'Mild stiffness';
            finalFindings.complaints.symptomIntensity = '2';
            finalFindings.complaints.activities1[0] = { activity: 'sitting', duration: '45', unit: 'minutes' };
            finalFindings.complaints.activities2[0] = { activity: 'walking', duration: '30', unit: 'minutes', aid: 'unaided' };
            finalFindings.complaints.overallImprovement = '8';
            
            // Objective findings - Back Case Final (improved)
            finalFindings.objectiveFindings.aromMovements = [
                { movement: 'Flexion', arom: '60', prom: '65' },
                { movement: 'Extension', arom: '25', prom: '30' },
                { movement: 'Left Lateral Flexion', arom: '35', prom: '40' },
                { movement: 'Right Lateral Flexion', arom: '33', prom: '38' },
                { movement: 'Left Rotation', arom: '40', prom: '45' },
                { movement: 'Right Rotation', arom: '38', prom: '43' }
            ];
            
            finalFindings.objectiveFindings.musclePower = [
                { muscleGroup: 'Erector Spinae', leftGrade: '4', rightGrade: '4' },
                { muscleGroup: 'Multifidus', leftGrade: '4', rightGrade: '4' },
                { muscleGroup: 'Quadratus Lumborum', leftGrade: '4', rightGrade: '4' },
                { muscleGroup: 'Psoas Major', leftGrade: '4', rightGrade: '4' }
            ];
            
            finalFindings.objectiveFindings.myotome = [
                { level: 'L1', leftGrade: '5', rightGrade: '5' },
                { level: 'L2', leftGrade: '5', rightGrade: '4' },
                { level: 'L3', leftGrade: '4', rightGrade: '4' },
                { level: 'L4', leftGrade: '5', rightGrade: '5' },
                { level: 'L5', leftGrade: '4', rightGrade: '4' },
                { level: 'S1', leftGrade: '5', rightGrade: '5' }
            ];
            
            finalFindings.objectiveFindings.includeProm = true;
            finalFindings.objectiveFindings.tendernessInclude = true;
            finalFindings.objectiveFindings.tendernessArea = 'Mild tenderness L4-L5';
            finalFindings.objectiveFindings.swellingInclude = false;
            finalFindings.objectiveFindings.temperatureInclude = false;
            finalFindings.objectiveFindings.sensationInclude = true;
            finalFindings.objectiveFindings.sensationStatus = 'intact';
            finalFindings.objectiveFindings.walkingAid = 'unaided';
            finalFindings.objectiveFindings.walkingStability = 'good';
            
            finalFindings.objectiveFindings.specialTests = [
                { testName: 'Straight Leg Raise', result: 'Negative bilaterally' },
                { testName: 'Slump Test', result: 'Negative' }
            ];
            
            finalFindings.objectiveFindings.questionnaires = [
                { name: 'Oswestry Disability Index', score: '22%' },
                { name: 'Roland Morris Disability Questionnaire', score: '6/24' }
            ];
            
            // Fill treatments - Back Case
            LiteAppState.reportData.treatments = [
                { method: 'Manual therapy', area: 'Lumbar spine' },
                { method: 'Hot pack', area: 'Lower back' },
                { method: 'Interferential electrical therapy', area: 'L4-L5 region' },
                { method: 'Strengthening exercise', area: 'Core muscles' },
                { method: 'Mobilization exercise', area: 'Lumbar spine' }
            ];
            
            LiteAppState.reportData.otherTreatment = 'Patient education on proper lifting techniques and ergonomic advice for workplace setup.';
            
            // Fill discharge summary - Back Case
            LiteAppState.reportData.dischargeSummary.componentData = {
                dischargeType: 'completed',
                dischargeDate: '2024-12-10'
            };
            
            // Fill therapist details
            LiteAppState.reportData.therapistDetails = {
                name: 'Dr. Sarah Johnson',
                title: 'Senior Physiotherapist',
                qualifications: 'BSc (Hons) Physiotherapy, MSc Musculoskeletal Physiotherapy'
            };
            
            // Update form fields and re-render
            populateAllFormFields();
            
            alert('Back Case mock data filled successfully! Patient: Lower back pain case with comprehensive clinical data.');
        }
        
        function fillHandCaseMockData() {
            if (!LiteAppState.reportData) return;

            // Fill basic information - Hand Case
            LiteAppState.reportData.ourRef = 'PT/2024/HAND001';
            LiteAppState.reportData.yourRef = 'DOC/2024/HAND001';
            LiteAppState.reportData.recipient = 'Dr. Lisa Wong';
            LiteAppState.reportData.patientName = 'Chan, Mei Ling';
            LiteAppState.reportData.patientSex = 'Female';
            LiteAppState.reportData.patientAge = '32';
            LiteAppState.reportData.hkidNo = 'B987654(3)';
            LiteAppState.reportData.physiotherapyOpdNo = 'PT789012';
            LiteAppState.reportData.diagnosis = 'Right wrist fracture post-surgical with hand stiffness';
            LiteAppState.reportData.totalSessions = '15';
            LiteAppState.reportData.attendedSessions = '14';
            LiteAppState.reportData.defaultedSessions = '1';
            LiteAppState.reportData.registrationDate = '2024-10-15';
            LiteAppState.reportData.treatmentPeriodStart = '2024-10-20';
            LiteAppState.reportData.treatmentPeriodEnd = '2024-12-15';
            LiteAppState.reportData.caseTherapists = 'Emily Chen, OT';
            LiteAppState.reportData.reportWriter = 'Dr. Emily Chen';
            LiteAppState.reportData.consentDate = '2024-10-15';
            
            // Fill referral sources
            LiteAppState.reportData.referralSources = [
                { episode: '1st', department: 'Orthopedics', hospital: 'Prince of Wales Hospital' }
            ];
            
            // Fill initial findings - Hand Case
            var initialFindings = LiteAppState.reportData.initialFindings;
            initialFindings.date = '2024-10-20';
            initialFindings.complaints.side = 'Right';
            initialFindings.complaints.location = 'hand';
            initialFindings.complaints.painIntensity = '6';
            initialFindings.complaints.otherSymptoms = 'Stiffness, swelling, weakness';
            initialFindings.complaints.symptomIntensity = '7';
            initialFindings.complaints.activities1[0] = { activity: 'writing', duration: '2', unit: 'minutes' };
            initialFindings.complaints.activities2[0] = { activity: 'gripping', duration: '1', unit: 'minutes', aid: 'unaided' };
            initialFindings.complaints.overallImprovement = '1';
            
            // Objective findings - Hand Case Initial
            initialFindings.objectiveFindings.aromMovements = [
                { movement: 'Wrist Flexion', arom: '20', prom: '30' },
                { movement: 'Wrist Extension', arom: '15', prom: '25' },
                { movement: 'Radial Deviation', arom: '10', prom: '15' },
                { movement: 'Ulnar Deviation', arom: '12', prom: '18' }
            ];
            
            initialFindings.objectiveFindings.musclePower = [
                { muscleGroup: 'Wrist Flexor', leftGrade: '5', rightGrade: '2' },
                { muscleGroup: 'Wrist Extensor', leftGrade: '5', rightGrade: '2' },
                { muscleGroup: 'Finger Flexor', leftGrade: '5', rightGrade: '3' },
                { muscleGroup: 'Finger Extensor', leftGrade: '5', rightGrade: '3' },
                { muscleGroup: 'Thumb Abductor', leftGrade: '5', rightGrade: '2' },
                { muscleGroup: 'Thumb Adductor', leftGrade: '5', rightGrade: '2' }
            ];
            
            // Hand grip strength
            initialFindings.objectiveFindings.handGripStrength = {
                leftHandGrip: '28kg',
                rightHandGrip: '8kg',
                leftPinchGrip: '6kg',
                rightPinchGrip: '2kg',
                leftLateralPinch: '7kg',
                rightLateralPinch: '2.5kg'
            };
            
            // Fingers/toes data (small joints)
            initialFindings.objectiveFindings.fingersToesData = [
                {
                    name: 'Index finger',
                    joints: [
                        { jointType: 'MCP', range: '0-45' },
                        { jointType: 'PIP', range: '0-60' },
                        { jointType: 'DIP', range: '0-30' }
                    ]
                },
                {
                    name: 'Middle finger',
                    joints: [
                        { jointType: 'MCP', range: '0-40' },
                        { jointType: 'PIP', range: '0-55' },
                        { jointType: 'DIP', range: '0-25' }
                    ]
                },
                {
                    name: 'Thumb',
                    joints: [
                        { jointType: 'CMC', range: '0-20' },
                        { jointType: 'MCP', range: '0-30' },
                        { jointType: 'IP', range: '0-40' }
                    ]
                }
            ];
            
            initialFindings.objectiveFindings.includeProm = true;
            initialFindings.objectiveFindings.tendernessInclude = true;
            initialFindings.objectiveFindings.tendernessArea = 'Wrist joint, thenar eminence';
            initialFindings.objectiveFindings.swellingInclude = true;
            initialFindings.objectiveFindings.swellingPresent = true;
            initialFindings.objectiveFindings.temperatureInclude = false;
            initialFindings.objectiveFindings.sensationInclude = true;
            initialFindings.objectiveFindings.sensationStatus = 'reduced';
            initialFindings.objectiveFindings.sensationReduction = 'Thumb and index finger';
            
            initialFindings.objectiveFindings.specialTests = [
                { testName: 'Phalen\'s Test', result: 'Negative' },
                { testName: 'Tinel\'s Sign', result: 'Positive at wrist' }
            ];
            
            initialFindings.objectiveFindings.questionnaires = [
                { name: 'DASH Score', score: '78/100' },
                { name: 'QuickDASH', score: '68/100' }
            ];
            
            // Fill final findings - Hand Case (showing improvement)
            var finalFindings = LiteAppState.reportData.finalFindings;
            finalFindings.date = '2024-12-15';
            finalFindings.complaints.side = 'Right';
            finalFindings.complaints.location = 'hand';
            finalFindings.complaints.painIntensity = '2';
            finalFindings.complaints.otherSymptoms = 'Mild stiffness';
            finalFindings.complaints.symptomIntensity = '2';
            finalFindings.complaints.activities1[0] = { activity: 'writing', duration: '20', unit: 'minutes' };
            finalFindings.complaints.activities2[0] = { activity: 'gripping', duration: '15', unit: 'minutes', aid: 'unaided' };
            finalFindings.complaints.overallImprovement = '8';
            
            // Objective findings - Hand Case Final (improved)
            finalFindings.objectiveFindings.aromMovements = [
                { movement: 'Wrist Flexion', arom: '65', prom: '70' },
                { movement: 'Wrist Extension', arom: '60', prom: '65' },
                { movement: 'Radial Deviation', arom: '18', prom: '20' },
                { movement: 'Ulnar Deviation', arom: '25', prom: '28' }
            ];
            
            finalFindings.objectiveFindings.musclePower = [
                { muscleGroup: 'Wrist Flexor', leftGrade: '5', rightGrade: '4' },
                { muscleGroup: 'Wrist Extensor', leftGrade: '5', rightGrade: '4' },
                { muscleGroup: 'Finger Flexor', leftGrade: '5', rightGrade: '4' },
                { muscleGroup: 'Finger Extensor', leftGrade: '5', rightGrade: '4' },
                { muscleGroup: 'Thumb Abductor', leftGrade: '5', rightGrade: '4' },
                { muscleGroup: 'Thumb Adductor', leftGrade: '5', rightGrade: '4' }
            ];
            
            // Hand grip strength - improved
            finalFindings.objectiveFindings.handGripStrength = {
                leftHandGrip: '28kg',
                rightHandGrip: '22kg',
                leftPinchGrip: '6kg',
                rightPinchGrip: '5kg',
                leftLateralPinch: '7kg',
                rightLateralPinch: '6kg'
            };
            
            // Fingers/toes data (small joints) - improved
            finalFindings.objectiveFindings.fingersToesData = [
                {
                    name: 'Index finger',
                    joints: [
                        { jointType: 'MCP', range: '0-85' },
                        { jointType: 'PIP', range: '0-95' },
                        { jointType: 'DIP', range: '0-70' }
                    ]
                },
                {
                    name: 'Middle finger',
                    joints: [
                        { jointType: 'MCP', range: '0-80' },
                        { jointType: 'PIP', range: '0-90' },
                        { jointType: 'DIP', range: '0-65' }
                    ]
                },
                {
                    name: 'Thumb',
                    joints: [
                        { jointType: 'CMC', range: '0-45' },
                        { jointType: 'MCP', range: '0-50' },
                        { jointType: 'IP', range: '0-75' }
                    ]
                }
            ];
            
            finalFindings.objectiveFindings.includeProm = true;
            finalFindings.objectiveFindings.tendernessInclude = true;
            finalFindings.objectiveFindings.tendernessArea = 'Minimal tenderness';
            finalFindings.objectiveFindings.swellingInclude = false;
            finalFindings.objectiveFindings.swellingPresent = false;
            finalFindings.objectiveFindings.temperatureInclude = false;
            finalFindings.objectiveFindings.sensationInclude = true;
            finalFindings.objectiveFindings.sensationStatus = 'intact';
            finalFindings.objectiveFindings.sensationReduction = '';
            
            finalFindings.objectiveFindings.specialTests = [
                { testName: 'Phalen\'s Test', result: 'Negative' },
                { testName: 'Tinel\'s Sign', result: 'Negative' }
            ];
            
            finalFindings.objectiveFindings.questionnaires = [
                { name: 'DASH Score', score: '18/100' },
                { name: 'QuickDASH', score: '15/100' }
            ];
            
            // Fill treatments - Hand Case
            LiteAppState.reportData.treatments = [
                { method: 'Manual therapy', area: 'Wrist and hand' },
                { method: 'Wax therapy', area: 'Hand and fingers' },
                { method: 'Ultrasound therapy', area: 'Wrist joint' },
                { method: 'Mobilization exercise', area: 'Finger joints' },
                { method: 'Strengthening exercise', area: 'Hand muscles' }
            ];
            
            LiteAppState.reportData.otherTreatment = 'Hand therapy exercises, splinting advice, and ergonomic modifications for computer work.';
            
            // Fill discharge summary - Hand Case
            LiteAppState.reportData.dischargeSummary.componentData = {
                dischargeType: 'completed',
                dischargeDate: '2024-12-15'
            };
            
            // Fill therapist details
            LiteAppState.reportData.therapistDetails = {
                name: 'Dr. Emily Chen',
                title: 'Senior Occupational Therapist',
                qualifications: 'BSc (Hons) Occupational Therapy, MSc Hand Therapy'
            };
            
            // Update form fields and re-render
            populateAllFormFields();
            
            alert('Hand Case mock data filled successfully! Patient: Wrist fracture post-surgical case with comprehensive clinical data.');

            // Fill initial findings
            var initialFindings = LiteAppState.reportData.initialFindings;
            initialFindings.complaints.side = 'Right';
            initialFindings.complaints.location = 'shoulder';
            initialFindings.complaints.painIntensity = '7';
            initialFindings.complaints.otherSymptoms = 'Stiffness, weakness';
            initialFindings.complaints.symptomIntensity = '6';
            initialFindings.complaints.activities1[0] = { activity: 'reading', duration: '15', unit: 'minutes' };
            initialFindings.complaints.activities2[0] = { activity: 'walking', duration: '5', unit: 'minutes', aid: 'unaided' };
            initialFindings.complaints.overallImprovement = '2';

            // Fill objective findings
            initialFindings.objectiveFindings.aromMovements = [
                { movement: 'Flexion', arom: '90', prom: '100' },
                { movement: 'Abduction', arom: '80', prom: '90' },
                { movement: 'Extension', arom: '30', prom: '40' }
            ];
            initialFindings.objectiveFindings.musclePower = [
                { muscleGroup: 'Flexor', leftGrade: '', rightGrade: '3' },
                { muscleGroup: 'Abductor', leftGrade: '', rightGrade: '3' },
                { muscleGroup: 'External Rotator', leftGrade: '', rightGrade: '2' }
            ];
            initialFindings.objectiveFindings.includeProm = true;

            // Fill treatments
            LiteAppState.reportData.treatments = [
                { method: 'Manual Therapy', area: 'Shoulder' },
                { method: 'Strengthening Exercise', area: 'Rotator Cuff' },
                { method: 'Hot Pack', area: 'Shoulder' }
            ];

            // Fill discharge summary (New structure matching full app)
            LiteAppState.reportData.dischargeSummary.componentData = {
                dischargeType: 'completed',
                dischargeDate: '2024-12-15'
            };

            // Fill therapist details
            LiteAppState.reportData.therapistDetails = {
                name: 'Dr. Sarah Johnson',
                title: 'Senior Physiotherapist',
                qualifications: 'BSc (Hons) Physiotherapy, MSc Sports Medicine'
            };

            // Update form fields
            populateAllFormFields();
            
            alert('Mock data filled successfully! All sections have been populated with sample data.');
        }

        function populateAllFormFields() {
            if (!LiteAppState.reportData) return;

            // Populate basic fields
            var fields = [
                'ourRef', 'ourRef2', 'yourRef', 'yourRefDate', 'reportDate', 'recipient',
                'patientName', 'patientSex', 'patientAge', 'hkidNo', 'physiotherapyOpdNo',
                'diagnosis', 'totalSessions', 'attendedSessions', 'defaultedSessions',
                'registrationDate', 'treatmentPeriodStart', 'treatmentPeriodEnd',
                'caseTherapists', 'reportWriter', 'referralInfo', 'otherTreatment', 'consentDate'
            ];

            for (var i = 0; i < fields.length; i++) {
                var element = document.getElementById(fields[i]);
                if (element && LiteAppState.reportData[fields[i]]) {
                    element.value = LiteAppState.reportData[fields[i]];
                }
            }

            // Populate therapist details
            var therapistNameElement = document.getElementById('therapistName');
            if (therapistNameElement) therapistNameElement.value = LiteAppState.reportData.therapistDetails.name || '';

            var therapistTitleElement = document.getElementById('therapistTitle');
            if (therapistTitleElement) therapistTitleElement.value = LiteAppState.reportData.therapistDetails.title || '';

            var therapistQualificationsElement = document.getElementById('therapistQualifications');
            if (therapistQualificationsElement) therapistQualificationsElement.value = LiteAppState.reportData.therapistDetails.qualifications || '';

            // Re-render dynamic sections
            renderReferralSources();
            renderTreatmentMethods();
            renderDischargeSummary();
            
            // Populate clinical findings
            populateFormFields('initial');
            populateFormFields('interim');
            populateFormFields('final');
        }

        // ===== DATA EXPORT =====

        function generateDataString() {
            if (!LiteAppState.reportData) {
                alert('No data to export. Please fill in some information first.');
                return;
            }

            // Generate JSON string compatible with full app
            var dataString = JSON.stringify(LiteAppState.reportData, null, 2);
            document.getElementById('exportOutput').textContent = dataString;
            
            // Show success message
            alert('Data string generated successfully! You can now copy it and paste into the full app.');
        }

        function copyDataString() {
            var output = document.getElementById('exportOutput');
            if (!output.textContent || output.textContent.trim() === 'Click "Generate Data String" to create exportable data...') {
                alert('Please generate the data string first by clicking "Generate Data String".');
                return;
            }

            var textArea = document.createElement('textarea');
            textArea.value = output.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Data string copied to clipboard! You can now paste it into the full app.');
        }

        // ===== NAVIGATION SYSTEM =====
        // (showSection function defined at top of script for early access)

        // Smart navigation to clinical findings sections
        function jumpToClinicalTab(tabName) {
            // First navigate to Section 6 (Clinical Findings)
            showSection(6);
            
            // Wait a moment for the section to show, then switch to the specific tab
            setTimeout(function() {
                showClinicalTab(tabName);
                
                // Scroll to the clinical findings section
                var clinicalSection = document.getElementById('section6');
                if (clinicalSection) {
                    clinicalSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        // (showClinicalTab function defined at top of script for early access)



        // ===== INITIALIZATION =====

        function initializeLiteApp() {
            LiteAppState.reportData = createInitialReportData();
            
            // Set default date to today
            var reportDateInput = document.getElementById('reportDate');
            if (reportDateInput) {
                reportDateInput.value = LiteAppState.reportData.reportDate;
            }
            
            // Initialize dynamic sections
            initializeReferralSources();
            initializeTreatmentMethods();
            initializeDischargeSummary();
            
            // Initialize clinical findings
            renderClinicalFindings('initial');
            renderClinicalFindings('interim');
            renderClinicalFindings('final');
            
            // Initialize mock data selector
            renderMockDataSelector();
            
            console.log('Lite App v2.1 Polished initialized successfully with smart navigation and advanced features');
        }

        // Initialize the app when page loads (ES3/ES4 compatible)
        if (window.addEventListener) {
            window.addEventListener('load', initializeLiteApp, false);
        } else if (window.attachEvent) {
            window.attachEvent('onload', initializeLiteApp);
        } else {
            window.onload = initializeLiteApp;
        }
    </script>
</body>
</html>